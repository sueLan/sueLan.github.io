<!DOCTYPE html>
<html lang="zh-CN">

  
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="author" content="RY">
  
  
  
  <title>XMPP Overview | RY &#39;s Blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="NetWork,XMPP,">
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c 🎉 https://github.com/dongyuanxin/theme-bmw 🎉\n' + '\n%c View demo online ' + '%c 🔍 https://godbmw.com/ 🔍  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  

  

  
    <link rel="icon" href="/img/favicon.ico">
    <link rel="apple-touch-icon" href="/img/favicon.ico">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">

  <script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>

  

  
    <link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js" async></script>
  

  
    <link href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css" rel="stylesheet">
  
  
  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>
  
  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
  

</head>

  <body>

    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">RY</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a 
              href="/"
              target="_self"
            >
              Home
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a 
              href="/archives/"
              target="_self"
            >
              Archives
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a 
              href="/categories/"
              target="_self"
            >
              Categories
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a 
              href="/tags/"
              target="_self"
            >
              Tags
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/about/">
          
            <a 
              href="/about/"
              target="_self"
            >
              About
            </a>
          
        </li>
      
        <li class="nav-item" data-path="">
          
            <a href="javascript:void(0);" v-else>Me</a>
            <ul class="nav-menu--dropdown">
              
                <li>
                  <a 
                    href="https://github.com/sueLan" 
                    target="_blank"
                  >
                    Github
                  </a>
                </li>
              
                <li>
                  <a 
                    href="https://www.linkedin.com/in/rongyanzheng/" 
                    target="_blank"
                  >
                    Linkedin
                  </a>
                </li>
              
                <li>
                  <a 
                    href="https://www.jianshu.com/u/23bd8d4cc8bf" 
                    target="_blank"
                  >
                    Jian Shu
                  </a>
                </li>
              
                <li>
                  <a 
                    href="https://yq.aliyun.com/users/gi7dnrwlx2mya" 
                    target="_blank"
                  >
                    Ali yun
                  </a>
                </li>
              
            </ul>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>XMPP Overview</span>
  </h1>
  <div class="article-top-meta">
    <span>
      post ime : 
      2019-03-26
    </span>
    
      <span>
        category : 
          <a href="/categories/NetWork/">
            NetWork
          </a>
      </span>
    
    
      <span>
        read : <span class="article-timer" data-identity="XMPP-Overview"></span>
      </span>
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <p>跟朋友做一个项目，想快速开发，选了XMPP协议。它是一套通信协议。分为两部分，<a href="https://xmpp.org/rfcs/rfc6121.html#A%20Sample%20Session" target="_blank" rel="noopener">XMPP Core Services</a> 和 XMPP Extension Protocols. 核心由基础feature组成，扩展协议就非常丰富，而且一直在发展。Wiki上有张各种IM协议的汇总表，推荐！</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Comparison_of_instant_messaging_protocols" target="_blank" rel="noopener">Comparison of instant messaging protocols - Wikipedia</a></li>
</ul>
<h2 id="XMPP-Addressing"><a href="#XMPP-Addressing" class="headerlink" title="XMPP Addressing"></a>XMPP Addressing</h2><p>这是一张Client-Server的图，图里的server、client都遵循XMPP协议。叫 XMPP entity. 它们有各自唯一的Address, 格式如<a href="mailto:&#39;username@server.com" target="_blank" rel="noopener">&#39;username@server.com</a>‘, 叫 JID (Jaber ID)<br> <a href="https://datatracker.ietf.org/doc/rfc7622/" target="_blank" rel="noopener">RFC 7622 - Extensible Messaging and Presence Protocol (XMPP): Address Format</a></p>
<p> <img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/28a215f7.png" alt="28a215f7.png"></p>
<p>其中resource是拿来做同一账号多客户端标记的， 比如图中<code>User1</code> 从 pc ,phone1 和 phone2登录同一账号，resource分别是 <code>pc</code>, <code>iphone1</code>,<code>iphone2</code></p>
<h2 id="XMPP-Client-Server-Streams"><a href="#XMPP-Client-Server-Streams" class="headerlink" title="XMPP Client- Server Streams"></a>XMPP Client- Server Streams</h2><p> 客户端与服务端通过长链接方式通信，现在多用WebSocket。当客户端跟服务端握手成功，它们开始用 XML stream通信。</p>
<p> <img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/f1565a2e.png" alt="f1565a2e.png">\</p>
<p>XML stream 总是以  <code>&lt;stream&gt;</code> 开头， <code>&lt;/stream&gt;</code> tag结尾。是xml消息的容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">An XML stream is a container for the exchange of XML elements between any two entities over a network. </span><br><span class="line">During the life of the stream, the entity that initiated it can send an unbounded number of XML elements over the stream, either elements used to negotiate the stream (e.g., to complete TLS negotiation or SASL negotiation) or XML stanzas.</span><br></pre></td></tr></table></figure>
<p>下面是client跟server的一次消息交互， 绿色来自client的，黑色消息来自server</p>
<p>  <img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/65d38868.png" alt="f97e583b.png"></p>
<h3 id="XML-stanza"><a href="#XML-stanza" class="headerlink" title="XML stanza"></a>XML stanza</h3><p> An XML stanza is the basic unit of meaning in XMPP. A stanza is a first-level element (at depth=1 of the stream) whose element name is “message”, “presence”, or “iq” and whose qualifying namespace is ‘jabber:client’ or ‘jabber:server’. </p>
<h3 id="XMPP-Communication-Primitives"><a href="#XMPP-Communication-Primitives" class="headerlink" title="XMPP Communication Primitives"></a>XMPP Communication Primitives</h3><p>A <code>stanza</code> is the smallest piece of XML data a client can send to a server ( server send to client) in one package.</p>
<p>xmpp中，服务端、客户数据交换时，最小XML数据单位 叫 stanza。如上图，绿色的就是一个stanza，黑色的也是一个stanza。Stanza有几种类型: <code>message</code>, <code>iq</code>, <code>presence</code>。 </p>
<h4 id="The-Message-Stanza"><a href="#The-Message-Stanza" class="headerlink" title="The Message Stanza"></a>The Message Stanza</h4><p>The <message> stanza is meant to be used to send data between XMPP entities.</message></p>
<p><img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/6fe8a15e.png" alt="6fe8a15e.png"></p>
<ul>
<li>from：发送方</li>
<li>to： 接收方</li>
<li>body: 消息内容</li>
<li>type 有几种类型:<br>  -<code>&lt;message type=”chat”/&gt;</code> ( chat message stanza) <ul>
<li><code>&lt; message type=”groupchat”/&gt;</code> ( groupchat message stanza)</li>
<li><code>&lt; message type=”error”/&gt;</code> (error message stanza)</li>
</ul>
</li>
</ul>
<h4 id="The-Presence-Stanza"><a href="#The-Presence-Stanza" class="headerlink" title="The Presence Stanza"></a>The Presence Stanza</h4><p>用来表示在线状态的</p>
<p><img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/0fbe995b.png" alt="0fbe995b.png"></p>
<p><code>show</code> 标签里可能会有的几种状态:<br><code>chat</code> : online and available for chat ;<br><code>away</code> : 暂时离开<br><code>xa</code> : 长时间离开<br><code>dnd</code>: 请勿打扰</p>
<p>如果你想知道别的状态，需要先发消息给Server，subscribe别人。 </p>
<h4 id="The-IQ-stanza"><a href="#The-IQ-stanza" class="headerlink" title="The IQ stanza"></a>The IQ stanza</h4><p> The IQ( Info/Query) stanza is used to get some information from the server ( info about the server or its registered clients) or to apply some settings to the server.</p>
<p> 用来获取消息，或者请求设置</p>
<p>Type属性中的类型 :get ,set ,result or error. </p>
<ul>
<li><code>&lt; iq type=”get”/&gt;</code> stanzas are used to get(ask) some information ( from the server). </li>
<li><code>&lt;iq type=”set”/&gt;</code> stanzas are used to apply some settings to the server.When you send get/set IQ stanzas to the server ,</li>
<li>it can reply either with an <code>&lt; iq type=”result”/&gt;</code> stanza when your request has been successfully processed by the server or </li>
<li><code>&lt;iq type=”error”/&gt;</code> stanza when something has gone wrong with your request.The figure below shows an IQ stanza that we send to the server and the reply we get from the server.</li>
</ul>
<p><img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/30c96f66.png" alt="30c96f66.png"></p>
<p>The client sends an IQ get stanza to the server to request its contact list.We know it is asking for the contact list because of the <code>jabber:iq:roster</code> XML namespace.</p>
<p>The XMPP engine in the server is programmed to know that when a client sends <code>jabber:iq:roster</code> namespaced IQ ,it wants to retrieve its contact list.There are other <code>namespaces</code> in XMPP for other uses and you will surely come accross them in your XMPPing journey.</p>
<p>The server responds with a list of the JID’s contacts wraped within a <code>jabber:iq:roster</code> namespaced <code>&lt;query/&gt;</code>tag.</p>
<h2 id="本地搭建-Server"><a href="#本地搭建-Server" class="headerlink" title="本地搭建 Server"></a>本地搭建 Server</h2><p>我搭的是ejabberd. 官方安装教程: <a href="https://docs.ejabberd.im/admin/installation/#install-on-macos" target="_blank" rel="noopener">Installing ejabberd | ejabberd Docs</a></p>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /Applications/ejabberd-19.02</span><br><span class="line">//开启服务</span><br><span class="line">./bin/ejabberdctl start  </span><br><span class="line">//状态</span><br><span class="line">./bin/ejabberdctl status  </span><br><span class="line"></span><br><span class="line">// help 查看更多功能哦</span><br><span class="line">./bin/ejabberdctl help</span><br></pre></td></tr></table></figure>
<h4 id="注册账户"><a href="#注册账户" class="headerlink" title="注册账户"></a>注册账户</h4><p>打开 <a href="http://localhost:5280/admin/" target="_blank" rel="noopener">admin 页面</a>, 虚拟主机 -&gt; localhost(可能你的名字不一样) -&gt; 用户。 现在你可以自己创建账户了。</p>
<p><img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/578b88b6.png" alt="578b88b6.png"></p>
<p>如果有自定义需求,配置教程 <a href="https://docs.ejabberd.im/admin/configuration/#mod-http-ws" target="_blank" rel="noopener">Configuring ejabberd | ejabberd Docs</a> </p>
<h4 id="客户端玩起来"><a href="#客户端玩起来" class="headerlink" title="客户端玩起来"></a>客户端玩起来</h4><p>客户端有很多<a href="https://xmpp.org/software/clients.html" target="_blank" rel="noopener">选择</a>，不过大多数都是渣。如果是WebSocket，用这个 <a href="https://github.com/processone/xmpp-websocket-client" target="_blank" rel="noopener">GitHub - processone/xmpp-websocket-client: Test XMPP Websocket client</a> 调试可以看到stanza，挺方便的。</p>
<p>如果Mac用户报auth问题，可以打开<code>vim conf/ejabberd.yml</code>, <code>tls</code>配置成<code>false</code><br><img src="/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/5202ee46.png" alt="5202ee46.png"></p>
<h4 id="关于js-lib"><a href="#关于js-lib" class="headerlink" title="关于js lib"></a>关于js lib</h4><p>打算用React Native写，lib选了 <a href="https://github.com/xmppjs/xmpp.js" target="_blank" rel="noopener">GitHub - xmppjs/xmpp.js: XMPP for JavaScript</a> 。当然 Web多用框架 Strophe.js。这儿有个简单比较<a href="https://github.com/xmppjs/xmpp.js/issues/217" target="_blank" rel="noopener">How do you compare to strophe.js · Issue #217 · xmppjs/xmpp.js · GitHub</a></p>
<h3 id="其他资料"><a href="#其他资料" class="headerlink" title="其他资料"></a>其他资料</h3><ul>
<li><p>简单介绍 <a href="https://www.blikoontech.com/xmpp/xmpp-a-soft-friendly-introduction" target="_blank" rel="noopener">A friendly introduction to XMPP – blikoon</a></p>
</li>
<li><p>官方协议很详细，例子也很形象。 <a href="https://xmpp.org/rfcs/rfc6120.html#tls" target="_blank" rel="noopener">Extensible Messaging and Presence Protocol (XMPP): Core</a></p>
</li>
<li><p>如何选择即时通讯应用的数据传输格式 <a href="http://www.52im.net/thread-276-1-1.html" target="_blank" rel="noopener">如何选择即时通讯应用的数据传输格式-其它分享/专项技术区 - 即时通讯开发者社区!</a></p>
</li>
<li>强列建议将Protobuf作为你的即时通讯应用数据传输格式 <a href="http://www.52im.net/thread-277-1-1.html" target="_blank" rel="noopener">强列建议将Protobuf作为你的即时通讯应用数据传输格式-其它分享/专项技术区 - 即时通讯开发者社区!</a> </li>
</ul>

    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          Author : RY Zheng <br/>
        
        Link : <a href="">https://suelan.github.io/2019/03/26/XMPP-Overview/</a><br>
        License : MIT
        </blockquote>
      </div>
    </div>
  
  
  
    <div class="social-share"
  style="margin-top: -2rem"
  data-wechat-qrcode-title="<p>微信扫一扫</p>"
  data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>"
   data-sites="qzone, qq, weibo, wechat, douban, google, facebook, twitter" 
  
>
  <span style="color: #6b7487; font-size: 1.4rem;">Share To: </span>
</div>
<script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" async>
  

  
    <div id="reward">
  
    <p id="reward-meta">The best way out is going througn</p>
  
  <button id="reward-btn">
    
    <span>赞赏 ☕️</span>
  </button>
  <div id="reward-qrcode">
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/img/donate.jpeg" alt="感谢鼓励">
        <p class="qrcode-meta">感谢鼓励</p>
      </div>
    
  </div>

</div>

<script>
  (() => {
    let button = document.querySelector('#reward-btn'),
      qrcode = document.querySelector('#reward-qrcode'),
      display = false;
    
    button.addEventListener('click', () => {
      qrcode.style.display = display ? 'none' : 'block'
      display = !display
    }, false)
  })()
</script>
  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>标签: 
          
          <span class="span--tag">
            <a href="/tags/XMPP/">
              #XMPP
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
    
      <div class="nav-next">
        Nex Article:
        <a href="/2019/03/29/XMPP-2-注册账户/" target="_self">XMPP(2):注册账户</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

  
    <a href="#comment" class="comment-anchor"></a>
<div class="comment-title"><i class="iconfont icon-footprint"></i> Comments Here <i class="iconfont icon-footprint"></i></div>
<div id="vcomments"></div>

<script defer>
  if( true ) {
    let path = getRealPath()
    new Valine({
      el: "#vcomments",
      appId: "pyVXg5NFiE5JcCDYwumMNjlB-gzGzoHsz",
      appKey: "W9uovU160HsQkI3hQwlHgBqa",
      notify: false,
      verify: false,
      avatar: "robohash",
      placeholder: "Please fill in the correct email address for my response. ♪(^∇^*)",
      path
    });
  }
</script>
   

  
    <script defer>
const valineAPI = (() => {
  try {
    AV.init("pyVXg5NFiE5JcCDYwumMNjlB-gzGzoHsz", "W9uovU160HsQkI3hQwlHgBqa");
  } catch(error) {}
  const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
      query.equalTo("identity", identity);
      query.find().then(results => {
        resolve(results.length > 0);
      }, error => reject(error));
    })
  }

  const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
      let querys = [];
      for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
      }
      query = AV.Query.or.apply(null ,querys);
    } else {
      identity = identity || getRealPath();
      query = new AV.Query("Timer");
      query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
      query.find()
      .then(results => resolve(results))
      .catch(error => reject(error))
    })
  }

  const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let Todo = AV.Object.extend('Timer');
      let todo = new Todo();
      todo.set("times", 1);
      todo.set("identity", identity);
      todo.save().then(res => resolve(true), error => reject(error));
    })
  }

  const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let query = new AV.Query('Timer');
      query.equalTo("identity", identity);
      query.find().then(todos => {
        todos.forEach(todo => {
          todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
      }).then(todos => resolve(true), error => reject(error));
    })
  }

  return {
    isExist,
    _get,
    update,
    create
  }
})()

const calcAndWriteTimes = () => {
  let isPost = true;

  let timerAllDOM = document.querySelectorAll(".article-timer");

  if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
      if(exist) {
        return valineAPI.update(identity);
      }
      return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
  }

  let timerDOMCache = {};

  for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
      timerDOMCache[identity].dom.push(timerDOM);
    }else{
      timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
      };
    }
  }

  let identities = Object.keys(timerDOMCache);
  valineAPI._get(identities).then(results => {
    for(let result of results) {
      let {identity, times} = result.attributes;
      timerDOMCache[identity].times = times;
      timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
      if(timerDOMCache[identity].times){
        continue;
      }
      timerDOMCache[identity].dom.map(item => item.innerText = 1);
      valineAPI.create(identity);
    }
  }).catch(error => console.log(error.message))
}

if(true){
  calcAndWriteTimes();
}
</script>
   

</div>


      <footer>
  <p class="site-info">
    博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span>
    <br>
    Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by <a href="https://godbmw.com/">GodBMW</a>
    <br>
    
      The best way out is always through
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2019, 2, 10).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "天" + hour + "小时" + minute + "分钟" + second + "秒";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  (() => {
    const mathjaxConfig = {
      showProcessingMessages: false, //关闭js加载过程信息
      messageStyle: "none", //不显示信息
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
        displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
      },
      "HTML-CSS": {
        availableFonts: ["STIX", "TeX"], //可选字体
        showMathMenu: false //关闭右击菜单显示
      }
    }

    let mathjaxInterval = setInterval(() => {
      if(!window.MathJax){
        return;
      }
      window.MathJax.Hub.Config(mathjaxConfig)
      window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('app')])

      clearInterval(mathjaxInterval)
    }, 10)    
  })()
</script>
    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
