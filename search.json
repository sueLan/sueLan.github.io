[{"url":"/2020/12/25/React-Native-ExpoKit-Notification/boostnote/","content":"{\n  \"folders\": [],\n  \"version\": \"1.0\"\n}\n"},{"title":"How Image Loader and Cache work in React Native","url":"/2020/12/24/20201224-How-Image-Loader-and-Cache-work-in-React-Native/","content":"\n In react native, it is so intuitive to display different types of images. The [Image Component](https://reactnative.dev/docs/image) can display network images, static resources, temporary local images, and images from local disk. \n\n```jsx\n<Image style={styles.footerLastestImage} source={{ uri: latestImage }} />\n```\n\nHowever, there are actually lots of stories behind this simple line of code.\nToday, I would like to explore image loader and image cache in react native, and talk something about how they work under the hood.\n\n## Overview of React/Image module\n\nLet me begin with an activity diagram about **React/Image** module.\n\n![](ActivityReactNative.jpg)\n\nThere are several classes playing important roles in image render and cache in react native. **RCTImageView** is the iOS native implementation for **Image component**. It inherits `RCTView` and hold a `UIImageView` to render the image. `RCTImageView` is created by `RCTUIManager`. The `UIImageView` size comes from the style prop in `Image` component in JavaScript side or calculated by `Yoga`. When setting property for Image component in RN or other events triggering the image loading, `RCTImageView` calls `RCTImageLoader` to get the cached image or download image. `RCTImageLoader` is the controller for the workflow of image downloading, decoding. It depends on `RCTNetwork` to fetch the image remotely.  Before trying to download an image, `RCTImageLoader` will try to check [if there is cached image](https://github.com/facebook/react-native/blob/1ee406b9ccbecc52dff3e77d65c6d9b4837e6dab/Libraries/Image/RCTImageLoader.mm#L606) and to reuse the cached image. So here comes `RCTImageCache`, which is for Image Cache in react native iOS. \n\n## **RCTImageCache**\n\nFirst of all, keep in mind that **RCTImageCache** uses [NSCache](https://developer.apple.com/documentation/foundation/nscache) to cache images. `NSCache` object used `RCTImageCache` has only [20MB](https://github.com/facebook/react-native/blob/00456211e591930f28a08356141fc8bec52fe3e5/Libraries/Image/RCTImageCache.m#L41) cache capacity in React Native iOS.\n\n### How images added into NSCache? \n\n#### 1. expiration time \n\nAfter successfully downloading the images, **RCTImageLoader** decodes the image using [decodeImageData:size:scale:clipped:resizeMode:completionBlock](https://github.com/facebook/react-native/blob/9500eb8867d25896b1611903a64fac8d81984bf6/Libraries/Image/RCTImageLoader.mm#L935), then it [adds the decoded image to cache](https://github.com/facebook/react-native/blob/00456211e591930f28a08356141fc8bec52fe3e5/Libraries/Image/RCTImageLoader.mm#L806). In this step, it extracts the **expiration time** from the Http Response header. See more in the diagram to see how it get the expire time. The **max-age** is the top priority to decide expiration time for an image here. \n\n<img src=\"stale_time.png\" style=\"zoom:50%;\" />\n\n#### 2. The cost of image in NSCache\n\nAnother key point is that **RCTImageCache** uses [`setObject:forKey:cost:` API](https://developer.apple.com/documentation/foundation/nscache/1416399-setobject?language=objc). \n\n> The `cost` value is used to compute a sum encompassing the costs of all the objects in the cache. When memory is limited or when the total cost of the cache eclipses the maximum allowed total cost, the cache could begin an eviction process to remove some of its elements.\n\n#### 3. using Bitmap size as cost\n\n```Objective-c\n\nstatic const NSUInteger RCTMaxCachableDecodedImageSizeInBytes = 2097152; // 2 MB\n\n- (void)addImageToCache:(UIImage *)image\n                 forKey:(NSString *)cacheKey\n{\n  if (!image) {\n    return;\n  }\n  // calculate the bitmap size \n  NSInteger bytes = image.reactDecodedImageBytes;\n  // checks if the size of the decoded image bigger than 2MB. Any decoded image occupying more than 2MB memory won't be added into **NSCache**.  \n  if (bytes <= RCTMaxCachableDecodedImageSizeInBytes) {\n    [self->_decodedImageCache setObject:image\n                                 forKey:cacheKey\n                                   cost:bytes];\n  }\n}\n```\n\n\nBefore adding an image into the **NSCache**. **RCTImageCache** firstly calculate the bitmap size using the following formula\n\n```objective-c\nstatic NSInteger RCTImageBytesForImage(UIImage *image)\n{\n  NSInteger singleImageBytes = image.size.width * image.size.height * image.scale * image.scale * 4;\n  return image.images ? image.images.count * singleImageBytes : singleImageBytes;\n}\n```\n\nFor a `RGBA` format image, each pixel needs 4 bytes to represent the RGBA value, which contains 4 channels. We know that the value for each channel varies from 0 to 255.  So we need 8 bits, or 1 bytes to store it.\n\n```\nA   R   G   B   A   R   G   B   A   R   G   B  \n| pixel 0       | pixel 1       | pixel 2  \n0  233  2  100  4  155 255  7   8   9   10  11\n```\n\nBeside, Image.scale is the scale factor. Multiplying the logical size of the image (stored in the size property) by value, you get the dimensions of the image in pixels. So for the `310*165` `UIImage` object, it totally uses `310*scale*165*scale*4` pixels. \n\nAn important point here is that the **reactDecodedImageBytes** isn't always equal to the true bitmap size in memory after decoding images. Because **RCTImageLoader** will take the size and the resize mode of the **UIImageView** into consideration. [Source code here.](https://github.com/facebook/react-native/blob/00456211e591930f28a08356141fc8bec52fe3e5/Libraries/Image/RCTImageUtils.m#L256). When decoding, it downscale the downloaded image and display the downsized image to fit the image view size. This means `reactDecodedImageBytes` used as image cost in NSCache could be bigger than the actual size of finally displaying image. \n\nSo briefly speaking, for each image added into the `NSCache`, its cost is the bitmap size instead of the file size. `JPG` or `PNG` is kind of compressed format, which has much smaller size. Remember `NSCache` has `20MB` **totalCostLimit** in react native. In addition, bitmap size is much bigger than file size. It is so easy to exceed the totalCostLimit for `NSCache`, and then to trigger the eviction process to remove some of the images. \n\n#### 4. The unknown storage and eviction policy in NSCache \n\nIn the official doc  [NSCache](https://developer.apple.com/documentation/foundation/nscache) , it says `NSCache` is to temporarily store transient key-value pairs, and doesn't mention whether it uses `disk cache` or not. I added a log to see if it get `image` from the `NSCache` when launching my App without `network`. It does get a few cached images. So far, I think we can say that `NSCache` does have `disk cache` , but the proportion of disk cache is so small that we got a few cached images and the hit rate doesn't improve a lot even when I improve the `totalCostLimit` of NSCache. \n\nSo if your react native app is kind of image-heavy app. Sometimes, when you are in the scroll view full of displaying images. When you scroll down, then scroll back, you can see it fetching and decoding images, even if some of them were rendered just now but moved out of the screen later. Because in this case, the `NSCache` uses up its cache capacity and keep evicting images. Moreover, this eviction process isn't in a guaranteed order. Seems it doesn't simply apply `LRU` policy here. \n\n\n### How to get images from cache\n\nThe method to get images from `NSCache` looks relatively simple. [ imageForUrl:size:scale:resizeMode](https://github.com/facebook/react-native/blob/00456211e591930f28a08356141fc8bec52fe3e5/Libraries/Image/RCTImageCache.m#L79). \n\n1. get the key for cached image by using **url, size, scale, resizeMode.** As long as these 4 factors not changed next time, the key for the cached image won't be changed, and you can reuse this image\n2. check if the cached image is expired. If it is, remove the image from the cache. \n\n### How to replace RCTImageCache with your own cache implementation\n\nLet your own cache implementation conform `RCTImageCache` protocol. And then `setImageCache` in `RCTImageLoader`.\n\n```Objective-c\n/**\n * Allows developers to set their own caching implementation for\n * decoded images as long as it conforms to the RCTImageCache\n * protocol. This method should be called in bridgeDidInitializeModule.\n */\n- (void)setImageCache:(id<RCTImageCache>)cache;\n```\n\n\n## Concurrent Loading and Decoding Tasks \n\n`RCTImageLoader` maintains queues to schedule image loading and decoding tasks.  The following property controls the number of concurrent tasks for image loading and decoding. \n\n```objective-c\n/**\n * The maximum number of concurrent image loading tasks. Loading and decoding\n * images can consume a lot of memory, so setting this to a higher value may\n * cause memory to spike. If you are seeing out-of-memory crashes, try reducing\n * this value.\n */\n@property (nonatomic, assign) NSUInteger maxConcurrentLoadingTasks;\n\n/**\n * The maximum number of concurrent image decoding tasks. Decoding large\n * images can be especially CPU and memory intensive, so if your are decoding a\n * lot of large images in your app, you may wish to adjust this value.\n */\n@property (nonatomic, assign) NSUInteger maxConcurrentDecodingTasks;\n\n/**\n * Decoding large images can use a lot of memory, and potentially cause the app\n * to crash. This value allows you to throttle the amount of memory used by the\n * decoder independently of the number of concurrent threads. This means you can\n * still decode a lot of small images in parallel, without allowing the decoder\n * to try to decompress multiple huge images at once. Note that this value is\n * only a hint, and not an indicator of the total memory used by the app.\n */\n@property (nonatomic, assign) NSUInteger maxConcurrentDecodingBytes;\n```\n\n\n","tags":["Dive into React Native"],"categories":["iOS","React Native"]},{"title":"What is behind react native module","url":"/2020/12/23/20201223-what-is-behind-react-native-module/","content":"\n[Native Modules](https://reactnative.dev/docs/native-modules-ios) is one of the key part of React Native which enables JavasScript to call methods in iOS or Android native implementation.\n\n It is quite interesting to explore the source code about native modules in react native repo. In this article, I would like to talk something about how React Native register, initialize native modules and what is behind the method calling from JavaScript side to iOS Objective-C modules. \n\nFirst of all, let's take look at [RCTBridgeModule`](https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTBridgeModule.h#L63) , which is a protocol provides interface needed to register a bridge module.   \n\n```objective-c\n#define RCT_EXPORT_MODULE(js_name)  \n#define RCT_EXPORT_METHOD(method)\n+ (NSString *)moduleName;\n\n@optional\n+ (BOOL)requiresMainQueueSetup;\n```\n\n## Export and Register Modules\n\n`RCT_EXPORT_MODULE` is in `RCTBridgeModule` protocol, You can use this macro to export your iOS module. \n\n> Place this macro in your class implementation to automatically register your module with the bridge when it loads. The optional js_name argument. It will be used as the JS module name. If omitted, the JS module name will match the Objective-C class name.\n\nFor example, `RCT_EXPORT_MODULE` is used in [RNCAsyncStorage.m#L404, react-native-async-storage](https://github.com/react-native-async-storage/async-storage/blob/bfd76c7508bcc35d88f6b6c8d2fd525466f77ba0/ios/RNCAsyncStorage.m#L404).\n\nThis macro will be replaced by the following code in the preprocessor phase when you are compiling a source file. \n\n```objective-c\nRCT_EXTERN void RCTRegisterModule(Class); \n+ (NSString *)moduleName { return @#js_name; } \n+ (void)load { RCTRegisterModule(self); }\n```\n\nIn Objc world, `load` method is invoked whenever a class is added to the Objective-C runtime at the very beginning of app launch. At this time, it invokes `RCTRegisterModule` function to add the class object into the  `RCTModuleClasses` array. `RCTModuleClasses` is an array containing a list of registered classes.\n\n```objective-c\nvoid RCTRegisterModule(Class moduleClass)\n{\n  static dispatch_once_t onceToken;\n  dispatch_once(&onceToken, ^{\n    RCTModuleClasses = [NSMutableArray new];\n    RCTModuleClassesSyncQueue =\n        dispatch_queue_create(\"com.facebook.react.ModuleClassesSyncQueue\", DISPATCH_QUEUE_CONCURRENT);\n  });\n\n  RCTAssert(\n      [moduleClass conformsToProtocol:@protocol(RCTBridgeModule)],\n      @\"%@ does not conform to the RCTBridgeModule protocol\",\n      moduleClass);\n\n  // Register module\n  dispatch_barrier_async(RCTModuleClassesSyncQueue, ^{\n    [RCTModuleClasses addObject:moduleClass];\n  });\n}\n```\n\nWhen adding current module class into `RCTModuleClasses` array,  it uses `dispatch_barrier_async`  to dispatch this task to a concurrent queue, `RCTModuleClassesSyncQueue`. Using  `dispatch_barrier_async` makes sure that \none async block executing at a time in `RCTModuleClassesSyncQueue`. \n\nAs we mentioned just now,  `RCTModuleClasses` is a global array containing a list of registered classes.\n\n```\nPrinting description of RCTModuleClasses:\n<__NSArrayM 0x7fe4dc5d6bb0>(\n....\nRNSVGTSpanManager,\nRNSVGUseManager,\nRCTBaseTextViewManager,\nRCTTextViewManager,\nRNLinearTextGradientViewManager,\nRCTVirtualTextViewManager,\nRNVirtualLinearTextGradientViewManager,\nRCTAccessibilityManager,\nRCTActionSheetManager,\nRCTActivityIndicatorViewManager,\nRCTAlertManager,\n.....\n)\n```\n\n## Register and Initialize Modules \n\n1. **Modules in `RCTModuleClasses` are registered and initialized in [start](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L364)  phase in `RCTCxxBridge.mm`**.  In [initializeModules:withDispatchGroup:lazilyDiscovered](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L854), react native firstly registers all these `automatically-exported` modules.[code here](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L854); then store them  into array `_moduleClassesByID`, a bunch of pointers to `Class` objects, and `_moduleDataByID` referring to a bunch of `RCTModuleData` object. [code here](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L727). The back trace for module registering is as follow: \n\n  ![image-20201001142132537](image-20201001142132537.png)\n\n2. **If the module needs to be set up in `main` thread. It will be guaranteed running in Main thread**. [code here](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L877) and [here](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L935).  It makes sense that [react native doc](https://reactnative.dev/docs/native-modules-ios#implementing--requiresmainqueuesetup) suggests us return `NO` in the `requiresMainQueueSetup` method.\n  \n> If your module does not require access to UIKit, then you should respond to `+ requiresMainQueueSetup` with `NO`.\n\n3. When the `RNBridge` is initialized. It inits the `RCTCxxBridge` and `starts` it as current bridge.`RNBridge` in Objc realm basically is a wrapper of `RCTCxxBridge.mm`. At that time, RN [registers extra modules](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L738). \n\nJust as what  [*Lorenzo S.*](https://medium.com/u/b25eae7ad28?source=post_page-----9bb82659792c--------------------------------) shared in this  [talk](https://www.youtube.com/watch?v=7gm0owyO8HU) . The initialization of all modules in `RCTCxxBridge` start phase slows down its launch time. The more native module you have, the longer time it takes to initialize these modules even you won't use them on the first page. \n\n\n## Store modules\n\nIn the registration phase, in [`[RCTCXXBridge  _registerModulesForClasses:lazilyDiscovered:]`](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L681) , react native stores a list of registered classes into  a dictionary `_moduleDataByName`. The key is the `moduleName`, the value is the `RCTModuleData`. \n\n```\n  NSMutableDictionary<NSString *, RCTModuleData *> *_moduleDataByName;\n```\n\nRemember, in registering phase, The classes of modules ` are stored in `_moduleClassesByID`. While, `_moduleDataByID` stores `RCTModuleData`.\n\n```\n  // Native modules\n  NSMutableArray<RCTModuleData *> *_moduleDataByID;\n  NSMutableArray<Class> *_moduleClassesByID;\n```\n\n### RCTModuleData\n\nNow, you may wondering what is `RCTModuleData`? While, it is just the data structure to hold data for react native module. \n\n![image-20201215174307790](image-20201215174307790.png)\n\n`RCTBridgeModuleProvider` in `RCTModuleData` is for initializing an `instance` of `RCTBridgeModule`. Then, `RCTModuleData` retain this `instance`.  In initialization phase, `RCTModuleData`  creates an instance for the `module class`  by `RCTBridgeModuleProvider` . What `RCTBridgeModuleProvider` does is to provide an instance using`[moduleClass new]`.  [Code ref](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/Base/RCTModuleData.mm#L104).\n\n\n```objective-c\n- (instancetype)initWithModuleClass:(Class)moduleClass\n                             bridge:(RCTBridge *)bridge\n{\n  return [self initWithModuleClass:moduleClass\n                    moduleProvider:^id<RCTBridgeModule>{ return [moduleClass new]; }\n                            bridge:bridge];\n}\n```\n\n### Get Module by name or class \n\n`RCTBridge` bridge is a simple wrapper for the `RCTCxxBridge` , to make the methods in `RCTCxxBridge.mm` available for other Objective-C objects.  You can access to these two methods to get the module from Objective-C objects. \n\n```objc\n// RCTBridge \n- (id)moduleForName:(NSString *)moduleName\n- (id)moduleForClass:(Class)moduleClass\n```\n\nThey will look up the `_moduleDataByName` dictionary to find out the target  `RCTModuleData` and get its `instance`. [Source code here](https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L529)\n\n## Module-related Class\n\nYou might be interested in the relationship between these classes.  \n\n![](module_diagram.png)\n\n## [RCTNativeModule](https://github.com/facebook/react-native/blob/master/React/CxxModule/RCTNativeModule.mm) and ModuleRegistry\n\nIn `RCTNativeModule.mm`, `RCTNativeModule`, this c++ class inherits from the base class, `NativeModule`, which holds the info for modules.\nThe constructor method in `RCTNativeModule` takes in two parameters, `RCTBridge` object and `RCTModuleData` object. \n\n### Invoke method in RCTNativeModule\n\nThe `invoke` method in `RCTNativeModule` \n\n1. firstly get the `methodName` by `methodId`\n\n2. get the execution queue for current module \n\n3. construct a block, which calls [`invokeInner`](https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L135). `invokeInner` [calls](https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L181)  [`invokeWithBridge:module:arguments:`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519) in the `RCTModuleMethod.mm`.\n\n   ```c++\n     invokeInner(weakBridge, weakModuleData, methodId, std::move(params), callId, isSyncModule ? Sync : Async);\n   ```\n\n![image-20201029152216662](image-20201029152216662.png)\n\n4. if current module is executed in `JSThread`, then block for invoking the method is executed synchronously. But if methods in current module should be executed in other threads, react native will dispatch the previous block into the related queue. \n\n ```c++\n   dispatch_queue_t queue = m_moduleData.methodQueue;\n   const bool isSyncModule = queue == RCTJSThread;\n   if (isSyncModule) {\n     block();\n     BridgeNativeModulePerfLogger::syncMethodCallReturnConversionEnd(moduleName, methodName);\n   } else if (queue) {\n     BridgeNativeModulePerfLogger::asyncMethodCallDispatch(moduleName, methodName);\n     dispatch_async(queue, block);\n   }\n ```\n\n### NativeModuleProxy \n\n- In the Runtime initialization phase, `RCTxxBridge.start->Instance.initializeBridge->NativeToJSBridge.initializeRuntime->JSIExecutor.initializeRuntime`,\n\n an `NativeModuleProxy` object is created and set as `nativeModuleProxy` property to the `global` object in JavaScript runtime context. \n\n```c++\nvoid JSIExecutor::initializeRuntime() {\n ...\n  runtime_->global().setProperty(\n      *runtime_,\n      \"nativeModuleProxy\",\n      Object::createFromHostObject(\n          *runtime_, std::make_shared<NativeModuleProxy>(nativeModules_)));\n ...\n }\n```\n\n- In `NativeModule.js`, JavaScript side can get a bunch of `native modules` from this `nativeModuleProxy` property from `global` object. \n\n```js\nlet NativeModules: {[moduleName: string]: $FlowFixMe, ...} = {};\nif (global.nativeModuleProxy) {\n  NativeModules = global.nativeModuleProxy;\n```\n\n- In the iOS side, the `NativeModuleProxy` class holds a weak pointer for `JSINativeModules` , which actually holds a list of registered native modules. \n\n```c++\n  std::weak_ptr<JSINativeModules> weakNativeModules_; \n```\n\n![image-20201217183117953](image-20201217183117953.png)\n\n## Export Method \n\nThe `RCT_EXPORT_METHOD` macro is used to export method in Objective realm, and will be replaced by the following code\n\n```objective-c\n#define RCT_REMAP_METHOD(js_name, method)       \\\n  _RCT_EXTERN_REMAP_METHOD(js_name, method, NO) \\\n  \n+(const RCTMethodInfo *)RCT_CONCAT(__rct_export__, RCT_CONCAT(js_name, RCT_CONCAT(__LINE__, __COUNTER__))) \n  {                                                                                                          \n    static RCTMethodInfo config = {#js_name, #method, is_blocking_synchronous_method};                       \n    return &config;                                                                                          \n  }\n```\n\nBasically, what it does is to construct a `RCTMethodInfo` structure.  \n\n```objective-c\ntypedef struct RCTMethodInfo {\n  const char *const jsName;\n  const char *const objcName;\n  const BOOL isSync;\n} RCTMethodInfo;\n```\n\nThe  [calculateMethods](https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTModuleData.mm#L294)  extracts exported methods and get the `IMP` of these methods.  `IMP` actually is a c function which takes in `class` and `selector` as its parameters. And then, `RCTMethodInfo` and `moduleClass` are used to construct `RCTModuleMethod`, which confirms to `RCTBridgeMethod`.\n\n### RCTBridgeMethod \n\nThe `RCTModuleData` also contains information about exported methods.\n\n```objective-c\n/**\n * Returns the module methods. Note that this will gather the methods the first\n * time it is called and then memoize the results.\n */\n@property (nonatomic, copy, readonly) NSArray<id<RCTBridgeMethod>> *methods;\n\n/**\n * Returns a map of the module methods. Note that this will gather the methods the first\n * time it is called and then memoize the results.\n */\n@property (nonatomic, copy, readonly) NSDictionary<NSString *, id<RCTBridgeMethod>> *methodsByName;\n```\n\nThe [getter methods](https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTModuleData.mm#L373) for these two will generate a list of `RCTBridgeMethod` objects. `RCTBridgeMethod` is a protocol. Any class confirms to this protocol has to implement `JSMethodName`,  `functionType` and `invokeWithBridge: module:arguments:` function. \n\n```objective-c\n@protocol RCTBridgeMethod <NSObject>\n\n@property (nonatomic, readonly) const char *JSMethodName;\n@property (nonatomic, readonly) RCTFunctionType functionType;\n\n- (id)invokeWithBridge:(RCTBridge *)bridge module:(id)module arguments:(NSArray *)arguments;\n\n@end\n```\n\nSo when react native triggers these two getter method? Well, in the `RCTUIManager`\n\n```\nRCT_EXPORT_METHOD(dispatchViewManagerCommand\n                  : (nonnull NSNumber *)reactTag commandID\n                  : (id /*(NSString or NSNumber) */)commandID commandArgs\n                  : (NSArray<id> *)commandArgs)\n```\n\nBeside, `RCTModuleData` also sets up and holds the thread `methodQueue` for the native module.  This `dispatch_queue_t` object is also retained in [RCTBridgeModule.h](https://github.com/facebook/react-native/blob/e54ead6556f813fc622fd5e1f27ab2b41fa4f213/React/Base/RCTBridgeModule.h#L155), which is used to call all exported methods.\n\n```objc\n- (void)setUpMethodQueue\n{\n  if (_instance && !_methodQueue && _bridge.valid) {\n    RCT_PROFILE_BEGIN_EVENT(RCTProfileTagAlways, @\"[RCTModuleData setUpMethodQueue]\", nil);\n    BOOL implementsMethodQueue = [_instance respondsToSelector:@selector(methodQueue)];\n    if (implementsMethodQueue && _bridge.valid) {\n      _methodQueue = _instance.methodQueue;\n    }\n    if (!_methodQueue && _bridge.valid) {\n      // Create new queue (store queueName, as it isn't retained by dispatch_queue)\n      _queueName = [NSString stringWithFormat:@\"com.facebook.react.%@Queue\", self.name];\n      _methodQueue = dispatch_queue_create(_queueName.UTF8String, DISPATCH_QUEUE_SERIAL);\n\n      // assign it to the module\n      if (implementsMethodQueue) {\n        @try {\n          [(id)_instance setValue:_methodQueue forKey:@\"methodQueue\"];\n        } @catch (NSException *exception) {\n          RCTLogError(\n              @\"%@ is returning nil for its methodQueue, which is not \"\n               \"permitted. You must either return a pre-initialized \"\n               \"queue, or @synthesize the methodQueue to let the bridge \"\n               \"create a queue for you.\",\n              self.name);\n        }\n      }\n    }\n    RCT_PROFILE_END_EVENT(RCTProfileTagAlways, @\"\");\n  }\n}\n```\n\n## How does JS invoke a method in Native?\n\nI set a breakpoint at   [`[RCTModuleMethod invokeWithBridge:module:arguments:]`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519).\n\n![image-20201217171417579](image-20201217171417579.png)\n\n1. in initialization phase, `nativeFlushQueueImmediate` property is set in the global object of the JavaScript execution context.. [code reference here](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L90). `    global.nativeFlushQueueImmediate(queue)` is called in `enqueueNativeCall` from the Javascript side. [code ref.](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/Libraries/BatchedBridge/MessageQueue.js#L318)  Before calling, it makes sure the last Flush is 5 milliseconds ago;  then `nativeFlushQueueImmediate` is triggered.  \n\n```js\n if (\n      global.nativeFlushQueueImmediate &&\n      now - this._lastFlush >= MIN_TIME_BETWEEN_FLUSHES_MS\n    ) {\n      const queue = this._queue;\n      this._queue = [[], [], [], this._callID];\n      this._lastFlush = now;\n      // ðŸŒŸ\n      global.nativeFlushQueueImmediate(queue);\n    }\n```\n\n2. [`call` function in JSCRuntime](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsi/JSCRuntime.cpp#L1151) is invoked when there is a method call from JavaScrip side, then the `host function` is triggered. In this case, the host function is `nativeFlushQueueImmediate` in the C++ realm.\n\n```js\nJSValueRef call(\n        JSContextRef ctx,\n        JSObjectRef function,\n        JSObjectRef thisObject,\n        size_t argumentCount,\n        const JSValueRef arguments[],\n        JSValueRef *exception) {\n  HostFunctionMetadata *metadata =\n          static_cast<HostFunctionMetadata *>(JSObjectGetPrivate(function));\n  JSCRuntime &rt = *(metadata->runtime);\n  ...\n     // ðŸŒŸðŸŒŸ\n     metadata->hostFunction_(rt, thisVal, args, argumentCount));\n  ...\n}\n```\n\n3. See the following C++ lambda is used to create the host function `nativeFlushQueueImmediate`. In side this  C++ lambda,  we can see it calls [callNativeModules](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L106).\n\n```c++\n runtime_->global().setProperty(\n      *runtime_,\n      \"nativeFlushQueueImmediate\",\n      Function::createFromHostFunction(\n          *runtime_,\n          PropNameID::forAscii(*runtime_, \"nativeFlushQueueImmediate\"),\n          1,\n          [this](\n              jsi::Runtime &,\n              const jsi::Value &,\n              const jsi::Value *args,\n              size_t count) {\n            if (count != 1) {\n              throw std::invalid_argument(\n                  \"nativeFlushQueueImmediate arg count must be 1\");\n            }\n            callNativeModules(args[0], false);\n            return Value::undefined();\n          }\n      )\n  );\n```   \nThen [ `callNativeModules` in `JSToNativeBridge`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L390) is invoked.\n\n4. The [callNativeModules in `JSToNativeBridge`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/NativeToJsBridge.cpp#L54) firstly parses the `JSON` data to get the `moduleIds`, `methodIds` and `params`, etc.  [source code here](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/MethodCall.cpp#L38).  After constructing `MethodCall` structure, which holds `moduleId`, `methodId`, `arguments`, `callId`, [`callNativeModules` in `ModuleRegistry.cpp`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/ModuleRegistry.cpp#L220)  is called.\n  ```c++\n   // This is always populated\n  std::vector<std::unique_ptr<NativeModule>> modules_;\n\n  void ModuleRegistry::callNativeMethod(\n    unsigned int moduleId,\n    unsigned int methodId,\n    folly::dynamic &&params,\n    int callId) {\n  if (moduleId >= modules_.size()) {\n    throw std::runtime_error(folly::to<std::string>(\n        \"moduleId \", moduleId, \" out of range [0..\", modules_.size(), \")\"));\n  }\n  modules_[moduleId]->invoke(methodId, std::move(params), callId);\n  }\n  ``` \n  `moduleId` is used to look up the `NativeModule` object in a list of modules.  `NativeModule` list is set up in `CxxBridge` initialization phases, which basically is a vector holding module information in C++ realm, transformed from `_moduleDataByID` array in Objc realm. As we know `_moduleDataByID` is a list of  `RCTModuleData` holding registered `RCTBridgeModule` and its instance. \n\n5. It goes to `invoke` in the [`RCTNativeModule.mm`]( https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L106), which has module info in its private variable `RCTModuleData` object. \n\n6. The[`invoke`](https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L74) function in the [`RCTNativeModule.mm`]( https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L106) calls [`invokeInner`](https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L135). Inside ` invokeInner`, it get the `RCTBridgeMethod` object from `RCTModuleData` object using `methodId` . [code](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L155)\n\n\n```objective-c\n  id<RCTBridgeMethod> method = moduleData.methods[methodId]\n```\n\nThen, it [calls](https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L181)  [`invokeWithBridge:module:arguments:`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519) in the `RCTModuleMethod.mm`. \n\n![image-20201029152216662](image-20201029152216662.png)\n\n\n```c++\nid result = [method invokeWithBridge:bridge module:moduleData.instance arguments:objcParams];\n```\n\n[code ref](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L181)\n\n<img src=\"image-20201029162107074.png\" alt=\"image-20201029162107074\" style=\"zoom:50%;\" />\n\n\n\n7. The  [`invokeWithBridge:module:arguments:`](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519)  uses [ NSInvocation ](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L566) to send message to the related `module` object. \n\n>  An `NSInvocation` object contains all the elements of an Objective-C message: a target, a selector, arguments, and the return value.\n\nâ€‹        7.1.  [parse MethodSignature](https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L204) to init `NSInvocation`.\n\n```objective-c\n_selector = NSSelectorFromString(RCTParseMethodSignature(_methodInfo->objcName, &arguments));\n....  \nNSInvocation *invocation = [NSInvocation invocationWithMethodSignature:methodSignature];\n...\n// set  selector  \ninvocation.selector = _selector;  \n```\n\nâ€‹        7.2, trigger the method in the module  \n\n```objective-c\n [_invocation invokeWithTarget:module];\n```\n\nIn a nutshell,  when JavaScript side calls a method in a specific native module, the indices of the module and method are passed to Objc through JSCRuntime. These information is serialized as JSON object. By looking up the table which holds the information about registered modules and methods, React Native can invoke the specific method in a specific module in the Objective-C realm.  There are some [restrictions](https://github.com/react-native-community/discussions-and-proposals/blob/master/proposals/0002-Turbo-Modules.md#motivation) in this workflow. \n\n![image-20201001143632128](image-20201001143632128.png)\n\n> 1. Native Modules are specified in [a package](https://github.com/facebook/react-native/blob/1e8f3b11027fe0a7514b4fc97d0798d3c64bc895/local-cli/link/__fixtures__/android/0.20/MainActivity.java#L37) and are eagerly initialized. The startup time of React Native increases with the number of Native Modules, even if some of those Native Modules are never used. \n> 2. There is no simple way to check if the Native Modules that JavaScript calls are actually included in the native app. With over the air updates, there is no easy way to check if a newer version of JavaScript calls the right method with the correct set of arguments in Native Module.\n> 3. Native Modules are always singleton and their lifecycle is typically tied to the lifetime of the bridge. This issue is compounded in brownfield apps where the React Native bridge may start and shut down multiple times.\n> 4. During the startup process, Native Modules are typically specified in [multiple packages](https://github.com/facebook/react-native/blob/b938cd524a20c239a5d67e4a1150cd19e00e45ba/ReactAndroid/src/main/java/com/facebook/react/CompositeReactPackage.java). We then [iterate](https://github.com/facebook/react-native/blob/407e033b34b6afa0ea96ed72f16cd164d572e911/ReactAndroid/src/main/java/com/facebook/react/ReactInstanceManager.java#L1132) over the list [multiple times](https://github.com/facebook/react-native/blob/617e25d9b5cb10cfc6842eca62ff22d39eefcf7b/ReactAndroid/src/main/java/com/facebook/react/bridge/NativeModuleRegistry.java#L46) before we finally give the bridge a [list of Native Modules](https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/CatalystInstanceImpl.java#L124). This does not need to happen at runtime.\n> 5. The actual methods and constants of a Native Module are [computed during runtime](https://github.com/facebook/react-native/blob/master/ReactCommon/cxxreact/ModuleRegistry.cpp#L81) using [reflection](https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/JavaModuleWrapper.java#L75). \n\n","tags":["Dive into React Native"],"categories":["iOS","React Native"]},{"title":"iOS main in Assembly","url":"/2020/08/18/20200817-ios-main-in-assembly/","content":"\n### How to see Assemble code in Xcode \n\n`debug` -> `Product -> Action`->  `Assemble`  \"main.m\"\n\n```objective-c\n12 int main(int argc, char * argv[]) {\n13    NSString * appDelegateClassName;\n14    @autoreleasepool {\n15        // Setup code that might create autoreleased objects goes here.\n16        appDelegateClassName = NSStringFromClass([AppDelegate class]);\n17    }\n18    return UIApplicationMain(argc, argv, nil, appDelegateClassName);\n19 }\n```\n\nIt produces a file with 541 lines of code with lots of assembler directives for debugger.  \n\n###  Assembler directives \n\n```assembly\n\t.section\t__TEXT,__text,regular,pure_instructions\n\t.ios_version_min 11, 0\tsdk_version 13, 6\n\t.file\t1 \"/Users/rongyan.zheng/Downloads/AssemblyMain\" \"AssemblyMain/main.m\"\n\t.globl\t_main                   ; -- Begin function main\n\t.p2align\t2\n```\n\nThese are assembler directives, not assembly code. The `.section` directive specifies into which section the following will go.  \n\nNext, the `.globl` directive specifies that `_main` is an external symbol.`.p2align\t2` aligns  the current location in the file to a specified boundary, here it is 2^2, 4 bytes.  \n\n\n\nThen, here comes our `main`  assemble label. \n\n```assembly\n_main:                                  ; @main\nLfunc_begin0:\n\t.loc\t1 12 0                  ; AssemblyMain/main.m:12:0\n\t.cfi_startproc\n; %bb.0:\n\n```\n\n\n\n> The `.cfi_startproc` directive is used at the beginning of most functions. CFI is short for Call Frame Information. A *frame* corresponds loosely to a function. When you use the debugger and *step in* or *step out*, youâ€™re actually stepping in/out of call frames. In C code, functions have their own call frames, but other things can too. The `.cfi_startproc` directive gives the function an entry into `.eh_frame`, which contains unwind information â€“ this is how exception can unwind the call frame stack. The directive will also emit architecture-dependent instructions for CFI. Itâ€™s matched by a corresponding `.cfi_endproc` further down in the output to mark the end of our `main()` function.  -- https://www.objc.io/issues/6-build-tools/mach-o-executables/ \n\n\n\n### SP and stack\n\n```assembly\n\tsub\tsp, sp, #48             ; =48\n```\n\nIt sets up a call frame on the stack. Here `sp` refers to the register for stack-pointer. In AArch64 the stack-pointer must be 128-bit aligned; here is 48*8-bit.\n\n![image-20200807093341883](image-20200807093341883.png)\n\n#### Registers \n\n> Processor operations mostly involve processing data. This data can be stored in memory and accessed from thereon. However, reading data from and storing data into memory slows down the processor, as it involves complicated processes of sending the data request across the control bus and into `the memory storage unit` and getting the data through the same channel. To speed up the processor operations, the processor includes some `internal memory storage locations`, called **registers**.\n>\n> The registers store data elements for processing without having to access the memory. A limited number of registers are built into the processor chip. -- https://www.tutorialspoint.com/assembly_programming/assembly_registers.htm \n\nIn ARM 64, the following graph shows the registers' roles.\n\n![image-20200805000244292](image-20200805000244292.png)\n\n- The first eight registers, r0-r7, are used to pass argument values into a subroutine and to return result values from a function. \n- The frame record for the innermost frame (belonging to the most recent routine invocation) shall be pointed to by the `Frame Pointer register` (FP). The lowest addressed double-word shall point to the `previous frame record` and the highest addressed double-word shall contain the value passed in LR on entry to the current function. \n\n#### Stack Structure\n\n> The stack is a `contiguous area of memory` that may be used for storage of local variables and for passing additional arguments to subroutines when there are insufficient argument registers available.The stack implementation is *full-descending*, with `the current extent of the stack` held in the special-purpose register `SP`.   --[Procedure Call Standard for the ARM 64-bit Architecture (AArch64)- AArch64 ABI release 1.0](https://developer.arm.com/documentation/ihi0055/b/)\n\nThe ARM environment uses a stack thatâ€”at the point of function callsâ€”is grows downward, and contains local variables and a functionâ€™s parameters. The stack is  aligned at the point of function calls.  Figure 1 shows the stack before and during a subroutine call. \n\n![img](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/art/arm_stack.jpg)\n\n Stack frames contain the following areas:\n\n- *The parameter area* stores the arguments the caller passes to the called function or stores space for them, depending on the type of each argument and the availability of registers. This area resides in the callerâ€™s stack frame.\n- *The linkage area* contains the address of the callerâ€™s next instruction.\n- *The saved frame pointer* (optional) contains the base address of the callerâ€™s stack frame.\n- The *local storage area* contains the subroutineâ€™s local variables and the values of the registers that must be restored before the called function returns. See [Register Preservation](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/Articles/ARMv6FunctionCallingConventions.html#//apple_ref/doc/uid/TP40009021-SW4) for details.\n- The *saved registers area* contains the values of the registers that must be restored before the called function returns. See [Register Preservation](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/Articles/ARMv6FunctionCallingConventions.html#//apple_ref/doc/uid/TP40009021-SW4) for details.\n\nIn this environment, the stack frame size is not fixed.\n\nAnother stack frame layout graph comes from [Procedure Call Standard for the ARM 64-bit Architecture (AArch64)- AArch64 ABI release 1.0](https://developer.arm.com/documentation/ihi0055/b/)\n\n![image-20200805222941420](image-20200805222941420.png)\n\nAbout stack and stack pointer, see more in. \n- [Using the Stack in AArch32 and AArch64](https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/using-the-stack-in-aarch32-and-aarch64)\n- [Using the Stack in AArch64: Implementing Push and Pop](https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/using-the-stack-in-aarch64-implementing-push-and-pop)\n\n### Addressing Mode\n\nAs a beginner, I want to know how the addresses are calculated from the figures within the square brackets\n\nHere, we have to know something about  `addressing modes`. There are several addressing modes that define how the address is formed according to [document s about ARMv8 instructions set](https://developer.arm.com/architectures/learn-the-architecture/armv8-a-instruction-set-architecture/loads-and-stores-addressing)  \n\n- **Base register** - The simplest form of addressing is a single register. Base register is an X register that contains the full, or absolute, virtual address of the data being accessed, as you can see in this figure:\n\n  <img src=\"image-20200807150953454.png\" alt=\"image-20200807150953454\"  />\n\n- **Offset addressing modes** - An offset can be applied optionally to the base address, as you can see in this figure:\n\n  <img src=\"image-20200807151043180.png\" alt=\"image-20200807151043180\"/>\n\n  In the preceding figure, X1 contains the base address and `#12` is a byte offset from that address. This means that the accessed address is` X1+12`. The offset can be either a constant or another register. This type of addressing might be used for structs, for example. The compiler maintains a pointer to the base of struct using the offset to select different members.\n\n- **Pre-index addressing modes** - In the instruction syntax, pre-index is shown by adding an exclamation mark `!` After the square brackets, as this figure shows: \n\n  ![image-20200807151621841](image-20200807151621841.png)\n\n  Pre-indexed addressing is like offset addressing,` except that the base pointer is updated as a result of the instruction`. In the preceding figure, `X1` would have the value X1+12 after the instruction has completed.\n\n- **Post-index addressing modes** - With post-index addressing, the value is loaded from the address in the base pointer, and then the pointer is updated, as this figure shows: \n\n  ![image-20200807151851210](image-20200807151851210.png)\n\n  Post-index addressing is useful for popping off the stack. The instruction loads the value from the location pointed at by the stack pointer, and then moves the stack pointer on to the next full location in the stack.\n\nSo, here comes the next instruction in our `main` function: \n\n```assembly\nstp\tx29, x30, [sp, #32] \n```\n\n`stp` pushes X29 and X30 onto the stack, which means this instruction will store values from `x29` and `x30` to memory where the address is `sp+32`. And in ARMv8, `X29` is for frame pointer, `X30` is used as the Link Register and can be referred to as LR.\n\n![image-20200807103821841](image-20200807103821841.png)\n\n### Store parameters on the Stack\n\n```assembly\nadd\tx29, sp, #32            ; =32\n```\n\nset the value of `x29` as `sp` + `#32`\n\n```assembly\nstur\twzr, [x29, #-4]\nstur\tw0, [x29, #-8]\nstr\tx1, [sp, #16]\n```\n\nstore value from `wzr` to `x29 + #-4`, which means write `x29 + #-4` using 0; \n\n>  The zero registers, ZXR and WZR, always read as 0 and ignore writes.\n\nstore value  from `w0` to `x29 + #-8;`\n\nstore value from `x1` to `sp + #16`.\n\n![image-20200807103920889](image-20200807103920889.png)\n\nMost A64 instructions operate on registers. The architecture provides 31 general purpose registers. Each register can be used as a 64-bit X register (X0..X30), or as a 32-bit W register (W0..W30).   W0 is the bottom 32 bits of X0.\n\n<img src=\"image-20200807155505092.png\" alt=\"image-20200807155505092\" style=\"zoom:50%;\" />\n\nThe choice of X or W determines the size of the operation. Using X registers will result in 64-bit calculations, and using W registers will result in 32-bit calculations. \n\n#### Registers for parameters \n\nThe Arm architecture has some restrictions on how general purpose registers are used.  \n\n`X0-X7` is the parameter/result registers.  x0-x7, are used to pass argument values into a subroutine and to return result values from a function.  The first argument is passed into `X0`, the second argument is in `X1`.  \n\nIn our case, `main` function takes two arguments, so `w0` and `X` are used. \n\n#### Registers for return \n\nWhich register is used for return result is determined by the type of that result:\n\n- If the type, T, of the result of a function is such that\n\n  `void func(T arg)`,  the result is returned in the same registers used as passing arguments. For exmaple\n\n![image-20200807175855759](image-20200807175855759.png)\n\n- Otherwise,  the caller shall reserve a block of memory of sufficient size and alignment to hold the result. The address of the memory block shall be passed as an additional argument to the function in X8.`XR` |`X8`.\n\n  \n\n```assembly\nLtmp0:\n\t.loc\t1 13 16 prologue_end    ; AssemblyMain/main.m:13:16\n\tmov\tx8, #0                    ; copy #0 to x8\n\tstr\tx8, [sp, #8]              ; \n\t.loc\t1 14 22                 ; AssemblyMain/main.m:14:22\n```\n\nThen,  store value from `x8` to `sp + #8`.  \n\n![image-20200807154518025](image-20200807154518025.png)\n\n### Branch instructions and Function calls \n\nSo let's see the next instruction. \n\n```assembly\nbl\t_objc_autoreleasePoolPush\n```\n\n> Ordinarily, a processor executes instructions in program order. This means that a processor executes instructions in the same order that they are set in memory. One way to change this order is to use branch instructions. Branch instructions change the program flow and are used for loops, decisions and function calls.\n>\n> The A64 instruction set also has some conditional branch instructions. These are instructions that change the way they execute, based on the results of previous instructions.       --  https://developer.arm.com/architectures/learn-the-architecture/armv8-a-instruction-set-architecture/program-flow\n\n#### Unconditional branch instructions \n\n> There are two types of unconditional branch instructions; `B` which means Branch and `BR` which means Branch with Register. \n\nThe unconditional branch instruction `B <label`> performs a direct, PC-relative, branch to <label>.\n\nIn our case, the `labe` is  `_objc_autoreleasePoolPush`; `bl\t_objc_autoreleasePoolPush` means we will jump to `_objc_autoreleasePoolPush` routine. \n\n#### Conditional branch instructions \n\nThe conditional branch instruction B.<cond> <label> is the conditional version of the B instruction. The branch is only taken if the condition <cond> is true. The range is limited to +/- 1MB.\n\n#### [Labels for PC-relative addresses](https://www.keil.com/support/man/docs/armasm/armasm_dom1359731174549.htm)\n\n> A label can represent the PC value plus or minus the offset from the PC to the label. Use these labels as targets for branch instructions, or to access small items of data embedded in code sections.\n\n\n\n```assembly\n\tadrp\tx8, _OBJC_SELECTOR_REFERENCES_@PAGE\n\tadd\tx8, x8, _OBJC_SELECTOR_REFERENCES_@PAGEOFF        ;@selector(class)\n\tadrp\tx9, _OBJC_CLASSLIST_REFERENCES_$_@PAGE \n\tadd\tx9, x9, _OBJC_CLASSLIST_REFERENCES_$_@PAGEOFF     ; objc_cls_ref_AppDelegate\n```\n\n- `adrp` is to Address of 4KB page at a PC-relative offset\n\n  I drag the final executable into `hopper`,   the address for `_OBJC_SELECTOR_REFERENCES_@PAGE` is `#0x100009000   `\n\n  ```assembly\n  000000010000621c         adrp       x8, #0x100009000                            ; 0x1000093e0@PAGE\n  0000000100006220         add        x8, x8, #0x3e0                              ; 0x1000093e0@PAGEOFF, &@selector(class)\n  0000000100006224         adrp       x9, #0x100009000                            ; 0x1000093f0@PAGE\n  0000000100006228         add        x9, x9, #0x3f0                              ; 0x1000093f0@PAGEOFF, objc_cls_ref_AppDelegate\n  000000010000622c         ldr        x9, [x9]                                    ; objc_cls_ref_AppDelegate,_OBJC_CLASS_$_AppDelegate\n  0000000100006230         ldr        x1, [x8]                                    ; \"class\",@selector(class)\n  ```\n\n  \n\n```assembly\n\tldr\tx9, [x9]                ; load data into x9 from the value in x9.\n\tldr\tx1, [x8]                ; load data into x1 from the value in x8, which is the address of @selector(class)\n\tstr\tx0, [sp]                ; 8-byte Folded Spill\n\tmov\tx0, x9                  ; move the addreess in x9 into x0, which is the address of objc_cls_ref_AppDelegate\n\tbl\t_objc_msgSend           ; call msgSend, [AppDelegate class]\n\tbl\t_NSStringFromClass      ; call NSStringFromClass \n```\n\n#### The return value and auto release \n\n```assembly\n  mov\tx29, x29\t; marker for objc_retainAutoreleaseReturnValue\n\tbl\t_objc_retainAutoreleasedReturnValue\n  ldr\tx8, [sp, #8]            ; load data into x8 from memory [sp, #8] \n\tstr\tx0, [sp, #8]            ; store data from x0 into [sp, #8], which is the result of _NSStringFromClass\n\tmov\tx0, x8                  ; move data from x8 to x0\n\tbl\t_objc_release\n\tldr\tx0, [sp]                ; 8-byte Folded Reload\n\tbl\t_objc_autoreleasePoolPop\n```\n\n\n\n`str\tx0, [sp, #8] ` means store data from x0 into [sp, #8]. As we mentioned before, for functions with this type `NSString *NSStringFromClass(Class aClass)`, the `x0` is used to store the return result. \n\n### Pass parameters\n\n```assembly\n\tldur\tw0, [x29, #-8]      ; load data into w0 from [x29, #-8]; which is int argc\n\tldr\tx1, [sp, #16]         ; load data into x1 from [sp, #16], where argv is stroed\n\tldr\tx3, [sp, #8]          ; laod data into x3 from [sp, #8], which is the result of  the result of _NSStringFromClass\n```\n\n```assembly\n\tmov\tx8, #0\n\tmov\tx2, x8                ; nil\n```\n\n\n\n```assembly\n\tbl\t_UIApplicationMain    ; call _UIApplicationMain\n\tstur\tw0, [x29, #-4]      \n\tadd\tx8, sp, #8              ; =8\n\tmov\tx0, x8\n\tmov\tx8, #0\n\tmov\tx1, x8\n\tbl\t_objc_storeStrong\n\tldur\tw0, [x29, #-4]\n\tldp\tx29, x30, [sp, #32]     ; 16-byte Folded Reload, reset \n\tadd\tsp, sp, #48             ; =48, reset \n\tret\n```\n\n\n\n`ldp\tx29, x30, [sp, #32]`  this is for reset the `fp` and linker regiseter \n\n`add\tsp, sp, #48 ` means, the call frame for this function is gone. \n\n\n\n![image-20200810095955537](image-20200810095955537.png)","tags":["Popular Article","Debug"],"categories":["iOS"]},{"title":"Address Sanitizer","url":"/2020/08/18/20200817-address-sanitizer/","content":"Memory corruption is hard to debug because it is `hard to consistently reproduce` and `the source of error is often far from its manifestation`. But with powful `Address Sanitizer` tool,  we  could achieve it.  `Addresss Sanitizer` is a LLVM-based debug tool to finds memory corruption at run time with `less overhead` at running time. And it works on OS X, iOS (simulator and device). \n\n### Different kinds of memory corruption \n\n- use after free \n- heap buffer overflow \n- Stack buffer overflow \n- global variable overflow \n- overflows in C++ containers \n- Use after return \n- Use after scope\n\n### How to enable Address Sanitizer\n\n- Edit Scheme \n\n- turn on the `Address Sanitizer` \n\n  ![image-20200816172927364](image-20200816172927364.png)\n\n- re-compile the App \n\nThis can be used together with `Malloc Scribble`.\n\n### Xcode Debuger UI \n\n1. showing errors \n\n   ![image-20200816210717157](image-20200816210717157.png)\n\n2. stacktrace \n\n   <img src=\"image-20200816210812044.png\" alt=\"image-20200816210812044\" style=\"zoom:50%;\" />\n\n3. memory allocation \n\n   ![image-20200816210745829](image-20200816210745829.png)\n\n4. Heap object \n\n   1. faulty addresss \n\n5. Expand Memory View. It shows the allocation and deallocation backtrace of the memory. Also we can see the bytes of the object in the memory \n   1. the black bytes : valid memory \n   2. the grey bytes: invalid memory \n\n![image-20200816213933801](image-20200816213933801.png)\n\nWe can also see the bytes of the memory  by `view Memory of xxx`\n\n![image-20200816213627715](image-20200816213627715.png)\n\nBesides, in the `LLDB`, we can run `memory history` to get the backtrace of the allocation and deallocation. \n\n![image-20200816214150578](image-20200816214150578.png)\n\n## Use Cases \n\n### Heap buffer overflow \n\n![image-20200816211332451](image-20200816211332451.png)\n\ncase from here https://www.youtube.com/watch?v=rJFoMq-RI7c\n\n### Use out of scope stack memory \n\n![image-20200816211144445](image-20200816211144445.png)\n\n`value` is a variable that inside the `if` scope. If you assign its address to `integer_pointer` and  access its memory outside the scope by using  `*integer_pointer` , it triggers `use of out of scope stack memory` \n\n### Use stack memory after return \n\n![image-20200816211204763](image-20200816211204763.png)\n\nIn the c function, `return_address_of_stack` it return `&a`, the address of `a` variable. While `a` is a stack variable in this function, the function returns, the stack frame will be released.  At. that time, if we try to use  `a` again, it triggers `use of stack memory after return`. \n\nUse of deallocated memory \n\n![image-20200816213422013](image-20200816213422013.png)\n\n\n\n## When to Use Address Sanitizer\n\n- You project is mixed with C languages and Swift\n- Memory corruptions and crashes, which are hard to reproduce and find out the root cause\n- General debugging\n\n## Integrated with Test and CI \n\nBecause it is less overhead than other tools and detects bugs at the run time,  we can integrate it with XCode test scheme and CI. \n\n#### In Xcode\n\n- Edit Scheme â€“ Test â€“ Diagnostics tab\n- â€œEnable Address Sanitizerâ€ checkbox\n- Build and Test\n\n#### Command Line\n\n```\n$ xcodebuild -scheme \"Jogr\" test -enableAddressSanitizer YES\n```\n\n## Under the Hood \n\n### How Address Sanitizer works\n\nWhen we enable the address sanitizer and compile a executable, Xcode pass a flag to Clang when compiling. \n\n```\n-fsanitize=address\n```\n\nAfter building, the instrumented executable will contain memory checks. Besides, at runtime, this binary links with `Asan` runtime dylib that contains more checks and the dylib is required by the instrumentation. \n\n##### How this memory check works? \n\nIt will check the allocations in our process. In the following graph, the blue region is the memory we allocted.  In the right side, it is the `Shadow memory` maintained by `Address saninitzer` , which tracks the real memory in the left side, telling whether the real memory is address-accessible or not.   The `Redzones` are the poisoned memory. \n\n![image-20200816120042864](image-20200816120042864.png)\n\nIf the executable is compiled by enabling the Address sanitizer, every time before it access to memory, there is prefix instruction to check if this memory is`poisoned`.  If it was, the Address Sanitizer will generate a diagnostics report shown above. \n\n![image-20200816120700174](image-20200816120700174.png)\n\nThe following graph shows the process is trying to access to a poisoned memory and it trigger `Crash` and genrate a diagnostic report. \n\n![image-20200816120921377](image-20200816120921377.png)\n\n#### How the lookup table works \n\nIn address sanitizer, the loop up in the shadow memory should be very fast so that it will be less overhead. To achieve that, they main a look up table where every 8 bytes real memory in user process are tracked by 1 byte in the shadow memory. Even so, the loop up table is large. So they don't allocate memory region for the lookup table. Instead, they reserve the  memory region for shadow usage.  \n\n<img src=\"image-20200816121732422.png\" alt=\"image-20200816121732422\" style=\"zoom:50%;\" />\n\nSupposed the address of the real memory usage in the process is `Addr`. The address of the related shadow memory is `Add >> 3 + Offset`. If the value in the bytes in the shadow memory isn't `0`,  we know the real memory is poisoned. \n\n![image-20200816121722926](image-20200816121722926.png)\n\n### The heap object allocation \n\nThe default Malloc implementation layout out objects in memory one after another for optimizing memory consumption.  But address sanitizer replace default Malloc implementation by using it is own allocate implementation, which lays out objects further apart from each other. \n\n![image-20200816123141896](image-20200816123141896.png)\n\nAll the unused memory between objects are marked as poisoned, marked as `red` in the shadow memory.  Once  a object is free, the related shadow memory is marked as `red`, poisoned too.  Also, address sanitizer will delay reuse of free memory. So it can catch the heap buffer overflow, double-free errors, user-free etc. \n\n### Stack variables \n\n![image-20200816150456865](image-20200816150456865.png)\n\nWhen enabling the Address sanitizer and compiling the executable, some red zone will be inserted between two stack variables, so stack red zones are poisoned at the runtime. \n\n### Global variables\n\n![image-20200816151834767](image-20200816151834767.png)\n\nThey do the similar things during the compiling time for the global variables, \n\n## Overhead\n\n- CPU slowdown usually between 2xâ€“5x\n  - In normal case, CPU slowdown 2x-3x. In some edge case, they have seen the slowdown 5x. \n\n- Memory overhead 2xâ€“3x\n- AddressSanitizer uses more real memory than a native run. Exact overhead depends on the allocations sizes. The smaller the allocations you make the bigger the overhead is.\n- AddressSanitizer uses more stack memory. We have seen up to 3x increase.\n\nStill, this overhead is smaller than other tools that can do the same job. \n\n## The difference in Assembly code  \n\nLet's write a simple Objective-c function, and build a executable. \n\n```objective-c\n- (void)testAllocation\n{\n    NSString *f = @\"RY\";\n    NSArray *a = @[@1];\n    NSLog(@\"%@, %@\", f, a);\n}\n```\n\nThe left side is the Assembly code for normal code; the right side is the Assembly code after enabling the Address Sanitizer. \n\n![image-20200816171459459](image-20200816171459459.png)\n\nThe one with Address Sanitizer enabled adds checks. The following is the shadow memory check. If the value in `w3` , the value from the shadow memory is zero. It goes the `loc100004894` label, continue to run. But if not, it will call `imp___stubs____asan_report_store8` to generate the Address sanitizer report. \n\n![image-20200816172007233](image-20200816172007233.png)\n\n\n\n- [Avoiding Buffer Overflows and Underflows](https://developer.apple.com/library/archive/documentation/Security/Conceptual/SecureCodingGuide/Articles/BufferOverflows.html)\n\n- https://developer.apple.com/videos/play/wwdc2015/413\n- https://developer.apple.com/videos/play/wwdc2017/406\n\n- [AddressSanitizer in LLVM doc](https://clang.llvm.org/docs/AddressSanitizer.html)\n- https://www.youtube.com/watch?v=rJFoMq-RI7c","tags":["Debug"],"categories":["iOS"]},{"title":"Tail Call Elimination in iOS","url":"/2020/08/05/20200805-tail-call-elimination/","content":"\n> Tail call optimization, callee reusing the stack of the caller, is currently supported on x86/x86-64, PowerPC, and WebAssembly. It is performed on x86/x86-64 and PowerPC - [lldb](http://llvm.org/docs/CodeGenerator.html#tail-call-optimization)\n\n\n## Basic Knowledge \n\n### Registers \n\n> Processor operations mostly involve processing data. This data can be stored in memory and accessed from thereon. However, reading data from and storing data into memory slows down the processor, as it involves complicated processes of sending the data request across the control bus and into `the memory storage unit` and getting the data through the same channel. To speed up the processor operations, the processor includes some `internal memory storage locations`, called **registers**.\n>\n> The registers store data elements for processing without having to access the memory. A limited number of registers are built into the processor chip. -- https://www.tutorialspoint.com/assembly_programming/assembly_registers.htm \n\nIn ARM 64, the following graph shows the registers' roles.\n\n![image-20200805000244292](image-20200805000244292.png)\n\n- The first eight registers, r0-r7, are used to pass argument values into a subroutine and to return result values from a function. \n- The frame record for the innermost frame (belonging to the most recent routine invocation) shall be pointed to by the `Frame Pointer register` (FP). The lowest addressed double-word shall point to the `previous frame record` and the highest addressed double-word shall contain the value passed in LR on entry to the current function. \n\n### Stack Structure\n\n> The stack is a `contiguous area of memory` that may be used for storage of local variables and for passing additional arguments to subroutines when there are insufficient argument registers available.The stack implementation is *full-descending*, with `the current extent of the stack` held in the special-purpose register `SP`.   --[Procedure Call Standard for the ARM 64-bit Architecture (AArch64)- AArch64 ABI release 1.0](https://developer.arm.com/documentation/ihi0055/b/)\n\nThe ARM environment uses a stack thatâ€”at the point of function callsâ€”is grows downward, and contains local variables and a functionâ€™s parameters. The stack is  aligned at the point of function calls.  Figure 1 shows the stack before and during a subroutine call. \n\n![img](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/art/arm_stack.jpg)\n\n Stack frames contain the following areas:\n\n- *The parameter area* stores the arguments the caller passes to the called function or stores space for them, depending on the type of each argument and the availability of registers. This area resides in the callerâ€™s stack frame.\n- *The linkage area* contains the address of the callerâ€™s next instruction.\n- *The saved frame pointer* (optional) contains the base address of the callerâ€™s stack frame.\n- The *local storage area* contains the subroutineâ€™s local variables and the values of the registers that must be restored before the called function returns. See [Register Preservation](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/Articles/ARMv6FunctionCallingConventions.html#//apple_ref/doc/uid/TP40009021-SW4) for details.\n- The *saved registers area* contains the values of the registers that must be restored before the called function returns. See [Register Preservation](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/Articles/ARMv6FunctionCallingConventions.html#//apple_ref/doc/uid/TP40009021-SW4) for details.\n\nIn this environment, the stack frame size is not fixed.\n\nAnother stack frame layout graph comes from [Procedure Call Standard for the ARM 64-bit Architecture (AArch64)- AArch64 ABI release 1.0](https://developer.arm.com/documentation/ihi0055/b/)\n\n![image-20200805222941420](image-20200805222941420.png)\n\n### Passing Arguments\n\n> When functions (routines) call other functions (subroutines), they may need to pass arguments to them. The called subroutines access these arguments as *parameters*. Conversely, some subroutines pass a *result* or return value to their callers. In the ARMv6 environment, arguments may be passed on the runtime stack or in registers; in addition, some vector arguments are also passed passed in registers. Results are returned in registers or in memory. To efficiently pass values between callers and callees, GCC follows strict rules when it generates a programâ€™s object code. - [ARMv6](https://developer.apple.com/library/archive/documentation/Xcode/Conceptual/iPhoneOSABIReference/Articles/ARMv6FunctionCallingConventions.html#//apple_ref/doc/uid/TP40009021-SW8)\n\nThe base standard provides for passing arguments in general-purpose registers (r0-r7)\n\n### Returning Results\n\nThe manner in which a result is returned from a function is determined by the type of that result:\n\n- If the type, `T,` of the result of a function is such that\n\n  `void func(T arg)`\n   would require that `arg` be passed as a value in a register, then the result is returned in the same registers as would be used for such an argument.\n\n- Otherwise, `the caller shall reserve a block of memory of sufficient size and alignment to hold the result`. The address of the memory block shall be passed as an additional argument to the function in `x8`. `The callee may modify the result memory block` at any point during the execution of the subroutine (there is no requirement for the callee to preserve the value stored in x8).\n\n## Tail call Elimination  \n\n### Normal Case \n\nLet's say we have a method `drawRect`, which calls ` CGContextDrawPath`\n\n```objective-c\n- (void) drawRect: (NSRect) rect {\n  // draw stuff\n  ...\n  CGContextDrawPath(_path, kCGStroke);\n}\n```\n\n<img src=\"./image-20200804224933284.png\" alt=\"image-20200804224933284\" style=\"zoom:50%;\" />\n\nThe above picture is the stack right before UIKit calls the `drawRect` method. This graph comes from [WWDC](https://developer.apple.com/videos/play/wwdc2015/412/?time=729). \n\nHere, `fp`  is the[ frame pointer]( https://chortle.ccsu.edu/assemblytutorial/Chapter-28/ass28_4.html)  .`lr` is the `link register`, which holds the next instruction to execute in the caller function( routines) that called the current function(subroutines). So the current function, `subroutines` know how to return to its caller. \n\nWhen UIKit calls `drawRect`, firstly,  `drawRect` will establish its call frame by pushing the `return` address from the link registe(`lr` )and `previous value `of the frame pointer ( `frame Ptr`), on the stack. As we said before,  there are registers store these two data. \n\n```assembly\n+0x00 push {r4, r5, r6, fp, lr}\n```\n\n the frame poniter, `fp` , will store a new address,  the value in `sp`  + 12. Then, `fp` will be set up on a new base just as the following graph shows. \n\n```assembly\n+0x02 add fp, sp, #12\n```\n\n<img src=\"./image-20200805094701153.png\" alt=\"image-20200805094701153\" style=\"zoom:50%;\" />\n\n\n\nThen, `drawRect` makes room for storing local variables,  and has its call frame on the stack. \n\n```assembly\n+0x04 sub sp, #180\n```\n\n<img src=\"./image-20200805094754924.png\" alt=\"image-20200805094754924\" style=\"zoom:50%;\" />\n\nNext, `drawRect` calls `CGContextDrawPath`,  which will also set up its call frame on the stack. \n\n<img src=\"./image-20200805094818787.png\" alt=\"image-20200805094818787\" style=\"zoom:50%;\" />\n\n> [The way time profiler works, it uses a service in the kernel ](https://developer.apple.com/videos/play/wwdc2015-412/?time=700)[that will sample what the CPUs are doing ](https://developer.apple.com/videos/play/wwdc2015-412/?time=703)[at about 1000x per second.](https://developer.apple.com/videos/play/wwdc2015-412/?time=705)In this case, if we take a sample, we see that we're running inside of context draw path.\n>\n> [Then the kernal looks at the frame Pointer register to see ](https://developer.apple.com/videos/play/wwdc2015-412/?time=714)[where the base of that function's frame is ](https://developer.apple.com/videos/play/wwdc2015-412/?time=718)[and find the return address of who called it.](https://developer.apple.com/videos/play/wwdc2015-412/?time=721) \n\n### Backtrace \n\nSo, what is Backtrace? Well,  by using frame pointer that was pushed on the stack,  we know the the base address of the callerâ€™s stack frame. Since every call frame of the method has store the base address  of its caller's stack frame, we can use this to go through the chain of the call frames in this stack.  \n\n<img src=\"/image-20200805094837070.png\" alt=\"image-20200805094837070\" style=\"zoom:50%;\" />\n\n### Optimized case \n\nIn `drawRect`, after calling `CGContextDrawPath` , it is going to  `return`, which means actually it will `pop stack frame`, `restore fp`, and then `jump back to caller` . \n\n<img src=\"image-20200805231739717.png\" alt=\"image-20200805231739717\" style=\"zoom:50%;\" />\n\nSince `CGContextDrawPath` needs nothing from `drawRect`, the params it needs arn't from the call frame of `drawRect` , the compiler does an optimization here.  It rearranges the code as follow. I `pops stack frame` of `drawRect` firstly, `restores fp`,  then calls  `CGContextDrawPath` . So it doesn't have to `jump back to caller`  , the address stored in the `lr` register. \n\nFigure 1. it is going to  `pops stack frame`\n\n![image-20200805232447437](image-20200805232447437.png)\n\nFigure 2. after  poping stack frame of `drawRect`, the call frame of drawRect doesn't exist on the Stack any more.  Then `sp` moves.\n\n![image-20200805232642308](image-20200805232642308.png)\n\nFigure 3. after restoring `fp` to the base address of its caller's frame pointer, the `return address` and `frame ptr` of `drawRect` don't exist on the Stack any more.  Then `sp` moves.\n\n![image-20200805232724011](image-20200805232724011.png)\n\nFinally, it calls `CGContextDrawPath`, which establish its own call frame on the Stack. So, the stack is like this now. \n\n```assembly\n+0x76 b.w \"CGContextDrawPath$shim\"\n```\n\n<img src=\"image-20200805234014273.png\" alt=\"image-20200805234014273\" style=\"zoom:50%;\" />\n\n### The difference in the Call Tree \n\nThe left side is the normal case, the right side is the optimized case where then call frame of `drawRect` will be removed from the stack in the optimized case. It looks like `CGContextDrawPath` is directedly called from `drawLayout:inContext` .\n\n![image-20200805234610955](image-20200805234610955.png)\n\n### The benifit of Tail call Elimination \n\n- Saves stack memory \n- Keeps caches hot, and reuses the memory\n- Best for recursive function tail calls, especially `tail call recursive code`, where a function or method calls itself as the last line of code and then returns.  With Tail call Elimination, the stack won't grow so much that we can get hight performances.\n\n### Disabling\n\nset this compiler flag when building,  you can get better call tree in the Time Profiler when profiling app. \n\n- CFLAGS=â€œ-fno-optimize-sibling-calls\"\n\n### Call Semantics\n\nThere is a useful trick to indentify if this is a Tail call Elimination case. That is to\n\n`look at the disaeembly and call sight of the last call`\n\n![image-20200806092252238](image-20200806092252238.png)\n\n- In normal call, it uses `a Branch and Link family of instructions` (bl)\n\n  - Sets `lr` to  next address and jumps to the caller\n\n    ```assembly\n    Caller: +0x174 blx \"CGContextDrawPath $shimâ€\n    ```\n\n- In optimized call, Tail Calls use `simple branches` (b) , directedly jump into the function\n\n  ```assembly\n  Caller: +0x174 b.w \"CGContextDrawPath $shimâ€\n  ```\n\n  ","tags":["Debug","LLDB"],"categories":["iOS"]},{"title":"Behind the Scenes of the Xcode Build Process","url":"/2020/07/05/20200705Behind-the-Scenes-of-the-â€¢Xcode-Build-Process/","content":"\n> Most contents come from https://developer.apple.com/videos/play/wwdc2018/415 \n\nThe new building system introduced in Xcode 10 is written by Swift from scratch, and brings lots of improved performance and reliability.  So what happens when we press `CMD + B` in Xcode? \n\nIn general, Xcode has to do tasks like preprocess source files and compile them by compiler,  link source code by linker, copy and process resources like headers, asset catalogues and storyboards, And finally code sign and maybe even do some custom work in a shell script or a make file like building API documentation for your framework or running code linting and validation tools.\n\n![image-20200705224132928](image-20200705224132928.png)\n\n## Build Task dependency and execution order \n\nBuilding tasks are executed in a particular order. \n\n<img src=\"image-20200705170528761.png\" alt=\"image-20200705170528761\" style=\"zoom:50%;\" />\n\nThe building system use the dependency information to determine which tasks should be run and what task can be run in parallel.  This is called `dependency order`.  \n\n We know that a compiler can produce `.o` files from `.m` files. Then a linker consumes a number of object files and produces executable or library output. The following graphic shows the dependency info between compilation and linking tasks.  \n\n![image-20200705170723485](image-20200705170723485.png)\n\n### Build tasks are executed in dependency order \n\n1. The  building system will process the project and represented building tasks as a Directed Graph \n\n> What happens when you press build? So the first step is for the build system to take the build description, your Xcode project file.Parse it, take into account all the files in your project, your targets and the dependency relationships.Your build settings, and turn it into a tree-like structure called a directed graph.\n>  And this represents all the dependencies between the input and output files in your project and the tasks that will be executed to process them.\n\n![image-20200705172316201](image-20200705172316201.png)\n\n2. Then the low-level execution engine get the dependency specifications from the above graph and figures out which tasks to execute.\n\n   <img src=\"image-20200705225725510.png\" alt=\"image-20200705225725510\" style=\"zoom:80%;\" />\n\n### Discovered Dependencies \n\nWhen clang compile `PetController.m` source file into object file, `PetController.d` file  is also generated, which contains a listing of information about which header files were included by that source file. Next time you build, if you change any of the header files that `PetController.d` includes, the building system will recompile `PetController.m`. \n\n<img src=\"image-20200705225819662.png\" alt=\"image-20200705225819662\" style=\"zoom:50%;\" />\n\n\n\n### Incremental builds\n\nHaving accurate dependency information is very important in order for incremental builds to work correctly and efficiently, in this case,  the build system only execute a subset of the tasks on the building tasks graph\n\n**how does the build system actually detect changes?**\n\n1. Each time in the building graph has a signature, which computed from stat info of inputs and other task metadata. \n2. Building system tracks signatures of current and previous build, and compared them to determine whether a task should be run. \n\nFor example, in the following picture, building system only has to run these 3 highlight tasks when only `PetViewVontroler.m` changed\n\n![image-20200705231435967](image-20200705231435967.png)\n\n## How can we help the build system? \n\nThe answer is to handle the dependency properly so that the build system can order tasks correctly and build in parallel to save time. \n\n#### Where do dependencies come from? \n\n- Built in. The build system ships with rules for the compiler, the linker, the asset catalogue and story board processors and so on.\n   And these rules define what kind of files are accepted as inputs as well as what outputs are produced.\n\n- Target dependencies, which roughly determine the order in which targets are built.\n\n  <img src=\"image-20200705232141133.png\" alt=\"image-20200705232141133\" style=\"zoom:50%;\" />\n\n- Implicit dependencies \n\n  <img src=\"image-20200705232159289.png\" alt=\"image-20200705232159289\" style=\"zoom:50%;\" />\n\n- Build phase dependencies.  The tasks associated with each of these phrases are usually running groups according to the order in which the phases are listed. But the build system might ignore that order if it knows better.\n\n  <img src=\"image-20200705232220121.png\" alt=\"image-20200705232220121\" style=\"zoom:50%;\" />\n\n- Scheme order dependencies. \n\n  If you have the parallelize build check box enabled in your scheme settings, you get better build performance and the order of your targets in your scheme doesn't matter.  However, if you turn parallelize build off, Xcode will attempt to build their, your targets in the order you listed them in the build action of the scheme one by one.\n  <img src=\"image-20200705232238281.png\" alt=\"image-20200705232238281\" style=\"zoom:50%;\" />\n\n#### What we can do? \n\n- Declare inputs and outputs to help the build system avoid rerunning the script tasks unnecessarily\n\n  <img src=\"image-20200705232718754.png\" alt=\"image-20200705232718754\" style=\"zoom:50%;\" />\n\n- Avoid Auto-link for project dependencies.  \n\n  > This setting allows the compiler to automatically link to the frameworks corresponding to any modules you import without having to explicitly link them in your link library's build phase. However, it's important to note that auto-link does not establish dependency on that framework at the build system level. So it won't guarantee that the target you depend on is actually built before you try to link against it.\n\n  <img src=\"image-20200705232921705.png\" alt=\"image-20200705232921705\" style=\"zoom:50%;\" />\n\n- Add explicit dependencies \n-  You might also need to create project references by dragging and dropping another Xcode project into your project's file navigator in order to reveal the targets of other projects you depend on.\n\n## [Clang compiler](https://clang.llvm.org/)\n\n### Header map \n\n> `Header map` is used by the Xcode build system to know where the header files are.\n\nIn Objective-C, a header file is a promise, saying that the implementation exists somewhere else. If you only update the `header` file, adding a new function A,  without implementation of the function in `m` file, you broke your promise. Then you use function A in class B.   This doesn't break during compile time, because compiler trusts the promise, saying that there is a function A symbol exists, but during link,  we usually got `symbol undefined` error. \n\n### 1. How does Clang find your header files? \n\nWe can copy the arguments from the Xcode building log when Clang compiles a single `.m` file, then using command line to see more details. \n\n<img src=\"image-20200705234147883.png\" alt=\"image-20200705234147883\" style=\"zoom:50%;\" />\n\n```\n clang <list of arguments> -c Cat.mm -o Cat.o -v\n```\n\n\n\nFirst, Clang will start searching the header in header map files. \n\n<img src=\"image-20200705234506914.png\" alt=\"image-20200705234506914\" style=\"zoom:50%;\" />\n\n<img src=\"image-20200705234528306.png\" alt=\"image-20200705234528306\" style=\"zoom:50%;\" />\n\n#### What are header maps \n\n<img src=\"image-20200705234700573.png\" alt=\"image-20200705234700573\" style=\"zoom:50%;\" />\n\n\n\nIn the header map, for the first two keys `PetKit.h` and `Cat.h` , it just simply append the framework name, make them as `PetKit/PetKit.h` and `PetKit/Cat.h`. This keep existing projects working when you use `import <Cat.h>` or `import Cat.h`,  but there might be issues down the road with Clang modules.  So it is recommended that you always `specify the framework name` when you include a public or private header file from your own framework. \n\n#### Suggestion for importing headers explicitly in your source code to help Clang find the header:  \n\n- Always explicit a framework name when you introduce a public and private header \n- always add the header to the project \n- Always use unique name for header avoid shadowing other headers \n\n### 2. How does Clang find system header files? \n\n`Headermap` is only for developers' code. So, in the case of finding system header files, Clang focus on two directories. \n\n```\n$(SDKROOT)/usr/include \n$(SDKROOT)/System/Library/Frameworks.(framework directory).\n```\n\nTake `import <Foundation/Foundatoin.h>` as an example, Clang appends `Foundation/Foundation.h` to the `(SDKROOT)/usr/includ`, and search the header in this path.\n\n```\n$(SDKROOT)/usr/include/Foundation/Foundation.h\n```\n\nIf it doesn't find the header under `$(SDKROOT)/usr/include ` ,  it continues to find header file in framework directory. \n\n```\n$SDKROOT/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h\n```\n\n### Process your file \n\nXcode -> Product ->. Perform Action -> Preprocess \"\". This is the action to create preprocessed file for us, where the `import ...`  statement is substituted with the contents of that file.\n\n```\n#import <Foundation/Foundation.h>\n```\n\nClang has to find and process over 800 header files for this single include statement. That's over 9 megabyte of source code that has to be parsed and verified.\n\nAfter preprocessing: \n\n![image-20200706000118839](image-20200706000118839.png)\n\nHow does Clang do to avoid these redundant and heavy job?  \n\n### Clang module  \n\nTo speed up the building,  by using module, Clang can parse the header only once and store the information `in the disk`, then `reuse the cache` next time. \n\n In order to achieve this, Clang module should have  properties. \n\n- Context-free \n\n  ignore the context-related statement. Like, macro definitions\n\n  ![image-20200706091410725](image-20200706091410725.png)\n\n- Self-contained \n\n  have to specify all the dependencies.\n\n#### Module Map \n\n> A Module Map describes how a certain set of header files translate onto your module.\n\nThis is the `module map` file for Foundation.framework. \n\n<img src=\"image-20200706092447210.png\" alt=\"image-20200706092447210\" style=\"zoom: 50%;\" />\n\n- It obviously describes what is the name of the module which is, Foundation.\n\n- it also specifies what headers are part of this module.  `Foundation.h` is a umbrella header.  If you want to find `NSString` header, you have to look into `Foundation.h` file. \n\n  <img src=\"image-20200706091927374.png\" alt=\"image-20200706091927374\" style=\"zoom:50%;\" />\n\n#### Build Module \n\nWhile building the foundation module, we have to build its dependency too. \n\n<img src=\"image-20200706095037818.png\" alt=\"image-20200706095037818\" style=\"zoom:50%;\" />\n\n#### Module Cache\n\n```\n$ clang -fmodules â€”DENABLE_CHINCHILLA=1 ...\n```\n\nThe command line arguments for building a module can affect the content of your module. Clang will hash all those arguments and store the modules we created for this particular compiler invocation in a directory matching that hash.\n\n<img src=\"image-20200706095441247.png\" alt=\"image-20200706095441247\" style=\"zoom:50%;\" />\n\n## How about Swift \n\nWhen compiling Objective-C files,  the compiler compiles each file separately and in parallel, by process the `import` statement, and then compiling the file. As we know, unlike Objective-C, Swift doesn't have headers. So First, the compiler has to find declarations both within the Swift target and also coming from Objective-C.  Further, it has to generate interfaces describing the contents of the file. \n\n### Finding declarations \n\n- Within a Swift target \n\n  In the following example, the compiler will check the type in the `PetView`'s initializer ', firstly, it parses the `PetView` and knows the declaration of the initializer is well formed. And then, it checks the call inside the \tPetViewController`. \n\n![image-20200709093711492](image-20200709093711492.png)\n\nâ€‹\tSo, actually, when compiling one Swift file, the compiler will parse all the other Swift files in the target. When compiling files separately and in parallel, it causes repeated parsing all files to find declarations.\n\n#### ![image-20200709095907259](image-20200709095907259.png)\n\n In order to improve performance, Xcode 10 combines the files into groups to reuse parsing within a group, and only repeat parsing across groups.\n\n![image-20200709095800665](image-20200709095800665.png)\n\n- Find declarations from Objective-C \n\n  In fact, `Swiftc` compiler embeds `clang`, so   we can can import clang frameworks directly\n\n  > 1. In any target, when you import an Objective-C framework, the importer finds declarations in the headers exposing Clang's module map for that framework.\n  > 2. Within a framework that mixes Swift and Objective-C code, the importer finds declarations in the umbrella header.\n  > 3. Within applications and unit test bundles,  you can find declaration from the target's bridging header.\n\n### Generating interface \n\n- How your Objective-C header will be imported into Swift\n\n  In this `PetViewController.h`, you use the button in the top-left corner of the source editor, see `generated interface`. \n\n  ![image-20200710110626097](image-20200710110626097.png)\n\n- To use Swift in Objective-C \n\n  ![image-20200710112907949](image-20200710112907949.png)\n\n  - For classes extending NSObject and methods/properties marked `@objc`\n  - Apps and unit tests: both public and internal declarations\n  - Frameworks: Only `public declarations`\n  - Compiler ties Objective-C class to mangled Swift class name. The Objective-C name includes the module name `PetWall` . This is to prevent conflict when two modules define class with same name\n  - You can also use `@objc(Name`) to provide custom name â€” but must not conflict!\n\n- To use Swift in other Swift targets\n\n  - Must firstly import other modules to see their declarations, because in Swift, a module is a distributable unit of declarations.\n\n  - Can import Objective-C modules. \n\n  - In Xcode each `Swift target` produces `a separate module`, so your app target does.\n\n### swfitmodule vs header\n  `swfitmodule` file is serialized, binary representation of moduleâ€™s declarations, which will be deserialised by compiler  to check the types when you use them. So this `swfitmodule` is a bit like `like a generated Objective-C header`. But instead of text, it's a binary representation. Besides, it does include the names and types of `private declarations` so that we can refer to them in the debugger. In addition, it includes the `bodies of inlineable`functions`,  like `static inline function`s in Objective-C  header\n\n    ![image-20200710113202143](image-20200710113202143.png) \n\n  ![image-20200709100603559](image-20200709100603559.png)\n\n   For incremental builds, the compiler produces partial Swift module files and then `merges` them into a single `swift module` file, and  a single Objective-C header. \n\n### In summary:\n\n- Swift uses Objective-C declarations by Bridging header.\n- Objective-C uses Swift declarations by Generated header.\n- In Objective-C Clang find where the header file is by header map files.  \n- In Swift, `swfitmodule` is a bit like like a generated Objective-C header\n\n![](generated_header.png)\n\n## Linker \n\n### What is Linker? \n\nLinking is the final task in building an executable Mach-O. What it does it to combine the output of all compiler invocations into a executable. \n\nTake two kinds of input files \n\n- Object files (`.o`)\n- Libraries (`.dylib`, `tbd`, `.a`)\n\n###  Symbols \n\n> A symbol is a name for a fragment of code or data, which may reference other symbols. \n\n- Symbols can have attributes on them that alter the linkerâ€™s behavior, like `Weak symbols`. \n\n- Languages often encode data into a symbol `mangling` the symbol\n\nweak symbols \n\n### Object Files \n\nObject file, `.o` file is the output of individual compiler actions. A non-executable Mach-O file containing code and data fragments. \n\n- Each fragment is represented by a symbol. \n- Fragment may reference `undefined` symbol. \n\n### Libraries\n\n>  Libraries define symbols that are not built as part of your target\n\n- Dylibs: Dynamic libraries\n\n  - Mach-O file that exposes code and data fragments for executables to use. Those are distributed as part of the system,  and a number of you also use your own frameworks\n\n- TBDs: Text Based Dylib Stubs\n\n  - Only contains symbols. \n\n    1. a stub dylib  where we delete the bodies of all of the symbols and we just have the names.\n    2. a textual representation of them that are easier for us to use\n\n    ```\n    ---\n    archs:           [ armv7, armv7s, arm64 ]\n    platform:        ios\n    install-name:    /usr/lib/libsqlite3.dylib\n    current-version: 216.4\n    compatibility-version: 9.0\n    exports:         \n      - archs:           [ armv7, armv7s, arm64 ]\n        symbols:         [ __sqlite3_lockstate, __sqlite3_purgeEligiblePagerCacheMemory, \n                           __sqlite3_system_busy_handler, __sqlite_auto_profile, \n                           __sqlite_auto_profile_syslog, __sqlite_auto_trace, \n                           __sqlite_auto_trace_syslog, _sqlite3OsShmHasMultipleLinks, \n                           _sqlite3OsShmRenamedWhileOpen, _sqlite3OsShmWasTruncated, \n                           _sqlite3OsShmWasUnlinkedWhileOpen, _sqlite3VersionNumber, \n    ```\n\n    from [stackoverflow](https://stackoverflow.com/questions/31450690/why-xcode-7-shows-tbd-instead-of-dylib)\n\n- Static archives\n\n  - An archive of multiple `.o` files built with the archive tool. `ar` tool. [ar](https://linux.die.net/man/1/ar)\n  - It ends with `.a` suffix, and is something like ZIP or TAR archive.\n  - Only the `.o` files with symbols you reference are included in your app\n\n  see more  [here](https://www.vadimbulavin.com/static-dynamic-frameworks-and-libraries/)\n\n### Example \n\nThe left side is the source, the right side is the object file.  \n\nFirstly, let's look at the `purrFile` variable, it is `static`  , and  `nonexported` name.  So it doesn't appear in the object file.  \n\n<img src=\"image-20200710150601150.png\" alt=\"image-20200710150601150\" style=\"zoom:50%;\" />\n\nThen, here comes  an actual symbol `-[Cat purr]`. \n\n![image-20200710150636666](image-20200710150636666.png)\n\nThen, we see two instructions to pass the variable `purrFile` into `playSound` function. It is because,  we don't have concrete address for  `purrFile` and we don't know where this string is going to end up in the final executable.  But in  `ARM64`, it could take at most two instructions.  \n\n-  [adrp](https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/ADRP) \n\nSo the compiler leaves the symbolic values `PAGE` and `PAGEOFF` that the linker will come in and fix up later.\n Finally,  we've loaded that string into register  `x0` . \n\n![image-20200710150648959](image-20200710150648959.png)\n\n`__Z9playSoundPKc`  is a C++ `demangle symbol`  \n\n![image-20200710150707825](image-20200710150707825.png)\n\n\n\n![image-20200710154006829](image-20200710154006829.png)\n\nWhen linking, linker takes a number of object files as input, and create a file to put them in.  In the `__TEXT` segment, it copies the executable code from the object file.  Then, in another segment, it copy the string. Now, the linker knows the absolute addresses of the string symbol, it will rewrite the instruction using a specific address. Meanwhile, the second instruction just went away, it replaced it with a null instruction `that does nothing`. [nop](https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/NOP?lang=en)\n\n\n\n![image-20200710154246392](image-20200710154246392.png)\n\n Then the linker has to resolve the `undefined symbol`, `__Z9playSoundKc`.  \n\n<img src=\"image-20200710155242689.png\" alt=\"image-20200710155242689\" style=\"zoom:50%;\" />\n\nWe start looking through the `.o` file in the `.a` archive file, and found out matching symbol for `playSound`. Then, linker put this symbol into the `PetKit`.   While copying code, it rewrite`_open` symbol as `_open$stub`. Why? because `_open` is in the lib system TBD file, which means it is in the system library. The linker needs to put more information in the Application executable file to make it call this function properly. \n\nSo, it makes a fake function, `_open$stub`  , where it actually loads from the`$open` pointer and jumps to it. \n\n- [bl](https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/BL?lang=en)\n- `ldr` (load register) loads data from a memory location into a register. \n- [br](https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/BR?lang=en)\n\n![image-20200710160920246](image-20200710160920246.png)\n\n![image-20200710161911500](image-20200710161911500.png)\n\n- [Building faster in Xcode](https://developer.apple.com/videos/play/wwdc2018/408)\n- [build time optimization](https://www.onswiftwings.com/posts/build-time-optimization-part1/)\n- [The build process](https://www.objc.io/issues/6-build-tools/build-process/)\n- [The compiler](https://www.objc.io/issues/6-build-tools/compiler)\n- [swift-llbuild](https://github.com/apple/swift-llbuild)\n- [Understanding Xcode Build System](https://www.vadimbulavin.com/xcode-build-system/)\n- [iOS Assembly Tutorial](https://www.raywenderlich.com/2705-ios-assembly-tutorial-understanding-arm#toc-anchor-001)\n","tags":["LLDB","Building"],"categories":["iOS"]},{"title":"Advanced debug in Xcode and LLDB","url":"/2020/06/07/20200607-Advanced-debug-in-Xcode-and-LLDB/","content":"\n# Advanced debug in Xcode and LLDB \n\nhttps://developer.apple.com/videos/play/wwdc2018/412 \n\nThis session is awesome! \n\n## Configure behaviors to dedicate a tab for debugging\n\nIn `Prefernece` -> `Behaviors` ,  we can custom the debugging tab for ourselves. For example, choose `Show tab named` , fill in the name and choose `active window` . We will have a independent debug tab. \n\n![image-20200601222857985](412/image-20200601222857985.png)\n\n\n\n<img src=\"media/15902152252875/image-20200607112605302.png\" alt=\"image-20200607112605302\" style=\"zoom:50%;\" />\n\n## LLDB expressions can modify program state\n\nBy using  auto-continuing breakpoints with debugger commands to inject code live, you can inject expression, change state or logic without compiling the project.  \n\n**How to do it? **\n\n- Click `Edit BreakPoint...`\n\n- Click `add action` ; the default option is `Debugger Command`  we can write some `LLDB` command here\n\n- Choose the `Automatically continue`, it will not pause when trigger this breakpoint. \n\n  \n\n  <img src=\"media/15902152252875/image-20200607111532596.png\" alt=\"image-20200607111532596\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"media/15902152252875/image-20200601224246210.png\" alt=\"image-20200601224246210\" style=\"zoom:50%;\" />\n\n\n\n## Symbolic Breakpoint \n\n`Symbolic Breakpoint` is one of my favorite tools to debug issues caused by others' framework.\n\nIn the  `Breakpoint navigator` , choose `Symbolic Breakpoint` .  \n\n<img src=\"412/image-20200607113135963.png\" style=\"zoom:50%;\" />\n\nFill in any signature of the `Objective-c` method you want. \n\n<img src=\"412/image-20200607113105829.png\" style=\"zoom:50%;\" />\n\n## â€œpo $arg1â€ ($arg2, etc) in assembly frames to print function arguments\n\n<img src=\"412/image-20200601224622911.png\" style=\"zoom:50%;\" />\n\nIn this case,  we use `Symbolic Breakpoint` to hit the `setText:` in `UILabe`, but we don't have the source code of `UIKit`. When the method is hit, we are in an assembly frame, we can use `$arg` to inspect the parameters.  `$arg1` is `self` pointer. `$arg2` is the  `selector` of the method. Others are  arguements to the method. [doc for objc_msgSend](https://developer.apple.com/documentation/objectivec/1456712-objc_msgsend#parameters)\n\n<img src=\"media/15902152252875/image-20200601224723843.png\" style=\"zoom: 50%;\" />\n\n\n\n**Noted**:  we have to do typecast for the `$arg2` , which is a `Slector` . \n\n<img src=\"media/15902152252875/image-20200601224918951.png\" alt=\"image-20200601224918951\" style=\"zoom:50%;\" />\n\n## Create dependent breakpoints using â€œbreakpoint set --one-shot trueâ€\n\nIf a Breakpoint is frequently hit, Like the above breakpoint `[UILabel setText:]`,  usually we will edit `conditions` for this breakpoint. And then, this `Breakppint` will be hit only when the expression for the condition is true.  However, when we don't a property to make the `condition expression`.   There is another way.  We can add action `one-shot symbolic breakpoint` in `a specific breakpoint`, where it will be hit only once in the proper time. \n\n>  The one shot breakpoint is a temporary breakpoint that only exists until it's triggered and then it's automatically deleted.\n\n\n\n<img src=\"media/15902152252875/image-20200607115734569.png\" alt=\"image-20200607115734569\" style=\"zoom:67%;\" />\n\n- Set  a break point in line 96, where we might don't want a break, but we can `configure this breakpoint` to actually set the `symbolic breakpoint` in UI label set text . \n- choose `automatically continue` \n\n- Then add action , `breakpoint set --one-shot true --name \"[UILabel setText:]\"`.  This `one-shot symbolic breakpoint` is activated only after this breakpoint in line 96 is hit.  \n\n\n\nHow magical the dependent breakpoints are!\n\n\n\n## Skip lines of code \n\nBy `dragging` Instruction Pointer, the green handler in the following picture,  we can skip lines of code. It means, these lines of  code will not be executed. \n\n![image-20200607123358909](media/15902152252875/image-20200607123358909.png)\n\n\n\nOr we can use `action` int the breakpoint to skip this line of code for us. \n\n<img src=\"media/15902152252875/image-20200607123639829.png\" alt=\"image-20200607123639829\" style=\"zoom:50%;\" />\n\n\n\nAfter doing that, we can add `expression` to add new expressions, like calling other functions. \n\n<img src=\"media/15902152252875/image-20200607123845152.png\" alt=\"image-20200607123845152\" style=\"zoom:50%;\" />\n\n\n\n## Pause when variables are modified by using watchpoints\n\n\n\n- filter the variable we want using `fitler` \n- click `Watch attempts` \n\n<img src=\"412/image-20200607124534515.png\" style=\"zoom:50%;\" />\n\nThen, we create a `Watchpoint` , which can be seen in the `breakpoint navigator`\n\n<img src=\"412/image-20200607124622132.png\" style=\"zoom:50%;\" />\n\n## Evaluate Obj-C code in Swift frames with `expression -l objc -O -- <expr>`\n\nIn swift frames, we can't use `pointers` or private func as we do in  obj-c frames. So here comes ``expression -l objc -O -- <expr>`.  This can help use them as we do in obj-c frames.  \n\n```\n// In swift\nexpression -l objc -O -- [`self.view`  recursiveDescription]\n\n// In Obj-c \n[self.view  recursiveDescription]\n```\n\nBy using the  `command alis` , we can short cut it. \n\n```\ncommand alis poc expression -l -objc -O --\n```\n\n![image-20200607141219843](media/15902152252875/image-20200607141219843.png)\n\n\n\n## Flush view changes to the screen using â€œexpression CATransaction.flush()â€\n\n#### unsafeBitCast\n\nWe can use `unsafeBitCast`  in Swift.  To do the type cast, we have to provide the correct type. \n\nPrint its property or change its property: \n\n![image-20200607142019406](media/15902152252875/image-20200607142019406.png)\n\nUse `CATransaction.flush` to apply the view module changes to the screen's frame buffer. \n\n## Add custom LLDB commands using aliases and scripts. Alias examples:\n\n- download nudge LLDB script provided by the Apple. https://developer.apple.com/videos/play/wwdc2018/412/ \n- Add to `~/.lldbinit`\n- Add  custom alias in the lldbinit\n\n![image-20200607143100209](media/15902152252875/image-20200607143100209.png)\n\n```\ncommand alias poc expression -l objc -O --\ncommand alias flush expression -l objc -- (void)[CATransaction flush]\n```\n\n## Customizing Data Formatters\n\nhttps://developer.apple.com/videos/play/wwdc2019/429","tags":["Debug","LLDB"],"categories":["iOS"]},{"title":"Beyond \"po\"","url":"/2020/06/07/20200607-beyond-po/","content":"\n> https://developer.apple.com/videos/play/wwdc2019/429 \n\n## po command\n\nWe usually use `po` to print object description, which does the same job as `expression --object-description`. \n\n### Alias the command  \n\nWe can also use `command alias` to custom it. like \n\n`command alias my_po expression --object-description` ![img](15902187135968.jpg)\n\n### Custom the output  \n\nWe can add `debugDescription` to custom the output when using `po`\n\n![image-20200607171902758](image-20200607171902758.png)\n\n### Others jobs po can do \n\n![image-20200607172607792](image-20200607172607792.png)\n\n\n### What LLDB does behind the `Po` command\n\n![img](15902307367967.jpg?lastModify=1591521218)\n\n## p command\n\n```\np is a alias of `expression\n```\n\n![-w398](15902310620901.jpg?lastModify=1591521218)\n\nThe result of LLDB is given a increasing name, such as `$R1` and `$R2` \n\n![-w509](15902311269458.jpg?lastModify=1591521218)\n\n## Dynamic type resolution\n\n![img](15902347284185.jpg?lastModify=1591521218)\n\n> In Swift, the static representation of a type in the source code and the dynamic type at the runtime, aren't necessarily the same. For example, a variable might be declared using a protocol of this type. In this example, the static type of `cruise` is `Activity`. But at runtime, the variable will have an instance of type `Trip` which is the dynamic time. If we print the value of `cruise`, we get back an object of type `Trip` because LLDB retell results metadata to display the most accurate type for a given variable at a given program point. This is what we call `dynamic type resolution`.\n\nWith the p-command, dynamic type resolution is `only` performed on the result of the `expression`.\n\nThis happens because if you remember, LLDB compiles code where running p and the only type it sees is the one in your source code, the static one. It's the same thing as typing the expression `cruise.name` in your source code. The static compiler will reject it with an error.  ![-w1104](15902348043124.jpg?lastModify=1591521218)\n\nIf you want to evaluate the expression without errors, you need to first cast the object explicitly to its dynamic type and then access the field on the result. This is true both for the debugger and your source code.\n\n![img](15902348340793.jpg?lastModify=1591521218)\n\n### â€œpâ€ Under the Hood\n\n![img](15902348740856.jpg?lastModify=1591521218)\n\n### Formatter \n\nAfter it performed `dynamic type resolution` on the result, LLDB passes the resulting object to the `formatter subsystem` which is the part of LLDB responsible for printing a human readable description of objects.\n\n![-w850](15902349355474.jpg?lastModify=1591521218)\n\n## v Command\n\n- The output of `v` is exactly the same as `p` as it also relies on the formatter we just described.\n- `v` is just an alias we introduced in Xcode 10.2 for the `frame` variable command\n- The v-command doesn't compile and execute code at all which makes it very fast.\n\n![img](15902351819724.jpg?lastModify=1591521218)\n\n### v under the hood \n\n![img](15902354049114.jpg?lastModify=1591521218)\n\n### frame command\n\n![-w799](15902352051371.jpg?lastModify=1591521218)\n\n## po vs p vs v\n\n![-w1306](15902354519154.jpg?lastModify=1591521218)\n\n","tags":["Debug","LLDB"],"categories":["iOS"]},{"title":"Anchor point for 3D Transform in React Native","url":"/2020/05/15/20200515-react-native-anchor-point/","content":"\nIn react-native, sometimes, you may want to rotate a view basing one a specific point instead of the center of the view. Like the cube animation in the instagram stories. Some people think you need a extra `transformZ` property to achieve that. But, actually, you don't need that. What you need is `Anchor Point`. \n\n## What is Anchor Point \n\nWeb developers may be familiar with `transform-origin` in css. While in iOS, there is something similar called `anchor point`. \n\n`Anchor point` in a view is a point in the unit coordinate space, about which all geometric manipulations to the view occur. \n\n> Defines the anchor point of the layer's bounds rectangle. Animatable. \n> You specify the value for this property using the unit coordinate space. The default value of this property is (0.5, 0.5), which represents the center of the layerâ€™s bounds rectangle. `All geometric manipulations to the view occur about the specified point`. For example, applying a rotation transform to a layer with the default anchor point causes the layer to rotate around its center. Changing the anchor point to a different location would cause the layer to rotate around that new point.                -- [Apple dev](https://developer.apple.com/documentation/quartzcore/calayer/1410817-anchorpoint)\n\nBy default, the anchor point for the rotation is the center of the view. That means the rotation of a view is based on its center. Inspired by this [article](https://commitocracy.com/implementing-foldview-in-react-native-e970011f98b8#.k95f793qe), which teaches us how to rotate a view based from the origin point, I got an important clue to implement the anchor point.  \n\n### Why do we need anchor point in react-native\n\n1. Currently, there is no public API in react-native providing the ability to set `transform-origin` or `anchor-point`. So you will find it is difficult to do some fancy 3D transform animations. For example, [cube animation](https://www.npmjs.com/package/react-native-cube-transition) has some flaws: \n    - There is a gap between the views when translating views in Android \n    - The angle is not correct, less than 90 degrees, make the animation wired. It is not a cube, if you try to adjust the angle, you will break all the things. \n    - part of the view is clipped, not rendering on the screen. \n![image2020-5-27_17-17-21](https://user-images.githubusercontent.com/7471672/84166299-4c06dd00-aaa7-11ea-8c48-4e401c756767.png)\n\nActually, I use this function to solve all these issues. But it is code for company, I can't make it public. The key thing is to set anchor point as (1, 0.5) for the left view and (0, 0.5) for the right view. \n![image](https://user-images.githubusercontent.com/7471672/84166384-63de6100-aaa7-11ea-8102-9de5bee4cf18.png)\n\n2. Beside, for this foldview animation [foldview-in-react-native](https://commitocracy.com/implementing-foldview-in-react-native-e970011f98b8), one of the most import things is to use [`transformOrigin`](https://github.com/jmurzy/react-native-foldview/blob/892f89569cd851867602ce7412852515dccc7e5f/src/transformUtil.js#L3). But, this function works with `transform matrix`, and isn't easy to use. So, I made `react-native-anchor-point`. It looks simple and tricky, but actually very powerful. With it, you can use the transform API in react-native to achieve many fancy animations.\n\n\n### transformOrigin in react-native-foldview\n\n> â€œSince the transform origin of a view is at its horizontal and vertical center by default, to rotate it in x-space along the bottom, we need to first shift our viewâ€™s origin on the y-axis by 50% of the viewâ€™s height, then apply rotation, then shift it back to the original center.â€â€Šâ€”â€Š[@jmurzy](https://commitocracy.com/implementing-foldview-in-react-native-e970011f98b8)\n\nSo @jmurze implemented a [function]\n(https://gist.github.com/jmurzy/0d62c0b5ea88ca806c16b5e8a16deb6a#file-foldview-transformutil-transformorigin-js)\n\n```js\nfunction transformOrigin(matrix, origin) {\n  const { x, y, z } = origin;\n\n  const translate = MatrixMath.createIdentityMatrix();\n  MatrixMath.reuseTranslate3dCommand(translate, x, y, z);\n  MatrixMath.multiplyInto(matrix, translate, matrix);\n\n  const untranslate = MatrixMath.createIdentityMatrix();\n  MatrixMath.reuseTranslate3dCommand(untranslate, -x, -y, -z);\n  MatrixMath.multiplyInto(matrix, matrix, untranslate);\n}\n```\nHere\n-  `reuseTranslate3dCommand` in the [react-native source code](https://github.com/facebook/react-native/blob/a1ac2518a364ebcd3cc024a22229cadc1791e1c4/Libraries/Utilities/MatrixMath.js#L95), is to replace the 12th, 13th, 14th element in the matrix by parameters, z, y, z to achieve `translation` effect. \n- `reuseTranslate3dCommand` is called in [processTransform.js#L79](https://github.com/facebook/react-native/blob/a1ac2518a364ebcd3cc024a22229cadc1791e1c4/Libraries/StyleSheet/processTransform.js#L79), in which, RN generates a transform matrix based on `transform object` we provide. \n[https://github.com/facebook/react-native/blob/a1ac2518a364ebcd3cc024a22229cadc1791e1c4/Libraries/StyleSheet/processTransform.js#L43]\n\n### What `transformOrigin` does is to\n\n```\n1. translate the view by x, y, z on the x-axis, y-axis, z-axis \n2. apply rotation\n3. translate the view back by -x, -y, -z on the x-axis, y-axis, z-axis \n```\n\n\n### Plain Code\n\nAfter understanding the above things, we know we can can use `transform` style to set the anchor point. For example, the following code sets the anchor point of the view as (0, 0.5). This will make the rotate base on the left side of the view. \n\n```javascript\n   const transform = {\n      transform: [\n          {translateX: -w / 2}, \n          rotateY, \n          {translateX: w / 2}\n      ]\n    }\n    return (   \n        <Animated.View style={transform}></Animated.View>\n    )\n  }\n\n```\n![](./d32bef61.png)\n\nRemember that RN generates only one single transform matrix, based on `transform object` we provide, [here](https://github.com/facebook/react-native/blob/a1ac2518a364ebcd3cc024a22229cadc1791e1c4/Libraries/StyleSheet/processTransform.js#L43). So, finally, the above code will be converted into a transform matrix, with which the rendering system can render a view with a given layout and shape.  There are some transform matrix knowledge involved. [ref: tutorial-3-matrices](http://www.opengl-tutorial.org/beginners-tutorials/tutorial-3-matrices/)\n\n\n## react-native-anchor-point\n\nIn this [package](https://github.com/sueLan/react-native-anchor-point), I provides a function `withAnchorPoint`, to inject the above code into your `transform` object. It works well with the original way you use transform and. So, you don't have to use `ref` to set the `transformOrigin` any more. This would make the `3d transform` in React Native easier to implement. \n\n![](./rotateZ.gif)\n![](./rotateXY.gif)\n![](./rotate.gif)\n\nAnd it works well with the react-native `transform` API \n\n```\nimport { withAnchorPoint } from 'react-native-anchor-point';\n\ngetTransform = () => {\n    let transform = {\n        transform: [{ perspective: 400 }, { rotateX: rotateValue }],\n    };\n    // inject the anchor point here\n    return withAnchorPoint(transform, { x: 0.5, y: 0 }, { width: CARD_WIDTH, height: CARD_HEIGHT });\n};\n    \n<Animated.View style={[styles.blockBlue, this.getTransform()]} />\n```\n\n## Ref\n\n- [Matrices](http://www.opengl-tutorial.org/beginners-tutorials/tutorial-3-matrices/)\n- [react-native-foldview](https://github.com/jmurzy/react-native-foldview)\n- [RN How to set the anchor point of a view.](https://stackoverflow.com/a/60632809/4026902)\n- https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/geometry/geo-tran.html\n","tags":["Popular Article","Animation"],"categories":["React Native"]},{"title":"Work with Wider Color","url":"/2020/05/09/20190509-Work-with-Wider-Color/","content":"\n\n# Work with Wider Color \nhttps://developer.apple.com/videos/play/wwdc2016/712\n\n## Basic concepts about color\n\n### What is Color Space \n\n> A color space is a specific organization of colors. In combination with physical device profiling, it allows for reproducible representations of color, in both analog and digital representations.            --- Wiki\n\n![](media/15884935782947/15884941050187.jpg)\n\nThis is the standard RGB space, which is the default color space in iOS. \n\n#### Color Primaries\n> Color primaries generally fall at the most intense value that you can get with that particular color channel.\n\nLike, in sRGB space, the color primaries are \n> RGB {0.0, 0.0, 0.0} = Black \nRGB {1.0, 1.0, 1.0} = White \nRGB {1.0, 0.0, 0.0} = Red\n\n#### Color gamut \n  All of the colors that can be defined as a combination of those individual color channels. \n\n\n## Display P3 \n\n\n![](media/15884935782947/15885097554778.jpg)\n\nIn the above image, the colored region represents the outer limits of perception in a human's color vision. \n\nThe inner black triangle represents sRGB's limits of presentation.\nIn contrast, the DCI-P3 standard, and the Wide Color implementation, has a larger area underneath the triangle, representing the greater array of displayable color possible.\n\n- 16bit per color channel for P3 and beyond \n\n### Extended Range sRGB \n\n- Display P3\n    - {1.0, 0.0, 0.0}\n- Extended Range sRGB\n    - {1.358, -0.074, -0.012}\n## Wider Color \n                        \n                        \n> Wide color displays support a P3 color space, which can produce richer, more saturated colors than sRGB. As a result, photos and videos that use wide color are more lifelike, and visual data and status indicators that use wide color are more impactful.\n\n\n## Color Management \n\nApplication Content Types\n- Static image resources\n- Document and network image resources\n- Advanced Media\n- GPU Textures\n\nFraming the Color Problem\n- App Content can come in a broad range of color richness from many sources Devices and \n- Displays come in a broad range of color capabilities\n\n### How do we bridge the differences?\n\nThe answer is color management. \n\n> The job of color management is to ensure that an image looks the same on any output device no matter what color space it is encoded in.\n\n### How does it work?\n\n- Every image has an associated color space (color profile)\n- Color matching maps image colors to output device\n    - ![](media/15884935782947/15885122964828.jpg)\n\n- Not for free: Every pixel needs to be color matched\n- Potentially lossy: Color fidelity is lost when output has smaller gamut. For example, going down from P3 color space to sRGB color space. \n\nOpti in System: \n\n- Color matching operations are easily hardware accelerated\n\n- Color matching operations are easily hardware accelerated\n- Properly tagged content requires no code to display properly\n\n## Design Considerations for Wide Gamut \n\n- Use wide gamut content where it makes sense\n- Use where vivid colors enhance the user experience\n- No need to change all content to P3\n- Toolchain support makes gradual opt-in of wide gamut content possible\n\n## Upgrading Content to Wide Color\n\nBe careful when promoting an existing design file to wide color! \n- Donâ€™t â€œassignâ€ P3 profile. It just remaps the existing color information into new color space. The colors are stretched, and the design file will be inevitably altered. \n- Convert to P3 instead\n\n\n## Tools \n ![](media/15884935782947/15885134344507.jpg)\n\n## Color Specification \n\nWhen communicating with designers, Be specific about color space!\n\n- Use Display P3 instead of sRGB when working with wide gamut designs\n\n- Use floating point for more precision\n> P3 (255, 128, 191) \n> P3 (1.0, 0.5, 0.75)\n\n## Drawing colors \n\n### Constructing Wide Gamut Colors \n\n```swift\nNSColor(displayP3Red: 1.0, green: 0.0, blue: 0.0, alpha: 1.0) â€¨\nUIColor(displayP3Red: 1.0, green: 0.0, blue: 0.0, alpha: 1.0)\n\n```\n### Constructing Extended Range sRGB Colors\n```swift \nNSColor(red: 1.1, green: -.25, blue: 0.0, alpha: 1.0) â€¨\nUIColor(red: 1.1, green: -.25, blue: 0.0, alpha: 1.0)\n\n```\n\n\n### Rendering \nOptimizing your appâ€™s drawing for wide gamut displays\n\nâŒ Don't use `UIGraphicsBeginImageContext`. It doesn't support wider color. \n\n> The format for the bitmap is a ARGB 32-bit\n>  integer pixel format using host-byte order\n\n`UIGraphicsBeginImageContext` not only cannot create contexts with more than 8 bits per color channel, but also cannot represent colors in extended range sRGB. Sadlly, existing interface has no ability to create a context in non-sRGB color space. \n\nSo, they introduce `UIGraphicsImageRenderer(size: CGSize)` \n\n```swift \n\nlet renderer = UIGraphicsImageRenderer(size: CGSize(width: 250, height: 250))\nlet image =  renderer.image { rendererContext in\n    let bounds = rendererContext.format.bounds\n    let rects = bounds.divided(atDistance: bounds.size.width/2, from: .minXEdge)\n    \n    UIColor(displayP3Red: 1.0, green: 0.0, blue: 1.0, alpha: 1.0).set()\n    rendererContext.fill(rects.slice)\n    \n    UIColor(red: 1.0, green: 0.0, blue: 1.0, alpha: 1.0).set()\n    rendererContext.fill(rects.slice)\n}\n```\n\n- Fully color managed by default\n- Supports extended range sRGB color space\n- Manages CGContext lifetime\n\n\n### Draw \n\n`UIView`, `UIImageView`, Color managed since iOS 9.3 \n```swift \ndraw(_ rect: CGRect) // called in the extended sRGB color space\n```\n\nFor `UIView`, use the viewâ€™s layerâ€™s `contentsFormat` property\n\nValid CALayer contents formats:\n- kCAContentsFormatRGBA8Uint\n- kCAContentsFormatRGBA16Float\n- kCAContentsFormatGray8Uint","tags":["WWDC","Image"]},{"title":"iOS images in memory","url":"/2020/05/03/iOS-images-in-memory/","content":"\n> Notes for [wwdc2018/219](https://developer.apple.com/videos/play/wwdc2018/219) and [wwdc2018/416](https://developer.apple.com/videos/play/wwdc2018/416/)\n\n## Why memory and CPU matter? \n![](media/15884695669510/15888626848016.jpg)\n\n\n- It is obvious that too much usage of `CPU` has negative impact on `battery life` and `responsiveness`.  \n- But, if you application consumes too much memory, that causes more `CPU utilization`, which have negative effects on `battery life` and `performance`.\n\n## Basic Concepts \n\n### Buffers \n> Buffer is contiguous region of memory. \nIt is often viewed as sequence of elements of the same sizes, usually of the same internal construction. \n\n![-w354](media/15884695669510/15888596565806.jpg)\n\n\n\n#### Image Buffers \n\n> One kind of the important buffers is the `Image Buffer`, which holds the `in-memory representation of some image`. \n\nEach element in image buffers describes the color and the transparency of single pixel in our image. Constantly, the buffer size is proportional to image size. For example, in the image with sRBG format, each 32 bits describes the color and transparency of a single pixel. `The buffer size =  4 byte  x image_width x image_height`\n\n\n\n![-w452](media/15884695669510/15888600604360.jpg)\n\n#### Frame buffer \n\n> The frame buffer is what holds the actual rendered output of your application.  \n\nAs your application updates its view hierarchy UIKit will render the application's `window` and all of its `subviews` into the `frame buffer`. And that frame buffer provides per pixel color information that the `display hardware` will read in order to illuminate the pixels on the display.\n\n[Related resource: The View Drawing Cycle](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/ViewPG_iPhoneOS/WindowsandViews/WindowsandViews.html#//apple_ref/doc/uid/TP40009503-CH2-SW10)\n\nThe pipeline is like this: \n\n![](image_graphic.gif)\n\n#### Data Buffer\n\n> a data buffer is just a buffer that contains a sequence of bytes. \n\nIf we've downloaded images from the network or we've `loaded` them from disk. A data buffer that contains an image file, typically, begins with some metadata describing the size of the image that's stored in that data buffer.\n\n![-w397](media/15884695669510/15888655020412.jpg)\n\n- Store contents of an `image file` in memory. The `size` is the same as that in the image file in the disk. \n- Metadata describing dimensions of image\n- Image itself `encoded` as JPEG, PNG, or other (usually compressed) form\n- Bytes `do not `directly describe pixels\n\n\n### The Pipeline in Action \n\n![-w834](media/15884695669510/15890026431784.jpg)\n\n\n## Consequences of Excessive Memory Usage \n\n- Increased fragmentation. \n    - `fragment` : The large allocation that is in your application's address space could force other related content apart from content that it wants to reference.\n- Poor locality of reference\n- System starts `compressing` memory Process termination\n    - Eventually, if your application starts accumulating a lot of memory usage the operating system will step in and start transparently `compressing` the content of physical memory. Now, the CPU needs to be involved in this operation so in addition to any CPU usage in your own application. You could be `increasing global CPU usage` that you have no control over. Eventually, your application could start consuming so much physical memory that the OS needs to start `terminating processes`. And it'll start with background processes of low priority.\n\n- You app may be terminated by the system\n- Cause `CPU peak`, and then has negative impact on battery life and responsiveness.\n\n## Decoding \n\n> Decoding is an operation that will convert the JPEG or PNG or other encoded image data into per pixel image information. \n\n- CPU-intensive process\n\n- The memory used for the image buffer is proportional to original image size, not view size. \n- There are persistent large memory allocation in decoding.\n- The image buffer is retained for repeat rendering by UIImage. \n\nAfter decoding, UIImage will hang onto that image buffer, so that it only does that work once. Consequently, your application, for every image that gets decoded, could have a persistent and large memory allocation hanging out.\n\n## The memory use of an image using sRGB space\n\n> Memory use is related to the dimensions of the images, not the file size.\n\nTake the following image as an instance, its file size is 590KB, with dimension 2048 x 1536 pixel.\n![83dca9cf.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/83dca9cf.png)\n\n\n### 4 byetes for each pixel in RGBA \n\nBy this [article](https://www.objc.io/issues/3-views/moving-pixels-onto-the-screen/), each pixel in sRGB image needs 32bit, 4 bytes, in memory when it's decoded. Because in sRGB, there are Red, Green, Blue 3 channels and Alpha. The range of each channel value is from 0 to 255, which needs 8 bits to represent the value. \n\n```\n  A   R   G   B   A   R   G   B   A   R   G   B  \n | pixel 0       | pixel 1       | pixel 2   \n  0  233  2  100  4  155 255  7   8   9   10  11 \n```\n  \n\n### More memory usage when decoding a image \n\nA image have load -> decode -> render these 3 phases.  \n\n![64aaa3cd.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/ed4e1c96.png)\n\n\n\nWe only need 590KB to load a image, while we need \n`2048 pixels x 1536 pixels x 4 bytes per pixel` = 10MB when decoding \n  \n\n\n##  Image Rendering Pipeline \n\n- `UIImage` is responsible for loading image content. Usually, it is bigger than the ImageView that is going to display it. \n- `UIImageView` is responsible for displaying the image. The image which it is going to display will be shrink down to fit its size. \n ![](media/15884695669510/15889026761062.jpg)\n\n\n## Downsampling\nSo, we can use technique, called Downsampling, to `downsample` the images to `the size that they're going to be displayed`. Rather than having these large allocations hanging around, we're reducing our memory usage.\n\n![-w1333](media/15884695669510/15889088392417.jpg)\n\n```swift \n// Downsampling large images for display at smaller size\nfunc downsample(imageAt imageURL: URL, to pointSize: CGSize, scale: CGFloat) -> UIImage {\n    // ShouldCache flag tells Core Graphics framework that we're just creating an object to\n    // represent the infomation stored in the file at this URL\n    let imageSourceOptions = [kCGImageSourceShouldCache: false] as CFDictionary\n    let imageSource = CGImageSourceCreateWithURL(imageURL as CFURL, imageSourceOptions)!\n    let maxDimensionInPixels = max(pointSize.width, pointSize.height) * scale\n    let downsampleOptions =\n        // Ask the Core Graphics to create the decoded image buffer for me when calling it to create the thumbnail\n        [kCGImageSourceCreateThumbnailFromImageAlways: true,\n        kCGImageSourceShouldCacheImmediately: true,\n        // Should include kCGImageSourceCreateThumbnailWithTransform: true in the options dictionary. Otherwise, the image result will appear rotated when an image is taken from camera in the portrait orientation.\n        kCGImageSourceCreateThumbnailWithTransform: true,\n        kCGImageSourceThumbnailMaxPixelSize: maxDimensionInPixels] as CFDictionary\n    let downsampledImage =\n        CGImageSourceCreateThumbnailAtIndex(imageSource, 0, downsampleOptions)!\n    return UIImage(cgImage: downsampledImage)\n}\n```\n\n## Decoding in ScrollViews \n### The cause of the ScrollView hitch \n\n![-w1178](media/15884695669510/15889147842616.jpg)\n\n\n> When beginning scrolling, we're about to display another row of images. And we're about to ask Core Graphics to `decode` those images before we hand the cells back to UICollectionView.\nAnd that could take `a lot of CPU time`. So much so, that we `don't` get around to `re-rendering the frame buffer`. But the `display hardware` is operating on a `fixed interval`. So, from the user's perspective the application has just `stuttered`. Now, we're done decoding these images, we're able to provide those cells back to UICollectionView. And animation continues on, as before. Just saw a `visual hitch`, \n\n## Two techniques to smooth out CPU usage \n\n1. prefetching \n2. performing work in the background\n\n### Thread Explosion \nIt is caused by \n- More images to decode than available CPUs \n- GCD continues creating threads as new work is enqueued\n- Each thread gets less time to actually decode images\n\n\n> Now, to avoid deadlock when we dispatch asynchronously to a global queue, GCD is going to create new threads to capture the work we're asking it to do. And then, the CPUs are going to spend a lot of time moving between those threads to try and make incremental progress on all of the work we asked the operating system to do for us. And switching between those threads, actually, has a pretty significant overhead.\n\n\nwe're going to serialize some work.\n\nSo, rather than simply dispatching work to one of the global asynchronous queues, we're going to create a serial queue. And inside of our implementation of the prefetch method we're going to asynchronously dispatch to that queue.\n\n![-w1516](media/15884695669510/15889150745604.jpg)\n\n## Image Sources \n\nImages may come from \n- Image assets in asset catalog\n- Files in application/framework bundle\n- Files in Documents and Caches directories \n- Data downloaded from network\n\nThis session suggests us to use image assets for the following reasons: \n\n- Optimized name- and trait-based lookup\n   - It's `faster` to `look up` an image asset in the asset catalog, than it is to search for files on disk that have a certain naming scheme. \n\n- Smarter buffer caching\n    - The asset catalog runtime has, also, got some really good smarts in it for managing `buffer sizes`.\n\n- Per-device thinning\n   - your application only downloads image resources that are relevant to the device that it's going to run on and vector artwork. The \n\n- Vector artwork\n\n## Vector artwork\n\n- Since iOS 11, image assets supportâ€¨ â€œPreserve Vector Dataâ€\n- Avoids blurriness and aliasing when drawn larger or smaller than natural size\n\n\n\n## Image Rendering Format \n\n### SRGB\n- 4 bytes per pixel \n- full color images \n- most common used \n![a1bf604b.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/a1bf604b.png)\n\n### Wide format \n\n- 8 bytes per pixel \n- super accurate colors. Because they use 8bytes, 16 bits, for each channel. In the meantime, double the image size.  \n- Only useful with wide color display. We don't want to use it when we don't need to. \n- Wide color capture cameras since iPhone 7\n  \n\n![75a1a01e.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/75a1a01e.png)\n\n### Luminance and alpha 8 format\n\nThis image only holds grayscale value. And the image size is smaller. \n\n- 2 bytes per pixel \n- Single-color iamges and alpha\n- Most used in Metal shaders, not very common. \n![6383b177.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/6383b177.png)\n### Alpha 8 Format \n\n- 1 byte per pixel \n- Userful for monochrome images because it uses less memory. \n  - masks \n  - Emoji-free text \n- 75% smaller than SRGB\n\n![753920b5.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/753920b5.png)\nWe can also change `image.tintColor` in this image without changing its format.  \n\n## How do I pick the right format?\n\n`UIGraphicsBeginImageContextWithOptions` always uses SRGB rendering-format, which use 4 bytes per pixel. \n\nwhile `UIGraphicsImageRenderer`, which introduced in iOS 10 will automatically pick the best graphic format in iOS12. It means, you will save 75% of memory by replacing `UIGraphicsBeginImageContextWithOptions` with  `UIGraphicsImageRenderer`\n\n\n**Do** âœ…\n\n![2f0229d3.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/2f0229d3.png)\n## Use ImageIO to downsample images\n\n`UIImage` is expensive for sizing and to resizing\n- Will decompress original image into memory \n- Internal coordinate space transforms are expensive\n\n**Don't** âŒ\n\n \n![c25d45de.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/c25d45de.png)\n\nUse ImageIO\n- ImageIO can read image sizes and metadata information without dirtying memory.\n\n- ImageIO can resize images at cost of resized image only.\n\n**Do** âœ…\n![922ac245.png](28bfb5ac-c3fa-4575-a1b1-72fcbacc9069/922ac245.png)\n\nThe bad is that you have to specify some options. \n\n## Resize image effectively\n\nThis is a function of resizing image without reading it into the memory, using ImageIO.  \n\n```swift\nfunc resize(url: NSURL, maxPixelSize: Int) -> CGImage? {\n    let imgSource = CGImageSourceCreateWithURL(url, nil)\n    guard let imageSource = imgSource else {\n        return nil\n    }\n\n    var scaledImage: CGImage?\n    let options: [NSString: Any] = [\n            // The maximum width and height in pixels of a thumbnail.\n            kCGImageSourceThumbnailMaxPixelSize: maxPixelSize,\n            kCGImageSourceCreateThumbnailFromImageAlways: true,\n            // Should include kCGImageSourceCreateThumbnailWithTransform: true in the options dictionary. Otherwise, the image result will appear rotated when an image is taken from camera in the portrait orientation.\n            kCGImageSourceCreateThumbnailWithTransform: true\n    ]\n    scaledImage = CGImageSourceCreateThumbnailAtIndex(imageSource, 0, options as CFDictionary)\n\n    return scaledImage\n}\n\n\nlet filePath = Bundle.main.path(forResource:\"large_leaves_70mp\", ofType: \"jpg\")\n\nlet url = NSURL(fileURLWithPath: filePath ?? \"\")\n\nlet image = resize(url: url, maxPixelSize: 600)\n```\n\n## Optimizing when in the background\n\n### foreground/background\n\nThe strategy is simple, when `UIApplicationDidEnterBackground`, we unload images; and when `UIApplicationWillEnterForeground`, load images. \n\n\n### on-screen/off-screen \n\nunload large resource when off-screen, `viewDidDisappear`; and load large resource when on-screen, `viewWillAppear`. \n\n## Debug \n\nUse memory graphs to further understand and reduce memory footprint\n\n\n## Ref \n\n- [An great example of how to use command line tools to find root cause of an image memory issue.](https://developer.apple.com/videos/play/wwdc2018/416/)  \n\n## Related \n\n- [An-glimpse-of-iOS-Memory-Deep-Dive](https://suelan.github.io/2020/05/03/An-glimpse-of-iOS-Memory-Deep-Dive/)\n- [Work with Wider Color ](https://suelan.github.io/2020/05/09/20190509-Work-with-Wider-Color)","tags":["Image","Debug","Memory"],"categories":["iOS"]},{"title":"A glimpse of iOS Memory Deep Dive","url":"/2020/05/03/An-glimpse-of-iOS-Memory-Deep-Dive/","content":"\nThis is an pretty good session about iOS memory. [iOS Memory Deep Dive - WWDC 2018 - Videos - Apple Developer](https://developer.apple.com/videos/play/wwdc2018/416/). I saw it and took some notes here. \n\n> Not all memory is created equal. \n\nThere are dirty memory, clean memory, compressed memory in iOS system. We have to know the differences between them. \n\n## Page  \n\nPage is typically 16KB in size and operating system gives it to you when your app requests memory.  \n\n```\nmemory in use = number of pages x page size \n```\n\n![b576f28d.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/b576f28d.png)\n\nSome pages can hold multiple objects, and some objects\ncan span multiple pages. \n\n\n\n### Pages Types \n  - Clean\n    - Data that can be paged out of memory\n    - Memory mapped files\n    - frameworks*\n     \n  - Dirty \n    - memory written by an app \n    - all heap allocations\n    - decoded image buffers\n  - Comporessed \n\n> There is no traditional disk swap in iOS \n\n\n## Memory compressor \n\nThe system will do the compression and decompression for you by memory compressor.\n\nWhat does Memory compressor do? \n\n- Compresses unaccessed pages \n- Decompresses pages upon access\n\n\nBefore being compressed: \n\n\n![cdb635fb.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/cdb635fb.png)\n\nAfter being compressed: \n![8b7d45fa.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/8b7d45fa.png)\n\n\nWhen you got Memory warning, you App is not always the cause. Maybe because the compressor freeing memory. Like, you receiving a phone call while using the App.\n\nAfter being decompressed: \n\n![f0910e00.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/f0910e00.png)\n\nAfter removing objects in `didReceiveMemoryWarning` \n\n\n![28bedf77.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/28bedf77.png)\n\n## Caching \n\n- Trade-offs between CPU and memory. Caching can reduce the CPU usage and time complexity, but it costs memory. \n- Remember the compressor. When decompressing, the used memory will be increased.\n- Prefer NSCache over dictionary. \n\n\n## Memory Profile \n\nIt is the dirty size + the compressed size that the system uses to determine how much memory the app is really using. \n\nWe should mainly focuse on these two part, dirty and compressed memory when analyzing the memory profile.  \n![8af52c4f.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/8af52c4f.png)\n\n\n\n## Tools for Profiling Footprint \n\n1. Xcode memory gauge\n  ![447accd0.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/447accd0.png)\n  \n2. Instruments\n- Allocations \n- Leaks \n- VM Tracker \n  - providing profiles for dirty and compressed memories. \n  - ![69341a61.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/69341a61.png)\n- Virtual memory trace \n  - ![1ca65c7e.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/1ca65c7e.png)\n3. Debugger \n ![cd78fa8b.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/cd78fa8b.png)\n4. memory graph \n\n![af606628.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/af606628.png)\n\n## working with memory graph using commands\n\n\n### vmmap \n\n\n\n`vmmap` helps to show some dirty memory info of your app. In general, we should look for the big number for the size. \nThere are `virtual size`, `resident size`, `dirty size`, `swapped size` columns here. \n\nAccording to this [session](https://developer.apple.com/videos/play/wwdc2018/416/), we can ignore the `virtual size`, because it is memory requested by the app, while not neccessarily be used.  `swapped size` is related to compressed memory. So we should care more about `dirty size` and `swapped size`.\n\n#### An example of using vmmap to debug a memory issue\n\nFirst, we can use summary info to look for the big numbers in `virtual size` and `swapped size` colomn. Here, we find `CG Image` takes much more memory than others. \n\n\n```\nvmmap --summary PlanetPics.memgraph\n```\n![d58088d1.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/d58088d1.png)\n\n\nThen, we use `grep` to get more info about `CG Image`. \n![751c8f78.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/751c8f78.png)\n\nThere are  two regions here, the last row is summary info. The secong CG Image region takes more takes more dirty and swapped memory. So we have to see more infomation of this region by using `--verbose` option.\n\nAll these commands can work with other shell commands, like redirecting the output stream a `output.txt` file. \n\n\n```\nvmmap --verbose PlanetPics.memgraph | grep \" CG image\" | > output.txt\n```\n![14c0b2ff.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/14c0b2ff.png)\n\n\n\nAnd we will more regions.   \n\n> It turns out that vmmap, by default, if it finds contiguous regions, it collapses. A general rule. the later region was created, the later my app's life cycle it happened. Chance are this later region is more closely tied to whatever caused that memory pike. \n\nSo, we start to look at the last region. We can use the start memory address of the last region and search it in the memory graph in XCode.\n\n![5d389834.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/5d389834.png)\n\nOr use `leak` to get the trace tree. By scanning these info, we would find more clues. \n\n![f63287f5.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/f63287f5.png)\n\nHere, using `malloc_history` to see the back trace for this object, we found the related code creating this particular VM memory. \n\n![d8143352.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/d8143352.png)\n\n\n1. vmmap and AWK\n\nThis command can work with other commands. \n![bca9bf95.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/bca9bf95.png)\n\n### leak \n\n```\nleaks App.memgraph\n```\nIt not only shows the cycle, but also the root object of the cycle. \n\n- leak circle\n![21107588.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/21107588.png)\n\n- root object\n![fbc1d8bb.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/fbc1d8bb.png)\n\n### heap \n\n- Shows objects allocated on the heap; \n- useful for indentifying large objects in memory adn what allocated it. \n```\nheap App.memgraph\nheap App.memgraph -addresses all | <classes-pattern>\n```\n\n`heap` command shows the class name  in `CLASS_NAME` column, the num of the class in `COUNT` column, the average size of the object  in the `AVG` column, the total size in the `BYTES` column. \n\n\n```\nheap App.memgraph -sortBySize | > ~/output.txt\n```\n\n\n![b0766b6a.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/b0766b6a.png)\n\n\n### malloc_history\n\nIn some cases, we not only want to know the memory size, but also want to know the how it created. So, here comes the `malloc_history` command.\n\n- enable the malloc_stack logging\n\n![1153a225.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/1153a225.png)\n\n\n```\nmalloc_history App.memgraph [address]\n```\n\n\n![a70d0d43.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/a70d0d43.png)\n\n### Which tool to pick \n\n![d68340ee.png](f30bdfea-25ac-4eb9-af3e-278a74a85022/d68340ee.png)\n\n\nUse `vmmap` and `heap` to find some objects or regions with big number,  use `leak` to see references between objects, like finding circular reference; use `malloc_history` to see how it is created.  \n\n## Related: \n\n- [iOS-images-in-memory](https://suelan.github.io/2020/05/03/iOS-images-in-memory/)","tags":["WWDC","Image","Debug","Memory"],"categories":["iOS"]},{"title":"How to inspect network activities of your iOS application","url":"/2020/04/25/How-to-inspect-network-activity-of-your-iOS-applicatoin/","content":"\nRecently, Facebook launched [Flipper](https://github.com/facebook/flipper), A desktop debugging platform for mobile developers.  And there is an embedded network plugin, `FlipperKitNetworkPlugin` ,  which works as an inspector of network activities in our application. Let's figure out how it can achieve that. \n\n## Overview \n\nHere comes the class diagram of this network plugin. \n\n![class](class.png)\n\nIn these classes, `FLEXNetworkObserver` is the key one for this plugin. \n\nWhen the plugin starts, it will inject all the `NSURLConnectionDelegate` classes and functions to observe the remote request and response event. \n\n## Swizzle \n\nThe key idea is to swizzle any classes that implement one of the selectors in `URLSession` and `NSURLConnectionDelegate` , and get chance to get the request and response data. \n\nThe process is like this: \n\n1. find out selectors in `URLSession` and `NSURLConnectionDelegate`  which are related to network activities. \n2. Retrieve all the class definitions that have been registered with the Objective-C runtime. The Objective-C runtime library automatically registers all the classes defined in your source code. \n3. Find any class that implements one of the above selectors\n4. Inject this class\n    \n\n\n```objective-c\n+ (void)injectIntoAllNSURLConnectionDelegateClasses {\n  // Only allow swizzling once.\n  static dispatch_once_t onceToken;\n  dispatch_once(&onceToken, ^{\n    // 1. ðŸŒŸ Swizzle any classes that implement one of these selectors.  \n   const SEL selectors[] = {\n      @selector(connectionDidFinishLoading:),\n      @selector(connection:willSendRequest:redirectResponse:),\n      @selector(connection:didReceiveResponse:),\n      @selector(connection:didReceiveData:),\n      @selector(connection:didFailWithError:),\n      @selector\n      (URLSession:\n             task:willPerformHTTPRedirection:newRequest:completionHandler:),\n      @selector(URLSession:dataTask:didReceiveData:),\n      @selector(URLSession:dataTask:didReceiveResponse:completionHandler:),\n      @selector(URLSession:task:didCompleteWithError:),\n      @selector(URLSession:dataTask:didBecomeDownloadTask:),\n      @selector(URLSession:\n              downloadTask:didWriteData:totalBytesWritten\n                          :totalBytesExpectedToWrite:),\n      @selector(URLSession:downloadTask:didFinishDownloadingToURL:)\n    };\n\n    const int numSelectors = sizeof(selectors) / sizeof(SEL);\n\n    // 2. ðŸŒŸ Retrieve all the class definitions that have been registered with the Objective-C runtime. The Objective-C runtime library automatically registers all the classes defined in your source code. \n \n    Class* classes = NULL;\n    // 2.1 ðŸŒŸ You can pass NULL to obtain the total number of registered class definitions without actually retrieving any class definitions.\n    int numClasses = objc_getClassList(NULL, 0);\n\n    if (numClasses > 0) {\n        // 2.2 ðŸŒŸ An array of Class values. Each Class value points to one class definition\n      classes = (__unsafe_unretained Class*)malloc(sizeof(Class) * numClasses);\n      numClasses = objc_getClassList(classes, numClasses);\n      // 3. ðŸŒŸ Find any class that implements one of the above selectors\n      for (NSInteger classIndex = 0; classIndex < numClasses; ++classIndex) {\n        Class className = classes[classIndex];\n\n        if (className == [FLEXNetworkObserver class]) {\n          continue;\n        }\n\n        // Use the runtime API rather than the methods on NSObject to avoid\n        // sending messages to classes we're not interested in swizzling.\n        // Otherwise we hit +initialize on all classes. NOTE: calling\n        // class_getInstanceMethod() DOES send +initialize to the class. That's\n        // why we iterate through the method list.\n        unsigned int methodCount = 0;\n        Method* methods = class_copyMethodList(className, &methodCount);\n        BOOL matchingSelectorFound = NO;\n        for (unsigned int methodIndex = 0; methodIndex < methodCount;\n             methodIndex++) {\n          for (int selectorIndex = 0; selectorIndex < numSelectors;\n               ++selectorIndex) {\n            // Find a target method in this class \n            if (method_getName(methods[methodIndex]) ==\n                selectors[selectorIndex]) {\n              // 4. ðŸŒŸ Inject this class  \n              [self injectIntoDelegateClass:className];\n              matchingSelectorFound = YES;\n              break;\n            }\n          }\n          if (matchingSelectorFound) {\n            break;\n          }\n        }\n        free(methods);\n      }\n\n      free(classes);\n    }\n\n    [self injectIntoNSURLConnectionCancel];\n    [self injectIntoNSURLSessionTaskResume];\n\n    [self injectIntoNSURLConnectionAsynchronousClassMethod];\n    [self injectIntoNSURLConnectionSynchronousClassMethod];\n\n    [self injectIntoNSURLSessionAsyncDataAndDownloadTaskMethods];\n    [self injectIntoNSURLSessionAsyncUploadTaskMethods];\n  });\n}\n```\n\nFor example, how to inject `connection:willSendRequest:redirectResponse:`?\n\n```objective-c \n\n+ (void)injectWillSendRequestIntoDelegateClass:(Class)cls {\n  SEL selector = \n  @selector(connection:willSendRequest:redirectResponse:);\n  // Â ðŸŒŸ Selector with `_flex_swizzle_` prefix\n  SEL swizzledSelector = [FLEXUtility swizzledSelectorForSelector:selector];\n\n  Protocol* protocol = @protocol(NSURLConnectionDataDelegate);\n  if (!protocol) {\n    protocol = @protocol(NSURLConnectionDelegate);\n  }\n  // ðŸŒŸ Get the original method description\n  struct objc_method_description methodDescription =\n      protocol_getMethodDescription(protocol, selector, NO, YES);\n\n  typedef NSURLRequest* (^NSURLConnectionWillSendRequestBlock)(\n      id<NSURLConnectionDelegate> slf,\n      NSURLConnection* connection,\n      NSURLRequest* request,\n      NSURLResponse* response);\n\n  // ðŸŒŸ If selector `connection:willSendRequest:redirectResponse:` is not a instance method in this class, use this block as the implementation for swizzledSelector\n  NSURLConnectionWillSendRequestBlock undefinedBlock = ^NSURLRequest*(\n      id<NSURLConnectionDelegate> slf,\n      NSURLConnection* connection,\n      NSURLRequest* request,\n      NSURLResponse* response) {\n    [[FLEXNetworkObserver sharedObserver] connection:connection\n                                     willSendRequest:request\n                                    redirectResponse:response\n                                            delegate:slf];\n    return request;\n  };\n\n  // The implementation for swizzledSelector\n  NSURLConnectionWillSendRequestBlock implementationBlock = ^NSURLRequest*(\n      id<NSURLConnectionDelegate> slf,\n      NSURLConnection* connection,\n      NSURLRequest* request,\n      NSURLResponse* response) {\n    __block NSURLRequest* returnValue = nil;\n    [self sniffWithoutDuplicationForObject:connection\n        selector:selector\n        sniffingBlock:^{\n          undefinedBlock(slf, connection, request, response);\n        }\n        originalImplementationBlock:^{\n          returnValue = ((id(*)(id, SEL, id, id, id))objc_msgSend)(\n              slf, swizzledSelector, connection, request, response);\n        }];\n    return returnValue;\n  };\n  // Swizzle; \n[FLEXUtility replaceImplementationOfSelector:selector\n                                  withSelector:swizzledSelector\n                                      forClass:cls\n                         withMethodDescription:methodDescription\n                           implementationBlock:implementationBlock\n                                undefinedBlock:undefinedBlock];\n}\n```\n\nThen, replace the original implementation of `connection:willSendRequest:redirectResponse:` method with flipper's own implementation for `swizzledSelector`. \n\n```objective-c \n\n+ (void)replaceImplementationOfSelector:(SEL)selector\n                           withSelector:(SEL)swizzledSelector\n                               forClass:(Class)cls\n                  withMethodDescription:\n                      (struct objc_method_description)methodDescription\n                    implementationBlock:(id)implementationBlock\n                         undefinedBlock:(id)undefinedBlock {\n  if ([self instanceRespondsButDoesNotImplementSelector:selector class:cls]) {\n    return;\n  }\n  \n  // The implementation for swizzledSelector\n  IMP implementation = imp_implementationWithBlock((id)(\n      [cls instancesRespondToSelector:selector] ? implementationBlock\n                                                : undefinedBlock));\n\n  Method oldMethod = class_getInstanceMethod(cls, selector);\n  if (oldMethod) {\n    // Add new method to the class, whose signature has `_flex_swizzle_` prefix and custom implementation \n    class_addMethod(\n        cls, swizzledSelector, implementation, methodDescription.types);\n\n    Method newMethod = class_getInstanceMethod(cls, swizzledSelector);\n\n    method_exchangeImplementations(oldMethod, newMethod);\n  } else {\n    class_addMethod(cls, selector, implementation, methodDescription.types);\n  }\n}\n\n```\n\nThe activity diagram for the above code  might be this,\n![activity](activity_swizzle.png)\n\n## Observer and Record\n\nIf there is an network activity, a use calls `connection:willSendRequest:redirectResponse:delegate:` \nor `connection:didReceiveResponse:delegate` is called in an object adopting `NSURLConnectionDelegate` protocol. In fact, its original implementations have been replaced. And Flipper's own implementations for these two selector are called, which call the related `willSendRequest:` and `didReceiveResponse:` method in `FLEXNetworkObserver` class.  So, Flipper got the chance to observe the request and response of network activities. \n\n![a](activity_network.png)\n\n\n","tags":["Debug","Flipper"],"categories":["iOS","Network"]},{"title":"iOS Simulator from the Command Line","url":"/2020/02/05/iOS-Simulator-from-the-Command-Line/","content":"\n`xcrun simctl` is command utils to control iOS simulator, just like  [adb](https://developer.android.com/studio/command-line/adb?hl=en) for Android. Sometimes, in CI server script, We need these simulator-integration command to interact with simulators and run test cases. \n\n If we run `xcrun simctl help`, here are some subcommands. When successful, most of these commands exit with 0; when failed, most exit with a non-zero number. \n\n```\nSubcommands:\n        create              Create a new device.\n        clone               Clone an existing device.\n        upgrade             Upgrade a device to a newer runtime.\n        delete              Delete spcified devices, unavailable devices, or all devices.\n        pair                Create a new watch and phone pair.\n        unpair              Unpair a watch and phone pair.\n        pair_activate       Set a given pair as active.\n        erase               Erase a device's contents and settings.\n        boot                Boot a device.\n        shutdown            Shutdown a device.\n        rename              Rename a device.\n        getenv              Print an environment variable from a running device.\n        openurl             Open a URL in a device.\n        addmedia            Add photos, live photos, videos, or contacts to the library of a device.\n        install             Install an app on a device.\n        uninstall           Uninstall an app from a device.\n        get_app_container   Print the path of the installed app's container\n        launch              Launch an application by identifier on a device.\n        terminate           Terminate an application by identifier on a device.\n        spawn               Spawn a process by executing a given executable on a device.\n        list                List available devices, device types, runtimes, or device pairs.\n        icloud_sync         Trigger iCloud sync on a device.\n        pbsync              Sync the pasteboard content from one pasteboard to another.\n        pbcopy              Copy standard input onto the device pasteboard.\n        pbpaste             Print the contents of the device's pasteboard to standard output.\n        help                Prints the usage for a given subcommand.\n        io                  Set up a device IO operation.\n        diagnose            Collect diagnostic information and logs.\n        logverbose          enable or disable verbose logging for a device\n        status_bar          Set or clear status bar overrides\n        ui                  Get or Set UI options\n        push                Send a simulated push notification\n        privacy             Grant, revoke, or reset privacy and permissions\n        keychain            Manipulate a device's keychain\n```\nJust see I can do a lot of things with these command. If wanting to know more about a specific subcommand, we can use `xcrun simctl help [subcommand]` to seek help. Like, `xcrun simctl help boot` \n\n\n### Simulator info \n\nuse `xcrun simctl list` to see all the simulator information. We can get a list of device types, a list of info of runtime names, a list of device names. \n  \n```\n== Device Types ==\niPhone 11 Pro (com.apple.CoreSimulator.SimDeviceType.iPhone-11-Pro)\niPhone 11 Pro Max (com.apple.CoreSimulator.SimDeviceType.iP\n\n== Runtimes ==\niOS 13.3 (13.3 - 17C45) - com.apple.CoreSimulator.SimRuntime.iOS-13-3 \n\n== Devices ==\n-- iOS 13.3 --\niPhone 11 Pro Max (34C9AC6A-577D-4CEF-8B10-20011DCFBA27) (Shutdown) \n```\n\nUse `xcrun simctl list device` to see the list of device info. Or use a device name to get paired devices' info, like name, uuid, and status. For example,  \n\n```\nxcrun simctl list devices \"iPhone 11 Pro Max\"\n```\n\n```\n== Devices ==\n-- iOS 12.4 --\n-- iOS 13.3 --\n    iPhone 11 Pro Max (34C9AC6A-577D-4CEF-8B10-20011DCFBA27) (Shutdown) \n-- tvOS 13.3 --\n-- watchOS 6.1 --\n-- Unavailale: com.apple.CoreSimulator.SimRuntime.iOS-13-0 --\n    iPhone 11 Pro Max (893827B6-91E0-417C-A179-68343F695040) (Creating) (unavailable, runtime profile not found)\n-- Unavailable: com.apple.CoreSimulator.SimRuntime.iOS-13-1 --\n    iPhone 11 Pro Max (F4B573E0-4106-4FF2-ADA8-16DCC053026C) (Shutdown) (unavailable, runtime profile not found)\n-- Unavailable: com.apple.CoreSimulator.SimRuntime.iOS-13-2 --\n    iPhone 11 Pro Max (B63C96BD-1CE2-499B-8387-3B8AEBF50931) (Creating) (unavailable, runtime profile not found)\n```\n\n### Get device environment variable \n\n`xcrun simctl getenv` is for printing an environment variable from a running device. \n\n```\nUsage: simctl getenv <device> <variable name>\n```\n\n\nTake the follow command as an example, the `SIMULATOR_UDID` environment variable contains the UDID of the simulated device. But it doesn't work for physical device. \n\n```\nxcrun simctl getenv booted SIMULATOR_UDID\n9362BF90-132F-4894-A057-CEBFEC9C1FB6\n```\n\nWe can add more environment variables by ourselves in schema for debugging use. \n![](environment_variable.png)\n\n[Launch Arguments & Environment Variables](https://nshipster.com/launch-arguments-and-environment-variables/)\n\n### Create a custom simulator\n\n\n`xcrun simctl create <name> <device type> <runtime>`\nFor example, if I would like to create a iPhone 11 Pro Max with iOS 13.3, I can use the follow command.\n\n```\nxcrun simctl create \"ry\" \"iPhone 11 Pro Max\" iOS13.3  \nBE9A72F0-5793-447B-BEC4-63A73242BED5 \n```\n\n\n\nThe `uuid` of the new simulator is `BE9A72F0-5793-447B-BEC4-63A73242BED5`, which is output in standard out. And errors comes to standard error. \n\n> Tips: you should use available runtime, or you will get an error of `invalid runtime: xxx`. \n\nIf in shell scrip, we can capture the new device's name using environment variable:\n\n```\nNEW_DEVICE=$(xcrun simctl create \"Test Phone\" \"iPhone XR\" iOS13.0)\necho \"ðŸ¤– Created ${NEW_DEVICE}\"\nðŸ¤– Created BE9A72F0-5793-447B-BEC4-63A73242BED5\n```\n\nAnother way to create a simulator using GUI is to go to `Window` -> `Devices and Simulators` \n\n![create](create.png)\n Â Â \n### Boot a simulator \n\nBoot a device using `$uuid` \n\n`xcrun simctl boot BE9A72F0-5793-447B-BEC4-63A73242BED5` \n\nUse `simctl shutdown <device>` to shutdown a device. \n\n### Install/Uninstall app \n\n`xcrun simctl install <device> <path>`. We use this command to install an app on a device. \n\n```\nâžœ  xcrun simctl install booted ./demo.app\n```\n\n `booted` is the alias name of the booted device. We can also use `uuid` of a device.\n\n use ` simctl uninstall <device> <app bundle identifier>` to uninstall an app. like \n `xcrun simctl uninstall booted com.rong.lan.CubeTransitionAnimationDemo`  \n\n### Launch \n\n`xcrun simctl launch <device> <bundle> <arguments>`. \n\nLaunch command is used to launch a application in your simulator device.\n\n```\nxcrun simctl launch booted com.apple.example -MyDefaultKey YES\n```\n\n`com.apple.example` is bundle id of the application. \n\nIf we use `--console-pty`,  launch command will connect the standard output and error of the application to the terminal line.\n\n```\nâžœ  xcrun simctl launch --console-pty booted com.rong.lan.CubeTransitionAnimationDemo\n\ncom.rong.lan.CubeTransitionAnimationDemo: 98045\n2020-02-09 10:38:28.594 3DCubeTransitionAnimationDemo[98045:931065] gesture end translation x -281.000000; velocity-1056.111584\n2020-02-09 10:38:28.594 3DCubeTransitionAnimationDemo[98045:931065] timer current tx -281.000332\n2020-02-09 10:38:28.611 3DCubeTransitionAnimationDemo[98045:931065] timer current tx -285.030635\n2020-02-09 10:38:28.627 3DCubeTransitionAnimationDemo[98045:931065] timer current tx -289.060938\n```\n\n\n Use `xcrun simctl terminate <device> <bundle>` to terminate an application by identifier on a device.\n### Container Path \n\n`xcrun simctl simctl get_app_container <device> <app bundle identifier> [<container>]`  command is used to get the path of the installed app's container.  \n\n```\ncontainer   Optionally specify the container. Defaults to app.\n  app                 The .app bundle\n  data                The application's data container\n  groups              The App Group containers\n  <group identifier>  A specific App Group container\n```\n\n\nFor example\n\n```\nâžœ xcrun simctl get_app_container booted com.rong.lan.CubeTransitionAnimationDemo \n~/Library/Developer/CoreSimulator/Devices/BE9A72F0-5793-447B-BEC4-63A73242BED5/data/Containers/Bundle/Application/135A7B46-DE38-47EC-9871-D1F3615E9CE5/3DCubeTransitionAnimationDemo.app\nâžœ xcrun simctl get_app_container booted com.rong.lan.CubeTransitionAnimationDemo data \n~/Library/Developer/CoreSimulator/Devices/BE9A72F0-5793-447B-BEC4-63A73242BED5/data/Containers/Data/Application/10D64231-20B5-4DFE-B1E9-277AD9C02C4F\n```\n\n### Spawn \n\nSpawn command will pause xspawn, a process inside the simulator environment. \n\n```\nxcrun simctl spawn booted defaults write com.example.app ResetDatabase -bool YES\n```\nHere, we use `defaults` utils, because we already have a booted device `BE9A72F0-5793-447B-BEC4-63A73242BED5`, we don't have to specify the device. \n\n`com.example.app` is bundle id of my application. We reset `ResetDatabase` to YES. \nThis is a handy way to change the user defaults for the application before its running.  \n\n### Log Stream \n\nspwan command would work with log stream utility. We can pass a predicate and filter the log output. Here the predicate is `senderImagePath CONTAINS \"nsurlsessiond\"`. We can debug something wrong with URL session. \n\n```\nxcrun simctl spawn booted log stream --predicate 'senderImagePath CONTAINS \"nsurlsessiond\"'\n```\n![spwan](spawn_log.png)\n\nAlso, we can use different predicates to filter what we want.  \n\n```\nxcrun simctl spawn booted log stream â€” predicate â€˜processImagePath endswith â€œxxxâ€â€™\nxcrun simctl spawn booted log stream â€” predicate â€˜eventMessage contains â€œerrorâ€ and messageType == infoâ€™\n\n```\n\n\n### Dignose \n\nIn a auto-test system, if having some kind of issue, by using this command, you can not only collect logs on disk but also capture ephemeral logging and dump system state. \n\n```\nâžœ  xcrun simctl diagnose -l                              \nWriting to /private/tmp/simctl_diagnose_2020_02_09.10-10-56+0800\nGetting Simulator component versions...\nCollecting CoreSimulator logs...\nCollecting device information (this may take some time)...\nThis operation will time-out after 300 seconds.\nGathering 15 crash reports...\nCompressing Archive...\nSuccessfully wrote simctl diagnose archive to '/private/tmp/simctl_diagnose_2020_02_09.10-10-56+0800.tar.gz'\n```\n\n![diagnose](diagnose.png)\n\n### Clone \nClone is a very powerful command. See details in [wwdc2019/418](https://developer.apple.com/videos/play/wwdc2019/418/).  \n\n`xcrun simctl clone <device> <clone name>`.  You can copy your custom device using this command. \n\n```\n// boot base simulator ry\nâžœ xcrun simctl boot ry   \nâžœ xcrun simctl install ry ./demo.app\n// Must shutdown it before clone \nâžœ xcrun simctl shutdown all \nâžœ xcrun simctl clone ry ry-1  \nâžœ xcrun simctl clone ry ry-2 \nâžœ xcrun simctl boot ry-1 && xcrun simctl boot ry-2 \n```\n\n\nTwo new devices are created with the same contents. \n\n![clone](clone.png)\n\n\n### Push Notification to simulator\n\n1. Create a `.apns` file, `ExamplePush.apns` \n\n```\n{\n    \"Simulator Target Bundle\": \"com.facebook.flipper\",\n    \"aps\": {\n        \"alert\": \"This is a simulated notification!\",\n        \"badge\": 3,\n        \"sound\": \"default\"\n    }\n}\n```\n\n[valid Apple Push Notification values](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/generating_a_remote_notification). Noted that the `Target Bundle` should be the same as the `bundle identifier`  \n\n2. Drag and drop an APNs file onto the target simulator. \n\n> The file must be a JSON file with a valid Apple Push Notification Service payload, including the â€œapsâ€ key. It must also contain a top-level â€œSimulator Target Bundleâ€ with a string value matching the target applicationâ€˜s bundle identifier. --  https://stackoverflow.com/a/60085404/4026902\n\n\n\nOr, we use command lines. \n\n```\nxcrun simctl push booted com.facebook.flipper ExamplePush.apns\n```\n\n\n```\nâžœ  ~ xcrun simctl push \nSend a simulated push notification\nUsage: simctl push <device> [<bundle identifier>] (<json file> | -)\n\n        bundle identifier\n             The bundle identifier of the target application\n             If the payload file contains a 'Simulator Target Bundle' top-level key this parameter may be omitted.\n             If both are provided this argument will override the value from the payload.\n        json file\n             Path to a JSON payload or '-' to read from stdin. The payload must:\n               - Contain an object at the top level.\n               - Contain an 'aps' key with valid Apple Push Notification values.\n               - Be 4096 bytes or less.\n\nOnly application remote push notifications are supported. VoIP, Complication, File Provider, and other types are not supported.\n\n```\n\n### Manipulate a device's keychain \n\n```\nâžœ  ~ xcrun simctl keychain\nManipulate a device's keychain\nUsage: simctl keychain <device> <action> [arguments]\n\n    add-root-cert [path]\n        Add a certificate to the trusted root store.\n\n    add-cert [path]\n        Add a certificate to the keychain.\n\n    reset\n        Reset the keychain.\n```\n\n```\nxcrun simctl keychain booted add-root-cert myCA.cer\n```\n\n### Privacy and Permissions \n\nThese commands, introduced in Xcode 11.4,  could be very useful when you are developing some features and have to test the permissions.  \n\n```\nâžœ  ~ xcrun simctl privacy                                         \nGrant, revoke, or reset privacy and permissions\nUsage: simctl privacy <device> <action> <service> [<bundle identifier>]\n\n        action\n             The action to take:\n                 grant - Grant access without prompting. Requires bundle identifier.\n                 revoke - Revoke access, denying all use of the service. Requires bundle identifier.\n                 reset - Reset access, prompting on next use. Bundle identifier optional.\n             Some permission changes will terminate the application if running.\n        service\n             The service:\n                 all - Apply the action to all services.\n                 calendar - Allow access to calendar.\n                 contacts-limited - Allow access to basic contact info.\n                 contacts - Allow access to full contact details.\n                 location - Allow access to location services when app is in use.\n                 location-always - Allow access to location services at all times.\n                 photos-add - Allow adding photos to the photo library.\n                 photos - Allow full access to the photo library.\n                 media-library - Allow access to the media library.\n                 microphone - Allow access to audio input.\n                 motion - Allow access to motion and fitness data.\n                 reminders - Allow access to reminders.\n                 siri - Allow use of the app with Siri.\n        bundle identifier\n             The bundle identifier of the target application.\n\nExamples:\n        reset all permissions: privacy <device> reset all\n        grant test host photo permissions: privacy <device> grant photos com.example.app.test-host\n```\nFor example,\n\n```\nâžœ  ~ xcrun simctl privacy booted grant location com.facebook.flipper\nâžœ  ~ xcrun simctl privacy booted grant photos com.facebook.flipper\n```\n\nand use `revoke` to revoke the permissions. \n\n\n### Switch the appearance style in a device between light and dark.\n\n```\nxcrun simctl ui booted appearance dark\nxcrun simctl ui booted appearance light\n```\n\n### StatsBar override \n\n`Usage: simctl status_bar <device> [list | clear | override <override arguments>]`\n\nIt seems it can support a lot of overrides variables in status bar. But I have figure out the scenarios to use them. \n\n```\nâžœ  ~ xcrun simctl status_bar                                    \nSet or clear status bar overrides\nUsage: simctl status_bar <device> [list | clear | override <override arguments>]\n\nSupported Operations:\n    list\n        List existing overrides.\n\n    clear\n        Clear all existing status bar overrides.\n\n    override <override arguments>\n        Set status bar override values, according to these flags.\n        You may specify any combination of these flags (at least one is required):\n\n        --time <string>\n             Set the date or time to a fixed value.\n             If the string is a valid ISO date string it will also set the date on relevant devices.\n        --dataNetwork <dataNetworkType>\n             If specified must be one of 'wifi', '3g', '4g', 'lte', 'lte-a', or 'lte+'.\n        --wifiMode <mode>\n             If specified must be one of 'searching', 'failed', or 'active'.\n        --wifiBars <int>\n             If specified must be 0-3.\n        --cellularMode <mode>\n             If specified must be one of 'notSupported', 'searching', 'failed', or 'active'.\n        --cellularBars <int>\n             If specified must be 0-4.\n        --operatorName <string>\n             Set the cellular operator/carrier name. Use '' for the empty string.\n        --batteryState <state>\n             If specified must be one of 'charging', 'charged', or 'discharging'.\n        --batteryLevel <int>\n             If specified must be 0-100.\n```\n\n```\n// change the `dataNetwork` from `wifi` to `4g`\nâžœ  ~ xcrun simctl status_bar booted override --dataNetwork '4g'\n```\n\n```\nxcrun simctl status_bar booted override --time 15:42 --cellularBars 1 --dataNetwork '3g' --wifiMode 'failed' --batteryState 'charging'\n```\n![status bar](status_bar_test.png)\n\nand use `clear` option to clear all the settings.\n\n```\nxcrun simctl status_bar booted clear\n```\n\nhttps://developer.apple.com/videos/play/wwdc2020/10647/\n\n### Record Video \n\nWe can run `xcrun simctl io --help` to see more. \n\n```\nxcrun simctl io <device> recordVideo <file>\n```\n\n```\nxcrun simctl io booted recordVideo video.mp4\n```\nThis command records the content of the screen of the current booted simulator, and save it to the video.mp4 file.  To stop recording, we have to use `ctl+c` in the terminal. \n\n```\nxcrun simctl io booted recordVideo  -f video.mp4\n```\n`recordVideo` cannot save recorded video output into a file that already exists unless we use  `-f` flag to override the existing file. \n\n```\nxcrun simctl io booted recordVideo video.mp4 --codec h264 --mask ignored video.mp4\n```\n - By default, codec type is `hevc`. \n - Ignore the mask when the mask is rendered black because of compatibility issues. \n\n\nAnd we can also capture the out of the external display of the simulator. \n```\nxcrun simctl io booted recordVideo --display external external.mp4 \n```\n\n![](record_video.gif)\n\n### Other useful commands\n\n```\n// Open a URL in a device.\nsimctl openurl <device> <URL>\n// add a photo or movie to the Photos library of the specified simulator \nxcrun simctl addmedia <device> <file1> <file2>\n// Set up a device IO operation. screenshot or recordVideo \nxcrun simctl io <device> screenshot <output.png>\n\n```\n\n> Ref: \n> https://developer.apple.com/videos/play/wwdc2019/418/\n> https://www.iosdev.recipes/simctl/\n> https://nshipster.com/simctl/ \n> https://developer.apple.com/documentation/xcode_release_notes/xcode_11_4_release_notes\n","tags":["WWDC","Popular Article","Debug","Simulator"],"categories":["iOS"]},{"title":"Understand onViewableItemsChanged in FlatList","url":"/2020/01/21/onViewableItemsChanged/","content":"\nIf you want to get viewable items in the [FlatList], you had better take a look at the `onViewableItemsChanged` prop. For example, suppose you have a video list, and you want automatically play the video when the video is appearing on the screen for a few seconds. In iOS, there is [visibleCells](https://developer.apple.com/documentation/uikit/uicollectionview/1618056-visiblecells) in `UITableView` to achieve this. In React Native, I am glad to tell you that `FlatList` has a more powerful property, `onViewableItemsChanged`. `This article would help you better understand how to use the `onViewableItemsChanged` prop in the [FlatList], and how it works under the hood.\n\n## What is onViewableItemsChanged\n\n`onViewableItemsChanged` is a prop in [VirtualizedList](https://facebook.github.io/react-native/docs/virtualizedlist#onviewableitemschanged) and [FlatList](https://facebook.github.io/react-native/docs/flatlist#onviewableitemschanged). When you scroll a FlatList, the items showing on the FlatList change. Then, this function is called, telling you what current `viewableItems` are and what `changed` items are. \n\nThis function should be used together with [viewabilityConfig](https://facebook.github.io/react-native/docs/virtualizedlist#viewabilityconfig). A specific `onViewableItemsChanged` will be called when its corresponding `ViewabilityConfig`'s conditions are met.\n\nHere is [ViewabilityConfig](https://facebook.github.io/react-native/docs/flatlist#viewabilityconfig)\n```js \nexport type ViewabilityConfig = {\n  /**\n   * Minimum amount of time (in milliseconds) that an item must be physically viewable before the\n   * viewability callback will be fired. A high number means that scrolling through content without\n   * stopping will not mark the content as viewable.\n   */\n  minimumViewTime?: number,\n\n  /**\n   * Percent of viewport that must be covered for a partially occluded item to count as\n   * \"viewable\", 0-100. Fully visible items are always considered viewable. A value of 0 means\n   * that a single pixel in the viewport makes the item viewable, and a value of 100 means that\n   * an item must be either entirely visible or cover the entire viewport to count as viewable.\n   */\n  viewAreaCoveragePercentThreshold?: number,\n\n  /**\n   * Similar to `viewAreaPercentThreshold`, but considers the percent of the item that is visible,\n   * rather than the fraction of the viewable area it covers.\n   */\n  itemVisiblePercentThreshold?: number,\n\n  /**\n   * Nothing is considered viewable until the user scrolls or `recordInteraction` is called after\n   * render.\n   */\n  waitForInteraction?: boolean,\n|};\n```\nHere is the type of `onViewableItemsChanged` function: \n```js\n /**\n   * Called when the viewability of rows changes, as defined by the\n   * `viewabilityConfig` prop.\n   */\n  onViewableItemsChanged?: ?(info: {\n    viewableItems: Array<ViewToken>,\n    changed: Array<ViewToken>,\n    ...\n  }) => void,\n  \nexport type ViewToken = {\n  item: any,\n  // The key of this item\n  key: string,\n  index: ?number,\n  // indicated whether this item is viewable or not\n  isViewable: boolean,\n  section?: any,\n  ...\n};\n```\n\n## How to use it\n\nLet's look at two simple example.\n\n```javascript\n  viewabilityConfig = {\n    waitForInteraction: true,\n    // At least one of the viewAreaCoveragePercentThreshold or itemVisiblePercentThreshold is required.\n    viewAreaCoveragePercentThreshold: 95,\n    itemVisiblePercentThreshold: 75\n  }\n\n  onViewableItemsChanged = ({viewableItems, changed}) => {\n    console.log(\"Visible items are\", viewableItems);\n    console.log(\"Changed in this iteration\", changed);\n  };\n\n  render() {\n    return (\n      <FlatList\n        viewabilityConfig={this.viewabilityConfig}\n        onViewableItemsChanged={this.onViewableItemsChanged}\n        data={this._items}\n        renderItem={this._renderItem}\n        keyExtractor={item => item.id}\n      />\n    )\n  }\n```\n\nBesides, supposed you have to implement different logic for items with 60% viewable region and those with 75% viewable region. You can use `viewabilityConfigCallbackPairs`, which contains an list of key/value objects, which define different `viewability` configurations and `onViewableItemsChanged` callbacks.  \n\n```javascript\n<FlatList\n    data={this._items}\n    renderItem={this._renderItem}\n    keyExtractor={(item) => item.id }\n    viewabilityConfigCallbackPairs={this._viewabilityConfigCallbackPairs}\n/>\n\nthis._viewabilityConfigCallbackPairs = [{\n    viewabilityConfig: {\n      minimumViewTime: 600,\n      itemVisiblePercentThreshold: 60\n    },\n    onViewableItemsChanged: this.handleItemsPartiallyVisible60\n  },\n  {\n    viewabilityConfig: {\n      minimumViewTime: 700,\n      itemVisiblePercentThreshold: 75\n    },\n    onViewableItemsChanged: this.handleItemsPartiallyVisible75\n  }\n];\n```\n\n## How does onViewableItemsChanged works\n\n### Viewable Region \n\n  The layout and viewable region information for VirtualizedList is stored in `_scrollMetrics` object. Through the `nativeEvent` in `onScroll` callback, VirtualizedList gets these layout information.\n\n```js\nconst timestamp = e.timeStamp;\nlet visibleLength = this._selectLength(e.nativeEvent.layoutMeasurement);\nlet contentLength = this._selectLength(e.nativeEvent.contentSize);\nlet offset = this._selectOffset(e.nativeEvent.contentOffset);\nlet dOffset = offset - this._scrollMetrics.offset;\n\n// ... more code here\n\n this._scrollMetrics = {\n      contentLength,\n      dt,\n      dOffset,\n      offset,\n      timestamp,\n      velocity,\n      visibleLength,\n    };\n\n```\n\nIf it is a vertical VirtualizedList, the  `layout.layoutMeasurement.height` in the `nativeEvent` is assigned to `visibleLength`; which is the height of viewable region here.  Also, in a vertical VirtualizedList, the  `layout.layoutMeasurement.height`  is equal to viewportHeight.\n\n![5d152b82.png](/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/5d152b82.png)\n\n### Overview \n\n![a0336b02.png](/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/a0336b02.png)\n\n#### Different `viewabilityConfig`  in one `VirtualizedList`  \n\n`_viewabilityTuples` is an array inside `VirtualizedList` to store `ViewabilityHelper/onViewableItemsChanged` pairs. This array is initialized in the `constructor` function.\n\n```js\n_viewabilityTuples: Array<ViewabilityHelperCallbackTuple> = [];\n\ntype ViewabilityHelperCallbackTuple = {\n  viewabilityHelper: ViewabilityHelper,\n  onViewableItemsChanged: (info: {\n    viewableItems: Array<ViewToken>,\n    changed: Array<ViewToken>,\n    ...\n  }) => void,\n  ...\n};\n```\n\nIf you define [viewabilityConfigCallbackPairs](https://facebook.github.io/react-native/docs/flatlist#viewabilityconfigcallbackpairs),  each `viewabilityConfig` will be used to initialize a different `ViewabilityHelper` object.\n\n[ref code](https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/VirtualizedList.js#L743).\n\n```js\n if (this.props.viewabilityConfigCallbackPairs) {\n      this._viewabilityTuples = this.props.viewabilityConfigCallbackPairs.map(\n        pair => ({\n          viewabilityHelper: new ViewabilityHelper(pair.viewabilityConfig),\n          onViewableItemsChanged: pair.onViewableItemsChanged,\n        }),\n      );\n    } else if (this.props.onViewableItemsChanged) {\n      this._viewabilityTuples.push({\n        viewabilityHelper: new ViewabilityHelper(this.props.viewabilityConfig),\n        onViewableItemsChanged: this.props.onViewableItemsChanged,\n      });\n    }\n\n```\n\n`ViewabilityHelper` is `a utility class for calculating viewable items based on the viewabilityConfig and metrics, like the scroll position and layout.`\n\nAs I mentioned before, in a `VirtualizedList` could has several `ViewabilityHelper` objects in `_viewabilityTuples`, containing different `viewabilityConfig` to handle different viewability conditions. Let's take a look at some important props in `ViewabilityHelper`.\n\n```js\nclass ViewabilityHelper {\n  _config: ViewabilityConfig;\n  _hasInteracted: boolean = false;\n  /* A set of `timeoutID`, used for memory management */\n  _timers: Set<number> = new Set();\n  // Indexes of the viewable items\n  _viewableIndices: Array<number> = [];\n  // A map for viewable items\n  _viewableItems: Map<string, ViewToken> = new Map();\n}\n```\n\n#### Items' layout\n\nIn the overview graph, you can see a func `_updateViewableItems` called in many scenarios. For example, it is called in `onScroll` callback. Then, It calls `viewabilityHelper.onUpdate` to find out the viewable items, which appear in the viewport for VirtualizedList.\n\n```js\n_updateViewableItems(data: any) {\n    const {getItemCount} = this.props;\n\n    this._viewabilityTuples.forEach(tuple => {\n      tuple.viewabilityHelper.onUpdate(\n        getItemCount(data),\n        // contentOffset of the list \n        this._scrollMetrics.offset,\n        // ðŸŒŸ viewportHeight \n        this._scrollMetrics.visibleLength, \n        this._getFrameMetrics,\n        this._createViewToken,\n        tuple.onViewableItemsChanged,\n        this.state,\n      );\n    });\n  }\n\n```\n- `this._scrollMetrics.visibleLength` is used as `viewportHeight`\n- `this._createViewToken` is used to construct a `ViewToken` object, which contains `item` data, `index`, `key` and `isViewable` flag of the `item`. \n- [this._getFrameMetrics](1864) is a function to get layout information of the item cell by index. The item layout is from `getItemLayout` prop of  `VirtualizedList` or `this._frames` map. `this._frames` stores the itemKey/itemLayout pairs.  \n\n```js\n// this._frames stores the item cell layout info\n{ [cellKey]: {\n      // offset of the item cell\n      offset: number, \n      // length of the item cell. width or height determined by the direction of the VirtualizedList\n      length: number, \n      index: number,\n      inLayout: boolean,\n    }\n}\n```\n\n- By `this.state`, we know the range of the rendered items by  `first` and `last` value. `VirtualizedList` updates these two values when the rendered items are changed.\n\n```js\ntype State = {\n  // The range of the rendered items, \n  // used for the optimization to reduce the scan size\n  first: number,\n  last: number,\n  ...\n};\n```\n\n### How to find out viewable items\n \nIn `onUpdate` method, it calls `computeViewableItems` to get `viewableIndices`. `viewableIndices` is an array of indexes of the viewable items.  So, how does `computeViewableItems`  work?  \n\n#### How to get the indexes of viewable items\n\nIn `computeViewableItems` in the `ViewabilityHelper` class, it iterates items from `${first}` to `${last}`. If an item is viewable, it will be stored in an array named `viewableIndices`.\n\n```js\n  for (let idx = first; idx <= last; idx++) {\n      const metrics = getFrameMetrics(idx);\n      if (!metrics) {\n        continue;\n      }\n      // The top of current item cell, relative to the screen coordinate\n      const top = metrics.offset - scrollOffset;\n      // The bottom of current item cell, relative to the screen coordinate\n      const bottom = top + metrics.length;\n      if (top < viewportHeight && bottom > 0) {\n        firstVisible = idx;\n        if (\n          _isViewable(\n            viewAreaMode,\n            viewablePercentThreshold,\n            top,\n            bottom,\n            viewportHeight,\n            metrics.length,\n          )\n        ) {\n          viewableIndices.push(idx);\n        }\n      } else if (firstVisible >= 0) {\n        break;\n      }\n    }\n    return viewableIndices;\n  }\n```\n\nFrom the code, we can see the `top` and `bottom` value is related to the screen coordinate. I drew a graph to show the relationship between `metrics.offset`, `scrollOffset`, `metrics.length` , `top` and `bottom`, to help you better understand the above code.\n\n![layout.png](/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/3252d60e.png)\n\n### What kind of item is viewable\n\n An item is said to be viewable when it meets the following conditions\n for longer than `${minimumViewTime}` milliseconds (after an interaction if `waitForInteraction`\n is true):\n \n1. the fraction of the item visible in the view area >= `itemVisiblePercentThreshold`.\nWhen it comes to the fraction of the item visible in the view area, we need to care about\n cases shown in the following graph. RN use `Math.min(bottom, viewportHeight) - Math.max(top, 0)` to calculate the viewable length. \n    \n  ![partial](viewable-partial.png)\n\n1. Entirely visible on screen when the height of a item is bigger than the `viewportHeight`.\n\n![7c4f2df0.png](entire-viewable.png)\n\n[ref](https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L64)\n\n```js\nfunction _isViewable(\n  viewAreaMode: boolean,\n  viewablePercentThreshold: number,\n  top: number,\n  bottom: number,\n  viewportHeight: number,\n  itemLength: number,\n): boolean {\n  if (_isEntirelyVisible(top, bottom, viewportHeight)) {\n    // Entirely visible \n    return true;\n  } else {\n    // Get viewable height of this item cell \n    const pixels = _getPixelsVisible(top, bottom, viewportHeight);\n    // Get the viewable percentage of this item cell \n    const percent =\n      100 * (viewAreaMode ? pixels / viewportHeight : pixels / itemLength);\n    return percent >= viewablePercentThreshold;\n  }\n}\n\nfunction _getPixelsVisible(\n  top: number,\n  bottom: number,\n  viewportHeight: number,\n): number {\n  const visibleHeight = Math.min(bottom, viewportHeight) - Math.max(top, 0);\n  return Math.max(0, visibleHeight);\n}\n\nfunction _isEntirelyVisible(\n  top: number,\n  bottom: number,\n  viewportHeight: number,\n): boolean {\n  return top >= 0 && bottom <= viewportHeight && bottom > top;\n}\n```\n[code here](https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L300)\n\n### Timer and Schedule \n\nIn [`onUpdate` func in ViewabilityHelper](https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L228), if we define `minimumViewTime` value, the `_onUpdateSync` is scheduled to be called. It is the handler of the `timeout`.\n\n```js\n this._viewableIndices = viewableIndices;\n if (this._config.minimumViewTime) {\n      const handle = setTimeout(() => {\n        this._timers.delete(handle);\n        // filter out  indices that have gone out of view after minimumViewTime \n        // figure out which items are gone, which items are showing \n        this._onUpdateSync(\n          viewableIndices,\n          onViewableItemsChanged,\n          createViewToken,\n        );\n      }, this._config.minimumViewTime);\n      this._timers.add(handle);\n    } else {\n      this._onUpdateSync(\n        viewableIndices,\n        onViewableItemsChanged,\n        createViewToken,\n      );\n    }\n```\n\nAnd, If after a few seconds, ${minimumViewTime}, if some items aren't longer viewable, the [_onUpdateSync](https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L267) func, filter out these indices that have gone out of viewport.\n\n```js\n    // Filter out indices that have gone out of view after `minimumViewTime`\n    viewableIndicesToCheck = viewableIndicesToCheck.filter(ii =>\n      this._viewableIndices.includes(ii),\n    );\n\n```\n![99830c30.png](/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/99830c30.png)\n\nIn the above graph, at first, the `_viewableIndices` is from 1 to 9. Then the user scrolls the `VirtualizedList`  and the `_onUpdateSync` is triggered after `minimumViewTime`. At this moment, the current `_viewableIndices` is from 2 to 10. So the item indexed 1 is filtered out.\n\n### 6. How to get changed items \n\nComparing with the last time when  `onViewableItemsChanged` is triggered, at this time to trigger  `onViewableItemsChanged`. Some viewable items will be out of the screen, some hidden items will become viewable. In `_onUpdateSync` function, the `preItems`  map stores the information about previous visible items, the previous means last time when `VirtualizedList` calls `onViewableItemsChanged`. Now it has a `nextItems` map, which stores the information about viewable items this time. Then it figures out the `changed` items by comparing these two maps. Then, it calls `onViewableItemsChanged`, passing `viewableItems` and `changed` items. \n\n```js\n_onUpdateSync(\n    viewableIndicesToCheck,\n    onViewableItemsChanged,\n    createViewToken,\n  ) {\n    // Filter out indices that have gone out of view since this call was scheduled.\n    viewableIndicesToCheck = viewableIndicesToCheck.filter(ii =>\n      this._viewableIndices.includes(ii),\n    );\n    const prevItems = this._viewableItems;\n    // Using map, so the time complexity would be o(n) \n    const nextItems = new Map(\n      viewableIndicesToCheck.map(ii => {\n        const viewable = createViewToken(ii, true);\n        return [viewable.key, viewable];\n      }),\n    );\n\n    const changed = [];\n    for (const [key, viewable] of nextItems) {\n      if (!prevItems.has(key)) {\n        changed.push(viewable);\n      }\n    }\n    for (const [key, viewable] of prevItems) {\n      if (!nextItems.has(key)) {\n        changed.push({...viewable, isViewable: false});\n      }\n    }\n    if (changed.length > 0) {\n      this._viewableItems = nextItems;\n      onViewableItemsChanged({\n        viewableItems: Array.from(nextItems.values()),\n        changed,\n        viewabilityConfig: this._config,\n      });\n    }\n  }\n}\n```","tags":["Popular Article","Dive into React Native"],"categories":["React Native"]},{"title":"Gaussian Filter","url":"/2019/07/12/Gaussian-Filter/","content":"\né«˜æ–¯å‡½æ•°åœ¨å­¦æœ¯é¢†åŸŸè¿ç”¨çš„éžå¸¸å¹¿æ³›ã€‚ å†™å·¥ç¨‹äº§å“çš„æ—¶å€™ï¼Œç»å¸¸ç”¨å®ƒæ¥åŽ»é™¤å›¾ç‰‡æˆ–è€…è§†é¢‘çš„å™ªéŸ³ï¼Œå¹³æ»‘å›¾ç‰‡, Blurå¤„ç†ã€‚æˆ‘ä»¬ä»Šå¤©æ¥çœ‹çœ‹é«˜æ–¯æ»¤æ³¢, Gaussian Filterã€‚ \n**1Dçš„é«˜æ–¯å‡½æ•°**\nä¸€ç»´çš„é«˜æ–¯å‡½æ•°ï¼ˆæˆ–è€…å«æ­£æ€åˆ†å¸ƒï¼‰æ–¹ç¨‹è·Ÿå›¾å½¢å¦‚ä¸‹: \n$$G(x) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} e^{-\\frac{x^2}{2\\sigma^2}}$$\n![image.png](/img/Gaussian-Filter/gaussian.png)\n\n$\\mu$æ˜¯å‡å€¼ï¼›$\\sigma$ æ˜¯æ ‡å‡†æ–¹å·®ã€‚å®ƒæœ‰ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ -$\\sigma$ åˆ°+$\\sigma$ ä¹‹é—´çš„G(x)ä¸Žxè½´å›´æˆçš„é¢ç§¯å å…¨éƒ¨é¢ç§¯çš„68.2%.  -2$\\sigma$ åˆ°+2$\\sigma$ä¹‹é—´çš„é¢ç§¯å 95%ã€‚-3$\\sigma$ åˆ°+3$\\sigma$ä¹‹é—´çš„é¢ç§¯å 99.7%ã€‚\nå¦‚æžœæˆ‘ä»¬ç»™-3$\\sigma$ åˆ°+3$\\sigma$åŒºé—´, å®ƒå‡ ä¹ŽåŒ…æ‹¬äº†æ‰€æœ‰å¯èƒ½çš„ç‚¹ã€‚è¿™ä¸ªç‰¹æ€§å¯¹Filter kernelçš„ç”Ÿæˆå¾ˆé‡è¦ã€‚\n\n\n**2Dçš„é«˜æ–¯å‡½æ•°**\n$$G(x, y) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} e^{-\\frac{x^2 + y^2}{2\\sigma^2}}$$\n\n![image.png](/img/Gaussian-Filter/2d-gaussian.png)\n\n\n**æ‰€è°“é«˜æ–¯æ»¤æ³¢æ“ä½œï¼Œå…¶å®žå°±æ˜¯ç”¨é«˜æ–¯å‡½æ•°å¯¹imageåšå·ç§¯è®¡ç®—**ã€‚ä½†ä¸€èˆ¬å›¾åƒåœ¨è®¡ç®—æœºä¸­ä¸€èˆ¬æ˜¯ç¦»æ•£çš„3DçŸ©é˜µï¼Œè€Œé«˜æ–¯å‡½æ•°æ˜¯è¿žç»­å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä»Žè¿žç»­é«˜æ–¯å‡½æ•°ä¸­é‡‡æ ·ç”Ÿæˆç¦»æ•£çš„2DçŸ©é˜µï¼Œå³Gaussian Filter Kernelã€‚ æˆ‘ä»¬å¯ä»¥æŽ§åˆ¶Kernalçš„sizeï¼Œè®©å®ƒçš„ç‚¹éƒ½è½åœ¨-3$\\sigma$ åˆ°+3$\\sigma$åŒºé—´å†…ã€‚\n### ç”Ÿæˆé«˜æ–¯kernel \n\n```c++\n// Function to create Gaussian filter; sigma is standard deviation\nMatrix getGaussian(int height, int width, double sigma)\n{\n    Matrix kernel(height, Array(width));\n    // sum is for normalization \n    double sum=0.0;\n    int i,j;\n    \n   // generating the kernel \n    for (i=0 ; i<height ; i++) {\n        for (j=0 ; j<width ; j++) {\n            // using gaussian function to generate gaussian filter \n            kernel[i][j] = exp(-(i*i+j*j)/(2*sigma*sigma))/(2*M_PI*sigma*sigma);\n            sum += kernel[i][j];\n        }\n    }\n   \n   // normalising the Kernel \n    for (i=0 ; i<height ; i++) {\n        for (j=0 ; j<width ; j++) {\n            kernel[i][j] /= sum;\n        }\n    }\n\n    return kernel;\n}\n```\n[ä»£ç æ¥æº](https://gist.github.com/OmarAflak/aca9d0dc8d583ff5a5dc16ca5cdda86a)\næ¯”å¦‚ï¼Œæˆ‘ä»¬ç”¨é«˜æ–¯å‡½æ•°ç”Ÿæˆäº†ä¸€ä¸ª5x5ï¼Œ $\\sigma$æ˜¯1çš„é«˜æ–¯æ ¸2DçŸ©é˜µ:\n![image.png](/img/Gaussian-Filter/gaussian_matrix.png)\nå®ƒæœ‰å‡ ä¸ªç‰¹ç‚¹ï¼š \n1. æœ€ä¸­é—´çš„å€¼æœ€å¤§ï¼Œå€¼å‘å‘¨å›´é€’å‡\n2. $\\sigma$è¶Šå¤§ï¼Œé«˜æ–¯å‡½æ•°çš„å³°è¶Šå®½ï¼Œä¸´æŽ¥çš„æ•°å€¼å·®è¶Šå¤§\n\n### å¯¹å›¾ç‰‡åº”ç”¨é«˜æ–¯Filter\nå¯¹æŸä¸ªåƒç´ ç‚¹image[i][j]ï¼ŒFitlerå¯¹åŽŸå›¾å¯¹åº”çš„åƒç´ ç‚¹åšç‚¹ä¹˜ï¼Œç›¸åŠ ã€‚ ç”Ÿæˆæ–°çš„å€¼ã€‚\n![https://www.youtube.com/watch?v=C_zFhWdM4ic](/img/Gaussian-Filter/convoltion.gif)\n[ææ–™æ¥æº](https://www.youtube.com/watch?v=C_zFhWdM4ic)\n```c++\nImage applyFilter(Image &image, Matrix &filter){\n    assert(image.size()==3 && filter.size()!=0);\n\n    int height = image[0].size();\n    int width = image[0][0].size();\n    int filterHeight = filter.size();\n    int filterWidth = filter[0].size();\n    int newImageHeight = height-filterHeight+1;\n    int newImageWidth = width-filterWidth+1;\n    int d,i,j,h,w;\n\n    Image newImage(3, Matrix(newImageHeight, Array(newImageWidth)));\n    \n   // iter the image pixel\n    for (d=0 ; d<3 ; d++) {\n        for (i=0 ; i<newImageHeight ; i++) {\n            for (j=0 ; j<newImageWidth ; j++) {\n                // using filter convolute the image matrix\n                for (h=i ; h<i+filterHeight ; h++) {\n                    for (w=j ; w<j+filterWidth ; w++) {\n                        newImage[d][i][j] += filter[h-i][w-j]*image[d][h][w];\n                    }\n                }\n            }\n        }\n    }\n\n    return newImage;\n}\n```\nå¦‚ä¸‹å›¾ï¼Œå›¾ç‰‡è¢«å¹³æ»‘å¤„ç†äº†ã€‚\n![image.png](/img/Gaussian-Filter/blur_image.png)\n\n#### More: \n[https://gist.github.com/OmarAflak/aca9d0dc8d583ff5a5dc16ca5cdda86a](https://gist.github.com/OmarAflak/aca9d0dc8d583ff5a5dc16ca5cdda86a)\n\n","tags":["CV"],"categories":["Algorithm"]},{"title":"792. Number of Matching Subsequences","url":"/2019/07/06/792-Number-of-Matching-Subsequences/","content":"\n## [é¢˜ç›®](https://leetcode-cn.com/problems/number-of-matching-subsequences/)\n\n## Solution 1 \næ€è·¯ï¼šå­˜å‚¨ + äºŒåˆ†æŸ¥æ‰¾\n1. é¦–å…ˆå°†å­—ç¬¦ä¸€é›†å¯¹åº”çš„ä¸‹æ ‡å­˜å‚¨åœ¨26 * nçš„äºŒç»´æ•°ç»„ä¸­ã€‚æ¯”å¦‚å¯¹å­—ç¬¦ä¸² 'abcdea'å­˜å‚¨ä¸º\n\n| Char | Index |\n| --- | --- |\n| 0 | [0, 5] |\n| 1 | [1] |\n| 2 | [2] |\n| 3 | [3] |\n| 4 | [4] |\n| ... |  |\n| 25 |  |\n\nå¯¹åº”ä»£ç : \n\n```c++\n  vector<vector<int>> store(26, vector<int>());\n    for (int i = 0; i < S.size(); ++i) {\n        // å­˜å‚¨å­—æ¯è·Ÿindex\n        store[S[i] - 'a'].push_back(i);\n    }\n```\n\n1. å¯¹æŸä¸ªwordï¼ŒæŸ¥æ‰¾å®ƒçš„å­—ç¬¦æ˜¯å¦åœ¨äºŒç»´æ•°ç»„ä¸­ã€‚\n\n```c++\nint numMatchingSubseq(string S, vector<string>& words) {\n    vector<vector<int>> store(26, vector<int>());\n    for (int i = 0; i < S.size(); ++i) {\n        // å­˜å‚¨å­—æ¯è·Ÿindex\n        store[S[i] - 'a'].push_back(i);\n    }\n\n    int res = 0;\n    for (auto &word: words) {\n        int x = -1;\n        bool found = true;\n        for (auto c: word) {\n            // search\n            auto it = upper_bound(store[c - 'a'].begin(), store[c - 'a'].end(), x);\n            if (it == store[c - 'a'].end()) {\n                found = false;\n                break;\n            } else {\n                // æ›´æ–°æœ€æ–°çš„ä¸‹æ ‡ä½ç½®\n                x = *it;\n            }\n        }\n        if (found) res++;\n    }\n\n    return res;\n}\n```\n## Solution 2 \nç¬¬äºŒç§æ€è·¯ï¼Œæ¥è‡ª[Stefanå¤§ç¥ž](https://leetcode.com/problems/number-of-matching-subsequences/discuss/117634/Efficient-and-simple-go-through-words-in-parallel-with-explanation)ã€‚ \nè¿™ç§æ€è·¯ï¼Œå­˜å‚¨çš„æ˜¯wordsä¸­ç­‰å¾…åŒ¹é…çš„å­—ç¬¦çš„index pairã€‚æ¯”å¦‚ words = [\"a\", \"bb\", \"acd\", \"ace\"]å­˜å‚¨çš„ç»“æžœæ˜¯: \n|  idx | pair |\n| --- | --- |\n| â€˜a' | [(0, 1), (2, 1), (3, 1)] |\n| â€˜b' | [(1, 1)] |\n\n\n\n```c++\nint numMatchingSubseq(string S, vector<string>& words) {\n    vector<pair<int, int>> waiting[128];\n    for (int i = 0; i < words.size(); i++)\n        waiting[words[i][0]].emplace_back(i, 1);\n    for (char c : S) {\n        auto advance = waiting[c];\n        waiting[c].clear();\n        for (auto it : advance)\n            waiting[words[it.first][it.second++]].push_back(it);\n    }\n\n    return waiting[0].size();\n}\n```\n\n"},{"title":"1011. Capacity To Ship Packages Within D Days","url":"/2019/06/14/1011-Capacity-To-Ship-Packages-Within-D-Days/","content":"## [é¢˜ç›®](https://leetcode.com/problems/capacity-to-ship-packages-within-d-days/)\n## åˆ†æž\næ¥è‡ªVladç¥žçš„è§£ç­”https://leetcode.com/problems/capacity-to-ship-packages-within-d-days/discuss/256737/C%2B%2B-Binary-Search \n\nå…ˆå®šä¸‹å¯èƒ½çš„æ‰¿é‡èŒƒå›´: \n1. æœ€å¤§ maxCap æ˜¯æ‰€æœ‰åŒ…è£¹çš„é‡é‡å’Œ\n2. æœ€å° minCap = max{ maxCap/D, æœ€é‡çš„åŒ…è£¹é‡é‡) \n3. ç”¨ Binary Search æŸ¥æ‰¾ `the least weight capacity of the ship`, è¯¥èˆ¹èƒ½åœ¨Då¤©å†…è¿é€å®Œæ‰€æœ‰è´§ç‰©\n\n```c++\n// æ±‚è½½è´§åŠ›ä¸º capacity çš„èˆ¹è¿å®Œæ‰€æœ‰è´§ç‰©çš„å¤©æ•°\nint countDays(vector<int>& weights, int capacity) {\n    int count = 1, load = 0;\n    for (auto w: weights) {\n        load += w;\n        if (load > capacity) {\n            // è¶…è¿‡è½½é‡èƒ½åŠ›ï¼Œç¬¬äºŒå¤©ç»§ç»­è¿è½½\n            load = w;\n            count++;\n        }\n    }\n\n    return count;\n}\n\nint shipWithinDays(vector<int>& weights, int D) {\n    auto maxCap = std::accumulate(weights.begin(), weights.end(), 0);\n    auto minCap = max(*max_element(weights.begin(), weights.end()), maxCap / D);\n    // Binary Search \n    while (minCap < maxCap) {\n        int mid = (minCap + maxCap) / 2;\n        if (countDays(weights, mid) <= D) {\n            maxCap = mid;\n        } else {\n            minCap = mid + 1;\n        }\n    }\n\n    return minCap;\n}\n\n```","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"LeetCode:1014. Best Sightseeing Pair","url":"/2019/06/11/LeetCode-1014-Best-Sightseeing-Pair/","content":"\n## é¢˜ç›®ï¼š [1014. Best Sightseeing Pair](https://leetcode.com/problems/best-sightseeing-pair/)\n \n\n### åˆ†æž\nè¿™é“é¢˜æ±‚ `the maximum score of a pair of sightseeing spots`; score = A[i] + A[j] + i - j)ã€‚ æ˜¯ä¸ªæœ€ä¼˜è§£é—®é¢˜ã€‚  \nè¿­ä»£ä¸­ï¼Œå½“å‰idxä¸ºi; è¦è€ƒè™‘ (0, i-1)çš„æ•°ä¸­å¯¹scoreå¢žç›Šæœ€å¤§çš„æ•°çš„ä¸‹æ ‡æ˜¯max_idxã€‚ è®¡ç®— (max_idx, i)çš„scoreï¼Œ å¹¶è·Ÿä¹‹å‰æœ€å¤§å€¼åšæ¯”è¾ƒã€‚\n\n```c++\nint maxScoreSightseeingPair(vector<int> & A) {\n    // 2<= A.length <= 50000\n    int max_idx = 0, res = A[0], inc = 0;\n    for (int i = 1; i < A.size(); ++i) {\n        inc = A[max_idx] - i + max_idx;\n        res = max(res, A[i] + inc);\n        max_idx = A[i] > inc ? i : max_idx;\n    }\n\n    return res;\n}\n```\n\n**æ›´ä¸ºç®€çº¦çš„å†™æ³•ï¼š**\nmax_incæ¯æ¬¡è¿­ä»£åŽéƒ½è‡ªå‡1ï¼Œæ˜¯å› ä¸ºè¿›å…¥ä¸‹ä¸€æ¬¡è¿­ä»£i+1çš„æ—¶å€™ï¼Œå®ƒå¯¹åˆ†æ•°çš„å¢žç›Šåªå‰©ä¸‹äº†A[max_inc] + i - (i+1)ã€‚\n```c++\nint maxScoreSightseeingPair2(vector<int>& A) {\n    int max_inc = A[0] - 1, res = 0;\n    for (int i = 1; i < A.size(); ++i, max_inc--) {\n        res = max(res, max_inc + A[i]);\n        max_inc = max(A[i], max_inc);\n    }\n\n    return res;\n}\n```\n\næ—¶é—´å¤æ‚åº¦: $o(n)$","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"ExpoKitæ¨¡å¼é…ç½®Push Notification","url":"/2019/06/10/React-Native-ExpoKit-Notification/","content":"\nExpo sdkå·²ç»æœ‰ä¸€å¥—Push Notificationsçš„æ–¹æ¡ˆï¼ŒæŽ¥å…¥æ–¹ä¾¿, ä½†éœ€è¦æœåŠ¡ç«¯é…åˆæŽ¥å…¥å¯¹åº”sdk.è€Œexpo-server-sdkä¸­é»˜è®¤ä½¿ç”¨Google Cloud Messaging å’Œ APNSï¼› å› ä¸ºAndroidå›½å†…æ— æ³•ç”¨è°·æ­Œçš„æœåŠ¡ï¼Œå†åŠ ä¸Šæ²¡æœ‰æœåŠ¡ç«¯å¯¹åº”å¼€å‘è¯­è¨€çš„sdk, æˆ‘ä»¬æœ€åŽè¿˜æ˜¯é€‰äº†ä¼ ç»Ÿçš„æ–¹å¼ã€‚\n\n## Expo Eject \nç”¨expoåˆ›å»ºçš„RNé¡¹ç›®å·²ç»ä¸å†æœ‰ios/ & android/çš„å·¥ç¨‹é…ç½®æ–‡ä»¶å¤¹ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦å…ˆç”¨ `expo eject`å‘½åç”ŸæˆiOSè·ŸAndroidçš„å·¥ç¨‹é…ç½®æ–‡ä»¶, ã€‚\n\n`expo eject`ä¼šæ”¹å˜å¼€å‘æµç¨‹ï¼Œæ¯”å¦‚ï¼Œè¦è¿è¡Œä¸€ä¸ªé¡¹ç›®ï¼Œä¸æ­¢è¦`expo start`ï¼Œ è¿˜è¦ç”¨Xcodeæˆ–è€…AndroidStudio Runä¸€ä¸ªnativeé¡¹ç›®ã€‚ æ‰€ä»¥çœŸçš„è¦é€šè¯»è¿™ä¸ªæ–‡æ¡£ï¼Œä»”ç»†è€ƒè™‘è¦ä¸è¦è¿™ä¹ˆåš[Ejecting to ExpoKit - Expo Documentation](https://docs.expo.io/versions/latest/expokit/eject/#__next)\n\n1. é¦–å…ˆï¼Œæˆ‘ä»¬è¦checkä¸€ä¸‹app.jsonå¯¹ä¸å¯¹https://docs.expo.io/versions/latest/distribution/building-standalone-apps/#2-configure-appjson\n\n2. æŽ¥ç€ï¼Œè¿è¡Œ`expo eject`å‘½ä»¤ï¼Œä¼šæœ‰å¦‚ä¸‹æç¤º, æˆ‘é€‰ç¬¬ä¸‰ä¸ªï¼ŒExpoKitã€‚ ExpoKitæ˜¯Objective-C å’ŒJavaåº“ï¼Œ å°†nativeå¼€å‘è·Ÿexpoå¹³å°å¼€å‘ç»“åˆèµ·æ¥ã€‚\n\n```\nIt's recommended to commit all your changes before proceeding,\nso you can revert the changes made by this command if necessary.\n\n? How would you like to eject your app?\n  Read more: https://docs.expo.io/versions/latest/expokit/eject/\n  React Native: I'd like a regular React Native project.\nâ¯ ExpoKit: I'll create or log in with an Expo account to use React Native and the Expo SDK.\n  Cancel: I'll continue with my current project structure.\n```\nä½ ä¼šå‘çŽ°å¤šäº†ä¸¤ä¸ªç›®å½•\n```\nrn-project/\n  - ios/\n  - android/\n```\n## è¿è¡ŒNativeå·¥ç¨‹\n\nReact Native packageræ–¹é¢ï¼Œè¦åƒä»¥å‰é‚£æ ·ï¼Œè¿è¡Œ`expo start`ã€‚ \næŽ¥ç€é…ç½®nativeå·¥ç¨‹ã€‚ä»¥iOSä¸ºä¾‹: \n\n1. è¿›å…¥iosæ–‡ä»¶å¤¹, pod install (å¦‚æžœé‡åˆ°undefined method'native_target', è¯·å‚è€ƒ[Issues Â· expo/expo Â· GitHub](https://github.com/expo/expo/issues/2401d), å°†cocoapodsé™åˆ°1.5.3ç‰ˆæœ¬ã€‚ \n2. æ‰“å¼€xcwordspaceæ–‡ä»¶ï¼Œæ­£å¸¸buid & run iOSé¡¹ç›®\n\n appå¯åŠ¨çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨è¯·æ±‚å¹¶åŠ è½½JS bundleã€‚å¦‚æžœæˆ‘ä»¬ä¿®æ”¹äº†jsæ–‡ä»¶ï¼Œå†ä¿å­˜ï¼Œhot-updateä¹Ÿç”Ÿæ•ˆçš„.\n \n## é…ç½® PushNotificationIOS \n[å®˜æ–¹æ•™ç¨‹PushNotificationIOS Â· React Native](https://facebook.github.io/react-native/docs/pushnotificationios) å¾ˆæ˜¯éº»çƒ¦ï¼Œè¿˜å®¹æ˜“æŠ¥ä¸€å †è¿™ä¸ªé‚£ä¸ªæ‰¾ä¸åˆ°çš„é”™è¯¯ã€‚\n\n```\nRCTPushNotificationManager.h not found\nReact/RCTEventEmitter.h file not found\n```\nå…¶å®žå®ƒæœ¬è´¨ä¸Šæ˜¯xcodeprojectè¦æ‰‹åŠ¨link RCTPushNotification libï¼Œæˆ‘ä»¬å¤§å¯ä»¥ç›´æŽ¥ä¿®æ”¹Podfileæ–‡ä»¶ï¼Œå¦‚ä¸‹: \n- æœ€åŽä¸€è¡Œï¼Œæ·»åŠ `RCTPushNotification`\n- å†runä¸€ä¸‹`pod install`\n- é‡æ–°`build`.\n\n```\n  pod 'React',\n    :path => \"../node_modules/react-native\",\n    :inhibit_warnings => true,\n    :subspecs => [\n      \"Core\",\n      \"ART\",\n      \"RCTActionSheet\",\n      \"RCTAnimation\",\n      \"RCTCameraRoll\",\n      \"RCTGeolocation\",\n      \"RCTImage\",\n      \"RCTNetwork\",\n      \"RCTText\",\n      \"RCTVibration\",\n      \"RCTWebSocket\",\n      \"DevSupport\",\n      \"CxxBridge\",\n      \"RCTPushNotification\"\n    ]\n```","categories":["React Native"]},{"title":"ç†è§£æ‰‹æœºGPSå®šä½åŽŸç†","url":"/2019/06/08/ç†è§£GPSå®šä½åŽŸç†/","content":"\næœ¬æ–‡å–æè‡ª TEDæ•™å­¦è§†é¢‘[How does your smartphone know your location? - Wilton L. Virgo](https://www.youtube.com/watch?v=70cDSUI4XKE)\næˆ‘ä»¬çš„æ‰‹æœºæ˜¯å¦‚ä½•å‡†ç¡®å®šä½çš„å‘¢ï¼Ÿ ç­”æ¡ˆåœ¨ç¦»æˆ‘ä»¬2000å¤šè‹±é‡Œçš„å«æ˜Ÿä¸Šã€‚\n\nç¬¬ä¸€ä¸ªé—®é¢˜ï¼š ä¸ºå•¥å«æ˜Ÿä¸Šçš„æ—¶é—´å¯¹GPSå®šä½å¦‚æ­¤é‡è¦ï¼Ÿ å› ä¸ºæˆ‘ä»¬è¦çŸ¥é“æ‰‹æœºè·Ÿå«æ˜Ÿçš„è·ç¦»ã€‚ æ¯ä¸ªå«æ˜Ÿåœ¨ä¸æ–­å¯¹å¤–å¹¿æ’­ä¿¡å·ã€‚ä¿¡å·ä¸­è®°å½•è‡ªå·±çš„åˆ›å»ºæ—¶é—´ã€‚\n\n\n![48bce392.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/48bce392.png)\n\næ‰‹æœºæ”¶åˆ°ä¿¡å·åŽï¼Œåˆ©ç”¨æ”¶åˆ°ä¿¡å·çš„åˆ°è¾¾æ—¶é—´ï¼Œ è®¡ç®—è‡ªå·±è·Ÿå«æ˜Ÿçš„è·ç¦»: \n\n$$distance = c * \\Delta T $$\n\nc: å…‰çš„é€Ÿåº¦\n$\\Delta T$: ä¿¡å·ä¼ æ’­çš„æ—¶é—´é—´éš” $time_{arrive} - time_{create}$\n\nä½†æ˜¯c = 299,792,458 m/s, éžå¸¸å¤§ã€‚ å¦‚æžœç”¨ç§’åšå•ä½è®¡ç®—$\\Delta T$ï¼Œ åœ°çƒä¸Šæ‰€æœ‰ç‚¹ï¼Œç”šè‡³æœ‰äº›è¿œç¦»æˆ‘ä»¬çš„ä½ç½®ï¼Œè®¡ç®—å‡ºæ¥çš„distanceéƒ½æ˜¯ä¸€æ ·çš„å€¼ã€‚ \n\n![f8edfbb6.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/f8edfbb6.png)\n\n\næ‰€ä»¥æˆ‘ä»¬éœ€è¦éžå¸¸éžå¸¸éžå¸¸ç²¾ç¡®çš„æ—¶é’Ÿè®¡ç®—æ—¶é—´. äºŽæ˜¯åŽŸå­é’Ÿç²‰å¢¨ç™»åœº. å°±åƒæœºæ¢°é’Ÿé å˜€å—’å˜€å—’æ‘‡æ‘†æ¥è®¡æ—¶ï¼Œ åŽŸå­é’Ÿä¹Ÿæœ‰è¿™ç§é—´éš”æ—¶é—´å›ºå®šçš„æ»´ç­”æ»´ç­”è®¡æ—¶æ–¹å¼ã€‚ \n\n## åŽŸå­é’Ÿ\n\n![782d2620.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/782d2620.png)\nåŽŸå­é’Ÿä¾èµ–åŽŸå­è·ƒè¿æ‰€é‡Šæ”¾æˆ–å¸æ”¶çš„ç”µç£æ³¢æ¥è®¡æ—¶ã€‚åŽŸå­åœ¨ä¸€ä¸ªè½¨é“è·‘äº†ä¸€åœˆåŽï¼Œè·ƒè¿åˆ°å¦ä¸€ä¸ªè½¨é“çš„æ—¶å€™ä¼šä»¥ç”µç£æ³¢å½¢å¼é‡Šæ”¾å‡ºèƒ½é‡ã€‚\n\n![a68ec7af.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/a68ec7af.png)\n\nèƒ½é‡è®¡ç®—å…¬å¼ï¼š $\\Delta E = h \\nu$ $\\Delta E$ å˜åŒ–çš„èƒ½é‡; hæ˜¯å¸¸é‡(h=6.626x$10^{-34}$ Js)ã€‚ $\\nu$æ˜¯é¢‘çŽ‡ã€‚ æ¯”å¦‚é“¯åŽŸå­é’Ÿï¼Œå®ƒçš„é¢‘çŽ‡æ˜¯ä¸ªå›ºå®šå€¼ 9,192,631,770Hzï¼Œä½ å¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªæ¯ç§’è·‘9billionåœˆçš„æ—¶é’Ÿã€‚æ‰€ä»¥ç”¨åŽŸå­é’Ÿå¯ä»¥æ¯ç§’ç²¾ç¡®åˆ° 1/1billionã€‚ \n\n![0bc32fc3.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/ca6ea804.png)\nè¿™å¼ å›¾çš„detectoræ˜¯ç”¨æ¥æ£€æµ‹probe laserå›ºå®šé¢‘çŽ‡å‘å‡ºçš„ç”µç£æ³¢ã€‚\n\n\næœ‰äº†ç²¾ç¡®çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æ‰‹æœºè·Ÿå«æ˜Ÿçš„è·ç¦»ã€‚ ä»¥å«æ˜Ÿä¸ºä¸­å¿ƒï¼Œdistanceä¸ºåŠå¾„ç”»åœ†(çƒ)\n\n![f58c51ad.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/f58c51ad.png)\n\nå¦‚æžœå¤šå‡ ä¸ªå«æ˜Ÿï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‡ ä½•å…¬å¼è®¡ç®—å‡ºå®ƒä»¬çš„ç©ºé—´äº¤å‰ç‚¹\n\n![293478f1.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/293478f1.png)\n\n![6cbd0ed3.png](/img/a9bb4ba0-9918-4e5c-9fc0-3b9a28363e6b/6cbd0ed3.png)\n\n","categories":["LBS"]},{"title":"714. Best Time to Buy and Sell Stock with Transaction Fee","url":"/2019/06/06/714-Best-Time-to-Buy-and-Sell-Stock-with-Transaction-Fee/","content":"\n##  [é¢˜ç›®](https://leetcode.com/problems/best-time-to-buy-and-sell-stock-with-transaction-fee)\n\n## åˆ†æž\n\n### å®šä¹‰ä¸¤ä¸ªçŠ¶æ€å˜é‡: \n- buy_profit: è‹¥i-1å¤©ï¼ŒæŒæœ‰è‚¡ç¥¨ï¼Œæœ€å¤§åˆ©æ¶¦æ˜¯ $(buy_profit)\n- sell_profit: è‹¥i-1å¤©ï¼Œå–å‡ºè‚¡ç¥¨, æœ€å¤§åˆ©æ¶¦æ˜¯ $(sell_profit)\n\n### ä¹°å–åˆ©æ¶¦æƒ…å†µï¼š \n\n**æœ€å¼€å§‹**: i == 0;  `int buy_profit = -prices[0], sell_profit = 0`\n**ç¬¬iå¤©**: \n\n- å½“å¤©ä¹°: \n    - ç»´æŒi-1å¤©æŒæœ‰, ä¸å˜ï¼› $buy\\_profit_i == buy\\_profit_{i-1}$ \n    - i-1å¤©å–å‡ºï¼Œiå¤©ä¹°è¿› (å› ä¸ºé¢˜ç›®è¦æ±‚æ¯æ¬¡åªèƒ½ä¹°1 share of stock, ä¹°å…¥å‰å¿…é¡»æŠŠæ‰‹ä¸Šçš„stockéƒ½å–å‡º); $buy\\_profit_i = sell\\_profit_{i-1} - prices[i]$\n- å½“å¤©å–:  \n    - i-1å¤©æŒæœ‰ï¼Œiå¤©å–å‡º; å½“å¤©çš„åˆ©æ¶¦ä¸º $sell\\_profit_i=buy\\_profit_i-1 + prices[i] - fee$\n    - i-1å¤©å·²ç»å–å‡ºï¼Œå½“å¤©ä¸æ“ä½œï¼›åˆ©æ¶¦ä¸º $sell\\_profit_i == sell\\_profit_{i-1}$ \n    \næ¯ä¸ªiè¿­ä»£ï¼Œæˆ‘ä»¬éƒ½è¦è€ƒè™‘è¿™å››ç§æƒ…å†µï¼Œè®¡ç®—å‡ºbuy_profitè·Ÿsell_profitçš„å±€éƒ¨æœ€ä¼˜. \n\n\n### ä¾‹å­\nInput: prices = [1, 3, 2, 8, 4, 9], fee = 2\n\næœ€ä¼˜æ“ä½œï¼š \n\n|  | 1 | 3 | 2 | 8 | 4 | 9 |\n| --- | --- | --- | --- | --- | --- | --- |\n| max buy_profit | -1 | -1 max{-1, -3} | -1 max{-1, -2}| -1 max{-1, 8}| 1 max{1, -4} | 1 max{1, -4}|\n| max sell_profit | 0 | 0 max{0, 0}| 0 max{0, -1}| 5 max{0, 5}| 5 max{5, 3}| 8 {5, 8}|\n\n### è´ªå¿ƒç®—æ³•\nA greedy algorithm always makes the choice that `looks best at the moment` That is, it makes a `locally optimal choice` in the hope that this choice will `lead to a globally optimal solution`. \n\n\n## Greedy Algorithm   \n\n\n```c++\nint maxProfit(vector<int>& prices, int fee) {\n    if (prices.empty()) return 0;\n    int buy_profit = -prices[0], sell_profit = 0;\n    for (int i = 1; i < prices.size(); ++i) {\n        buy_profit = max(buy_profit, sell_profit - prices[i]);\n        sell_profit = max(sell_profit, buy_profit + prices[i] - fee);\n     }\n\n    return sell_profit;\n}\n```\næˆ–è€…\n\n```c++\n    int maxProfit(vector<int>& prices, int fee) {\n      int n = prices.size();\n      if (n <= 1 ) return 0; // need at least 2 days to make a transactions\n      \n      vector<int> buys (n); // buys [i] means max money on day i ending in buy  state (have stock in hand)\n      vector<int> sells(n); // sells[i] means max money on day i ending in sell state (no stock in hand)\n      \n      buys [0] = -prices[0];\n      sells[0] = 0;\n      \n      for (int i = 1; i < n; ++i) {\n        buys [i] = max(buys [i-1], sells[i-1]-prices[i]);     // buy  state to buy  state: continue holding onto stock\n                                                              // sell state to buy  state: buy on day i\n        sells[i] = max(sells[i-1], buys [i-1]+prices[i]-fee); // sell state to sell state: continue not holding any stock\n                                                              // buy  state to sell state: sell on day i\n      }\n      return sells[n-1];\n    }\n```\næ—¶é—´å¤æ‚åº¦: $o(n)$","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"LeetCode:413. Arithmetic Slices","url":"/2019/06/04/LeetCode-413-Arithmetic-Slices/","content":"\n##  [413. Arithmetic Slices](https://leetcode.com/problems/arithmetic-slices/)\nè¿™é“é¢˜ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæ±‚æ•°ç»„é‡Œï¼Œç­‰å·®åºåˆ—çš„ä¸ªæ•°ã€‚ \n\næ¯”å¦‚\n```\nA = [1, 2, 3, 4]\næœ‰3ä¸ªç­‰å·®æ•°åˆ—\n[1, 2, 3], [2, 3, 4], [1, 2, 3, 4]\n```\n\né¢˜ç›®æ²¡æœ‰è¯´æ˜ŽAæ˜¯ç­‰å·®æ•°åˆ—ï¼Œæ‰€ä»¥ä¹Ÿè¦è€ƒè™‘Aä¸æ˜¯ç­‰å·®æ•°åˆ—ï¼Œä½†æ˜¯å…¶å­æ•°ç»„æ˜¯ç­‰å·®æ•°åˆ—çš„æƒ…å†µã€‚\n```\nA = [1, 3, 5, 7, 9, 15, 20, 25]\n1, 3, 5\n\n3, 5, 7\n1, 3, 5, 7\n\n5, 7, 9\n3, 5, 7, 9\n1, 3, 5, 7, 9\n\n15, 20, 25\n```\n\n## Solution \n\n```c++\nint numberOfArithmeticSlices(vector<int>& A) {\n    int dp = 0;\n    int sum = 0;\n\n    for (int i = 2; i < A.size(); ++i) {\n        if (A[i] - A[i-1] == A[i-1] - A[i-2])  {\n           dp = 1+dp;\n           sum += dp;\n        } else {\n           dp = 0;\n        }\n    }\n    return sum;\n}\n```","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"ReactNativeå¼€å‘-ç¥žå™¨Reactoron","url":"/2019/05/23/ReactNative-reactoron/","content":"Reactoronèƒ½æ”¹å–„React Nativeå¼€å‘ä½“éªŒã€‚ \n<!--more--> \n \nReactoronè¿™ä¸ªå¼€å‘å·¥å…·ï¼ŒæŠŠæˆ‘ä»¬è¾“å‡ºçš„æ—¥å¿—åƒtwitterä¿¡æ¯æµä¸€æ ·ä¿å­˜èµ·æ¥ï¼Œç­‰æˆ‘ä»¬éœ€è¦çš„æ—¶å€™ï¼Œå¯ä»¥å›žè¿‡å¤´è¿‡æ»¤æ‰¾åˆ°æ—¥å¿—ï¼Œå±•å¼€æ—¥å¿—è¯¦æƒ…æŸ¥çœ‹ã€‚æé«˜ReactNativeå¼€å‘æ•ˆçŽ‡ã€‚ çœ‹æ—¥å¿—ä¼šç‰¹åˆ«æ–¹ä¾¿ï¼Œä½“éªŒä¹Ÿä¸é”™ã€‚\n\n![image](https://github.com/infinitered/reactotron/raw/master/docs/images/quick-start-react-native/react-demo-native-reactotron.jpg)\n\né¡¹ç›®åœ°å€ï¼š [GitHub - infinitered/reactotron: A desktop app for inspecting your React JS and React Native projects. macOS, Linux, and Windows.](https://github.com/infinitered/reactotron)\n\nä¸‹è½½æœ€æ–°çš„releaseåŒ…ï¼Œæœ¬åœ°å®‰è£…ã€‚\n\n## ä½¿ç”¨\n\n### 1. é›†æˆåœ¨React Nativeé¡¹ç›®ä¸­\n\n```sh\nnpm i --save-dev reactotron-react-native\n// or\nyarn add reactotron-react-native --dev\n```\n\n### 2. é…ç½®æ–‡ä»¶\n\nåˆ›å»º`ReactotronConfig.js`\n\nåŸºç¡€ç”¨æ³•ï¼š\n```js\nimport Reactotron from 'reactotron-react-native'\n\nReactotron\n  .configure() // controls connection & communication settings\n  .useReactNative() // add all built-in react native plugins\n  .connect() // let's connect!\n```\né«˜çº§é…ç½®: \n\n```js\nimport Reactotron from 'reactotron-react-native'\n\nReactotron\n  .configure({\n    name: \"React Native Demo\"\n  })\n  .useReactNative({     \n      asyncStorage: {ignore: []},\n      networking: {\n          ignoreUrls: new RegExp(`http://127.0.0.1:19000/logs`)\n      },\n      editor: false,\n      errors: {veto: (stackFrame) => false},\n      overlay: false,})\n  .connect();\n```\n\n#### asyncStorage \n\nå‚æ•°ç±»åž‹ï¼š\n\n```js\nexport interface AsyncStorageOptions {\n    ignore?: string[];\n}\n```\n\n`ignore`çš„å€¼ï¼Œä¼ å…¥keyæ•°ç»„ï¼Œ`reactotron`ä¸ä¼šå±•ç¤ºè¿™äº›keyçš„å­˜å‚¨æ•°æ®\n\n#### networking\nå‚æ•°ç±»åž‹ï¼š \n```js\nexport interface NetworkingOptions {\n    ignoreContentTypes?: RegExp; // å¦‚æžœresponseçš„Content-TypeåŒ¹é…ä¸Šè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸å±•ç¤ºresponseï¼Œ\n    ignoreUrls?: RegExp; //  è¦å¿½ç•¥çš„urls\n}\n```\nä¾‹å­ï¼š\n```js networking({\n  ignoreContentTypes: /^(image)\\/.*$/i,\n  ignoreUrls: /\\/(logs|symbolicate)$/,\n})\n```\n\n\n#### Error \nå‚æ•°ç±»åž‹ï¼š\n```js\nexport interface TrackGlobalErrorsOptions {\n    veto?: (frame: any) => boolean;\n}\n```\n`veto`å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæŒ‡å®šæˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„å †æ ˆä¿¡æ¯.è¿™é‡Œçš„frameæŒ‡stack frame.\n\næ¯”å¦‚ï¼š å¦‚ä¸‹å¿½ç•¥æŠ¥é”™æ—¶æ‰€æœ‰react-native moduleé‡Œå¤´çš„stack frame.\n```js\nReactotron\n  .configure()\n  .use(trackGlobalErrors({\n    veto: frame => frame.fileName.indexOf('/node_modules/react-native/') >= 0\n   }))\n  .connect()\n```\n### 3. improt\n\n åœ¨`App.js` æˆ–è€…`index.js`æ–‡ä»¶å¤´ä¸­å¼•å…¥ï¼š\n \n```js\nif(__DEV__) {\n  import('./ReactotronConfig').then(() => console.log('Reactotron Configured'))\n}\n```\n\n### 4. æ‰“ç‚¹\n\nåƒç”¨`console.log`ä¸€æ ·ï¼Œè°ƒç”¨ `Reactotron.log`\n\nReactNativeé¡¹ç›®è·‘èµ·æ¥åŽï¼Œå¯ä»¥åœ¨Reactotroné¢æ¿ä¸Šçœ‹åˆ°ï¼š \n\n![9b1dbee4.png](https://github.com/infinitered/reactotron/raw/master/docs/images/quick-start-react-native/hello-1.jpg)\n\nå…¶ä»–APIï¼š \n```js\nReactotron.log({ numbers: [1, 2, 3], boolean: false, nested: { here: 'we go' } })\n\nReactotron.warn('*glares*')\nReactotron.error('Now you\\'ve done it.')\nReactotron.display({\n  name: 'KNOCK KNOCK',\n  preview: 'Who\\'s there?',\n  value: 'Orange.'\n})\n\nReactotron.display({\n  name: 'ORANGE',\n  preview: 'Who?',\n  value: 'Orange you glad you don\\'t know me in real life?',\n  important: true\n})\n\n```\n\n## Reduxçš„æ•°æ®ä¿¡æ¯\n[reactotron/plugin-redux.md at master Â· infinitered/reactotron Â· GitHub](https://github.com/infinitered/reactotron/blob/master/docs/plugin-redux.md)\n![](https://github.com/infinitered/reactotron/raw/master/docs/images/redux/redux-keys-values.jpg)\n\n[YouTube](https://www.youtube.com/watch?v=UiPo9A9k7xc)\n\n\n","tags":["React Native Dev"],"categories":["React Native"]},{"title":"LeetCode:542. 01 Matrix-DP","url":"/2019/05/23/LeetCode-542-01-Matrix-DP/","content":"Given a matrix consists of 0 and 1, find the distance of the nearest 0 for each cell.\n\n<!--more-->\n \n\n## é¢˜ç›®: [01-matrix](https://leetcode.com/problems/01-matrix/)\nGiven a matrix consists of 0 and 1, find the distance of the nearest 0 for each cell.\n\nThe distance between two adjacent cells is 1.\n```\nExample:\nInput:\n[[0,0,0],\n [0,1,0],\n [1,1,1]]\n\nOutput:\n[[0,0,0],\n [0,1,0],\n [1,2,1]]\n```\n## åˆ†æžï¼š \né¢˜ç›®æœ‰ç‚¹æ²¡è®²æ˜Žç™½ï¼Œè¿™é“é¢˜ï¼Œæ±‚å€¼ä¸º1çš„cellåˆ°æœ€è¿‘çš„0çš„æœ€çŸ­è·ç¦»ã€‚\n\nè¿™é“é¢˜ï¼Œæˆ‘çš„ç¬¬ä¸€æƒ³æ³•æ˜¯BFSï¼ŒåŽæ¥çœ‹åˆ°DPå†™æ³•æ›´ä¼˜é›…ã€‚[Simple-Java-solution](https://leetcode.com/problems/01-matrix/discuss/101051/Simple-Java-solution-beat-99-(use-DP))\n\nå¯ä»¥å‘çŽ°è§„å¾‹ã€‚å¯¹matrix[i][j], å¦‚æžœçŸ¥é“å®ƒä¸Šä¸‹å·¦å³å››ä¸ªcellåˆ°0çš„æœ€çŸ­è·ç¦»ï¼Œé‚£ä¹ˆ\n$$matrix[i][j] = min(left, top, right, bottom) + 1$$\n\n1. éåŽ†matrixçŸ©é˜µï¼Œmatrix[i][j]ä¸ä¸º0ï¼Œè®¡ç®— leftCell è·Ÿ topCellæœ€å°å€¼ï¼Œå†åŠ 1. \n2. å†å€’å™éåŽ†matrix, matrix[i][j]ä¸ä¸º0, å…ˆè®¡ç®—rightCell è·Ÿ topCellçš„æœ€å°å€¼ï¼Œå†è·Ÿmin(left, top)çš„å€¼æ¯”è¾ƒ\n\n```c++\n vector<vector<int>> updateMatrix(vector<vector<int>>& matrix) {\n     if (matrix.empty()) return {};\n     int n = (int)matrix.size(), m = (int)matrix[0].size(), MAX_LEN = 10002;\n     for (int i = 0; i < n; ++i) {\n         for (int j = 0; j < m; ++j) {\n             if (matrix[i][j] != 0) {\n                 int top = (i - 1 < 0) ? MAX_LEN : matrix[i-1][j];\n                 int left = (j - 1 < 0) ? MAX_LEN : matrix[i][j-1];\n                 matrix[i][j] = 1 + min(top, left);\n             }\n         }\n    \n     for (int i = n - 1; i >= 0; i--) {\n         for (int j = m - 1; j >= 0; j--) {\n             if(matrix[i][j] != 0) {\n                 int right = (j + 1 >= m) ? MAX_LEN: matrix[i][j+1];\n                 int bottom = (i + 1 >= n) ? MAX_LEN: matrix[i+1][j];\n                 matrix[i][j] = min(min(right, bottom) + 1, matrix[i][j]);\n             }\n         }\n     }\n     return matrix;\n }\n```\n### æ—¶é—´å¤æ‚åº¦ $o(n^2)$\n### ç©ºé—´å¤æ‚åº¦ $o(1)$\n\n```\nRuntime: 184 ms, faster than 96.53% of C++ online submissions for 01 Matrix.\nMemory Usage: 20.9 MB, less than 91.39% of C++ online submissions for 01 Matrix.\n```\næœ‰äººé—®ï¼Œä¸ºå•¥è¦ä¸¤æ¬¡éåŽ†ï¼Ÿ ä¸èƒ½åƒä¸‹é¢è¿™ä¹ˆå†™å—ï¼Ÿ\n\n```c++\n// é”™è¯¯çš„å†™æ³•\n vector<vector<int>> updateMatrix(vector<vector<int>>& matrix) {\n       if (matrix.empty()) return {};\n       int n = (int)matrix.size(), m = (int)matrix[0].size();\n       for (int i = 0; i < n; ++i) {\n           for (int j = 0; j < m; ++j) {\n               if (matrix[i][j] != 0) {\n                   int top = (i - 1 < 0) ? INT32_MAX : matrix[i-1][j];\n                   int left = (j - 1 < 0) ? INT32_MAX : matrix[i][j-1];\n                   int right = (j + 1 >= m) ? INT32_MAX : matrix[i][j+1];\n                   int bottom = (i + 1 >= n) ? INT32_MAX : matrix[i+1][j];\n                   matrix[i][j] = 1 + min(min(top, left), min(right, bottom));\n               }\n           }\n       }\n       return matrix;\n   }\n```\né—®é¢˜åœ¨äºŽï¼Œé¡ºåºéåŽ†æ—¶å€™ï¼Œbottomè·Ÿrightè¿˜æ²¡æ›´æ–°ä¸ºæ­£ç¡®çš„å€¼ã€‚æ¯”å¦‚ä¸‹å›¾ï¼ŒéåŽ†åˆ°matrix[3][0]çš„æ—¶å€™ï¼Œmatrix[3, 1] è¿˜æ˜¯1ï¼Œ è€Œmatrix[2][0] == 2; ç»“æžœå°±å‡ºé”™äº†ã€‚\n```\n0 0 0 0 0 \n1 0 0 0 0 \n1 1 1 0 0 \n1 1 1 1 0 \n```\n","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"LeetCode:650. 2 Keys Keyboard","url":"/2019/05/20/LeetCode-650-2-Keys-Keyboard/","content":"\n## é¢˜æ„: \nnotepadé‡Œåªæœ‰ä¸€ä¸ª'A'å­—ç¬¦ä¸²ã€‚ åªèƒ½å…è®¸ä¸¤ä¸ªæ“ä½œ: \n\n1. Copy All: æŠŠnotepadé‡Œæ‰€æœ‰çš„å­—ç¬¦ä¸²copy\n2. Paste: å¤åˆ¶ä¸Šæ¬¡copyçš„å†…å®¹\n\né—®ï¼Œæœ€å°‘çš„æ­¥éª¤ï¼ˆcopy & paste) èƒ½ç”Ÿæˆnä¸ª'A'\n\n## åˆ†æž\n\nå¯ä»¥å‘çŽ°è§„å¾‹: \n\n\n| n | op | cur char |\n| --- | --- | --- |\n| 2 | c | A |\n|  | p | AA |\n| 3 | c | A |\n|  | p | AA |\n|  | p | AAA |\n| 4 | c | A |\n|  | p | AA |\n|  | c | AA |\n|  | p | AAAA |\n| 5 | c | A |\n|  | p | AA |\n|  | p | AAA |\n|  | p | AAAA |\n|  | p | AAAAA |\n| 6 | c | A |\n|  | p | AA |\n|  | c | AA |\n|  | p | AAAAA |\n|  | p | AAAAAA |\n\nå½“nä¸ºè´¨æ•°ï¼Œ æ‰€éœ€æœ€å°‘æ­¥éª¤ä¸ºn; å½“nä¸æ˜¯è´¨æ•°ï¼Œ æ‰€éœ€æ­¥éª¤ä¸º nçš„è´¨å› æ•°ç›¸åŠ ä¹‹å’Œã€‚æ¯”å¦‚6 = 2 x 3;å®ƒæ‰€éœ€æœ€å°æ­¥éª¤ 2+3 = 5\n\n## Solution 1ï¼š è´¨å› æ•°åˆ†è§£\n```c++\nint minSteps(int n) {\n    int ans = 0, d = 2;\n    while (n > 1) {\n        while (n % d == 0)  {\n            ans += d;\n            n /= d;\n        }\n        d++;\n    }\n\n    return ans;\n}\n```\n\n## Solution 2: \n\n```c++\nint minSteps(int n) {\n    if (n <= 1) return 0;\n    if (n <= 5) return n;\n    // n>1çš„æ“ä½œï¼Œå‰ä¸¤æ­¥éª¤éƒ½æ˜¯copy & paste, ä»Ž'A'å˜æˆ 'AA', æ‰€ä»¥ cur_len == 2, res == 2, ä¸Šæ¬¡copyçš„å­—ç¬¦æ•°é‡ == 1, å¦‚æžœä¸‹ä¸€æ¬¡è¦copy & paste, è¦ä¸€æ¬¡copy'AA' 2ä¸ªå­—ç¬¦  \n    int cur_len = 2, res = 2, next_cp_num = 2, copy_num = 1;\n    while (cur_len < n) {\n        if ((n - cur_len) % next_cp_num == 0) {\n           // copy + paste\n           cur_len += next_cp_num;\n           copy_num = next_cp_num;\n           // copy + paste; 2 steps\n           res += 2;\n        } else {\n            // paste the characters copied last time \n            cur_len += copy_num;\n            // only paste, 1 step\n            res += 1;\n        }\n\n        // é¢˜ç›®è¦æ±‚ï¼šCopyæ“ä½œè¦Copyæ‰€æœ‰å­—ç¬¦\n        next_cp_num = cur_len;\n    }\n\n    return res;\n}\n```\n","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"å°ç™½è¯»è®ºæ–‡:Semantic Image Synthesis with Spatially-Adaptive Normalization","url":"/2019/05/18/Semantic-Image-Synthesis-with-Spatially-Adaptive-Normalization/","content":"[GauGAN: Changing Sketches into Photorealistic Masterpieces](https://www.youtube.com/watch?v=p5U4NgVGAwg&feature=youtu.be) 3æœˆçš„æ—¶å€™ï¼Œè‹±ä¼Ÿè¾¾å‘å¸ƒäº†ä¸€ä¸ªè§†é¢‘æŒºç«çš„ï¼š ä½ åªè¦ç²—ç•¥å‹¾å‹’ç®€å•çš„çº¿æ¡ï¼ŒAIå°±èƒ½ç”Ÿæˆé€¼çœŸçš„å†™å®žå›¾ç‰‡ã€‚\n\n\n  \n  \n\n\n<!--more-->\n[GauGAN: Changing Sketches into Photorealistic Masterpieces](https://www.youtube.com/watch?v=p5U4NgVGAwg&feature=youtu.be) 3æœˆçš„æ—¶å€™ï¼Œè‹±ä¼Ÿè¾¾å‘å¸ƒäº†ä¸€ä¸ªè§†é¢‘æŒºç«çš„ï¼š ä½ åªè¦ç²—ç•¥å‹¾å‹’ç®€å•çš„çº¿æ¡ï¼ŒAIå°±èƒ½ç”Ÿæˆé€¼çœŸçš„å†™å®žå›¾ç‰‡ã€‚\n\n![68747470733a2f2f6e766c6162732e6769746875622e696f2f53504144452f2f696d616765732f6f6365616e2e676966](https://camo.githubusercontent.com/a295a79daea9d1dd0cb16b48055607d0f17258b2/68747470733a2f2f6e766c6162732e6769746875622e696f2f53504144452f2f696d616765732f6f6365616e2e676966)\n[GitHubåœ°å€](https://github.com/NVlabs/SPADE)\né‚£å®ƒæ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿ è¿™ä¸ªé¡¹ç›®ç”¨çš„æ˜¯GANç®—æ³•ã€‚\n## GANæ¨¡åž‹çš„ä»»åŠ¡ï¼š \n**å­¦ä¹ ä»»åŠ¡** : è¾“å…¥semantic segmentation mask, åˆæˆ photorealistic imagesã€‚ \n\n`Semantic Image` æ˜¯å•¥å»ï¼Ÿ ç›´è§‚ä¸Šç†è§£ï¼Œå¦‚ä¸‹å›¾ï¼š \n\n![31085460.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/31085460.png)\n\n`Image segmentation`å‘¢ï¼Ÿ \n```\nImage segmentation is a computer vision task in which we label specific regions of an image according to what's being shown. \nthe goal of semantic image segmentation is to label each pixel of an image with a corresponding class of what is being represented.\n```\nå¦‚ä¸‹å›¾é‡Œçš„æ¯ä¸ªåƒç´ éƒ½è¢«åˆ†ç±»å½’å±žåˆ°ä¸åŒçš„class\n![Screen-Shot-2018-05-17-at-9.02.15-PM.png](https://www.jeremyjordan.me/content/images/2018/05/Screen-Shot-2018-05-17-at-9.02.15-PM.png)\n[å›¾ç‰‡æ¥æº](https://www.jeremyjordan.me/semantic-segmentation/#representing)\n\n## SPADE:  SPatially-Adaptive (DE)normalization\n\n### [Normalizaing training sets](https://mooc.study.163.com/learn/2001281003?tid=2001391036&_trace_c_p_k2_=5c39b3d9b1544824a0675bd3f4ed78d5#/learn/content?type=detail&id=2001701046)\né¦–å…ˆï¼Œè¦äº†è§£ä¸€ä¸‹Normalizationçš„å¤„ç†è·Ÿå¥½å¤„ã€‚\n\n**å¤„ç†**ï¼š ä»¥é€»è¾‘å›žå½’ä¸ºä¾‹, å®ƒçš„è¾“å…¥ç‰¹å¾$X$,æƒé‡$W$, mapå‡½æ•°å¦‚ä¸‹\n$$f(x) = \\sum_{i=1}^{n}x_i*w_i$$\n\n1. å…ˆæ±‚è¾“å…¥çš„ç‰¹å¾$x$çš„æœŸæœ›\n$$\\mu=\\frac{1}{n}\\sum_{i=1}^{n}x_i$$\n\n2. å†æ±‚$x$çš„æ–¹å·®\n\n$$\\sigma^2 = \\frac{1}{n} \\sum_{i=1}^{n}(x_i - \\mu)^2$$\n\n3. å†å¯¹è¾“å…¥ç‰¹å¾åšNormalization: \n$$\\frac{x-u}{\\sigma^2}$$\n\n**å¥½å¤„**æ˜¯ï¼Œç»è¿‡å¤„ç†çš„inputç‰¹å¾å€¼åˆ†å¸ƒæ›´é›†ä¸­å‡åŒ€ï¼Œ å¦‚ä¸‹å›¾çš„ç¬¬ä¸‰ä¸ªåæ ‡ç³»ï¼Œ \n![826f032b.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/826f032b.png)\n\nå¯¹äºŽæŸå¤±å‡½æ•°ï¼Œ\n$$J(w, x) = \\frac{1}{m}\\sum_{i=1}^{m}L(\\hat{y}, y)$$\nç”¨æ¢¯åº¦ä¸‹é™è®­ç»ƒWï¼ŒBçš„æ—¶å€™ï¼ŒNormalizationåŽï¼Œå½¢çŠ¶æ›´åœ†ä¸€äº›ï¼Œæ›´å®¹æ˜“ä¼˜åŒ–ã€‚æ— è®ºåˆå§‹ä»Žå“ªä¸ªä½ç½®å¼€å§‹ï¼Œä½ éƒ½å¯ä»¥ç”¨è¾ƒå¤§çš„æ­¥é•¿,æ¯”è¾ƒå®¹æ˜“æ‰¾åˆ°é€‚åˆçš„w,bçš„å€¼ï¼Œä½¿å¾—Jï¼ˆw,b)çš„å€¼æœ€å°ã€‚\n![6ad7add2.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/6ad7add2.png)\n\n### [Batch Normalization](https://mooc.study.163.com/learn/2001281003?tid=2001391036&_trace_c_p_k2_=f3e0afd9612c439a9f25d08040d39eab#/learn/content?type=detail&id=2001701055) \n[æ”¹å–„æ·±å±‚ç¥žç»ç½‘ç»œï¼šè¶…å‚æ•°è°ƒè¯•ã€æ­£åˆ™åŒ–ä»¥åŠä¼˜åŒ– - ç½‘æ˜“äº‘è¯¾å ‚](https://mooc.study.163.com/learn/2001281003?tid=2001391036&_trace_c_p_k2_=f3e0afd9612c439a9f25d08040d39eab#/learn/content?type=detail&id=2001701055)\n\nBatch Normä¸æ­¢normailize input feature;ä¹Ÿå¯å°†normalization processåº”ç”¨åœ¨ç¥žç»ç½‘ç»œä¸­çš„hidden layerä¸Šã€‚\n\n![747a0d26.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/747a0d26.png)\n\næ¯”å¦‚å¯¹éšè—å±‚$a^{[2]}$çš„è¾“å‡ºè¿›è¡Œæ­£åˆ™åŒ–å¤„ç†ï¼ŒåŠ é€Ÿä¸‹ä¸€å±‚çš„å‚æ•°$w^{[3]}$,$b^{[3]}$çš„è®­ç»ƒé€Ÿåº¦ã€‚æ¯”å¦‚$a^{[2]}$å±‚çš„ç¥žç»å•å…ƒåˆ†åˆ«æ˜¯ $z^{(1)}, z^{(2)}...z^{(m)}$\n\nå¯¹å®ƒçš„å¤„ç†æ˜¯\n1. æ±‚æœŸæœ›:\n$$\\mu = \\frac{1}{m}\\sum_{i=1}^{m}z_i$$\n2. æ±‚æ–¹å·®:\n$$\\sigma^2 = \\frac{1}{m}\\sum_{i=1}^{m}(z_i - u)^2$$\n3. norimal\n$$z_i = \\frac{z_i-u}{\\sqrt{\\sigma^2 + \\varepsilon}}$$\nåŠ ä¸Š$\\varepsilon$æ˜¯é˜²æ­¢$\\sigma^2$ä¸º0\n4. åŠ ä¸Š $\\gamma$ è·Ÿ $\\beta$ï¼› `scale and shift the normalized value`\n$$\\hat{z} = \\gamma z_i + \\beta$$\n \n\n$\\gamma$ è·Ÿ $\\beta$ ä¹Ÿæ˜¯å‚æ•°ï¼Œè·Ÿ`w, b`ä¸€æ ·åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿­ä»£å­¦ä¹ ã€‚ ç¥žç»ç½‘ç»œä¸­ä»–ä»¬ä¹Ÿå¸¸åœ¨æ¿€æ´»å±‚ä¹‹å‰è¿›è¡ŒBatch Normalizationå¤„ç†ã€‚ \n\n### (Spatially-Adaptive normalization)SPADE\nè¿™ç¯‡è®ºæ–‡æå‡ºè‡ªå·±çš„normalizationæ€è·¯ï¼Œ$h^i$æ˜¯ i-thå±‚çš„æ¿€æ´»å‡½æ•°è¾“å‡ºã€‚\næ­£åˆ™åŒ–å¤„ç†:\n$$\\gamma_{c, y, x}^i (m)\\frac{h_{n, c, y, x}^i - \\mu_c^i}{\\sigma_c^i} + \\beta_{c, y, x}^{i}(m)$$\n\nc: $c \\epsilon C^i, C^i$æ˜¯i-thå±‚çš„channelä¸ªæ•°\nx: $x \\epsilon W^i, W^i$æ˜¯i-thå±‚çš„å®½\ny: $y \\epsilon H^i$, é«˜\nm: segmentation mask m\n$\\gamma_{c, y, x}^i$è·Ÿ$\\beta_{c, y, x}^{i}$ æ˜¯å‡½æ•°ï¼Œç”¨å·ç§¯ç½‘ç»œå®žçŽ°\n\n**ç»“æž„å›¾**ï¼š \n\n![2f3fe4e8.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/1ec7011c.png)\n- `3x3-Conv-k`æ˜¯ 3x3å·ç§¯å±‚ï¼Œæœ‰kä¸ªå·ç§¯filter, filter size 3x3\n- `ReLU` æ¿€æ´»å‡½æ•° \n- è¿™é‡Œçš„`Resize`ç”¨çš„æ˜¯`nearest-neighbor downsampling`ï¼Œä¸ç»†è¯´äº†ã€‚\n\nå®ƒçš„å¤„ç†æµç¨‹æ˜¯è¿™æ ·ï¼Œå¯¹sematic image è¿›è¡Œresizeã€å·ç§¯ã€ReLUæ¿€æ´»å¤„ç†ï¼Œ å³$\\gamma_{c, y, x}^i(m)$è·Ÿ$\\beta_{c, y, x}^{i}(m)$ï¼Œ ä¹˜ã€åŠ ä¸Š`Batch Normalization`çš„è¾“å‡ºæ•°æ®$\\frac{h_{n, c, y, x}^i - \\mu_c^i}{\\sigma_c^i}$ ï¼Œ \n![ab4c46cb.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/ad9094aa.png)\n\næ¯”èµ·ä¼ ç»ŸBatch Normal,SPADEçš„$\\gamma_{c, y, x}^i(m)$è·Ÿ$\\beta_{c, y, x}^{i}(m)$æ˜¯å¯¹sematic imageåšå·ç§¯æ“ä½œï¼Œå®ƒåœ¨normalizationè¿‡ç¨‹ä¸­ä¿å­˜æ›´å¤šsemanticçš„ä¿¡æ¯ã€‚è®ºæ–‡ä¸­ä¹Ÿè®¤ä¸ºè¿™æ˜¯SPADEæ•ˆæžœæ›´å¥½çš„åŽŸå› ã€‚\n\n#### ç›¸å…³ä»£ç ï¼š \n`normalization.py`\n\n```python\n//  ç”¨ä¼ ç»Ÿçš„normalization methodæ­£åˆ™åŒ–æ¿€æ´»å‡½æ•°è¾“å‡º\n  if param_free_norm_type == 'instance':\n      self.param_free_norm = nn.InstanceNorm2d(norm_nc, affine=False)\n  elif param_free_norm_type == 'syncbatch':\n      self.param_free_norm = SynchronizedBatchNorm2d(norm_nc, affine=False)\n  elif param_free_norm_type == 'batch':\n      self.param_free_norm = nn.BatchNorm2d(norm_nc, affine=False)\n  else:\n      raise ValueError('%s is not a recognized param-free norm type in SPADE'\n                             % param_free_norm_type)\n\n \n```\n```python\n   // æž„å»ºgamma,betaå‡½æ•°, å·ç§¯å±‚å®žçŽ°\n   self.mlp_gamma = nn.Conv2d(nhidden, norm_nc, kernel_size=ks, padding=pw)\n   self.mlp_beta = nn.Conv2d(nhidden, norm_nc, kernel_size=ks, padding=pw)\n```\n\n```python\n  def forward(self, x, segmap):\n\n        # Part 1. generate parameter-free normalized activations\n        normalized = self.param_free_norm(x)\n\n        # âœ¨âœ¨âœ¨ Part 2. produce scaling and bias conditioned on semantic map\n        segmap = F.interpolate(segmap, size=x.size()[2:], mode='nearest')\n        actv = self.mlp_shared(segmap)\n        gamma = self.mlp_gamma(actv)\n        beta = self.mlp_beta(actv)\n\n        # apply scale and bias\n        out = normalized * (1 + gamma) + beta\n\n        return out\n```\n\n\n## æ¨¡åž‹æž¶æž„ GANs\n\nGANsç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š \n\n1. generatorï¼šè´Ÿè´£åˆæˆå†™å®žé£Žæ ¼çš„å›¾ç‰‡\n2. discriminator: è´Ÿè´£æ‰¾èŒ¬ã€‚è®¤å‡ºè¿™æ˜¯å¼ åˆæˆå›¾ç‰‡ï¼Œ è€Œä¸æ˜¯çœŸå®žçš„ç…§ç‰‡ï¼ˆor å†™å®žå›¾ç‰‡ï¼‰\n### generator æž¶æž„\n\né¦–å…ˆ\n\n![d3313a9e.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/d3313a9e.png)\n\nè¿™å¹…å›¾é‡Œå¥½å¤šSPADE ResBlkå•Šï¼Œå•¥æ˜¯SPADE ResBlk? ä¸‹é¢æ˜¯å®ƒçš„ç»“æž„å›¾ï¼š \n\n![630b2d2a.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/630b2d2a.png)\n\n- `3x3-Conv-k`æ˜¯ 3x3å·ç§¯å±‚ï¼Œæœ‰kä¸ªå·ç§¯filter, filter size 3x3\n- `ReLU` æ¿€æ´»å‡½æ•°\n- SPADEæ¿€æ´»è§ä¸Šæ–‡åˆ†æž\n\n\né‚£`ResBlk`å‘¢ï¼Ÿ \nè¿™è¦ä»Žå¤§åé¼Žé¼Žçš„æ®‹å·®ç½‘ç»œè¯´èµ· [Residual block](https://mooc.study.163.com/learn/2001281004?tid=2001392030&_trace_c_p_k2_=5c60eb2c1e0d4adbb2516471e9ebb431#/learn/content?type=detail&id=2001728692) ï¼ˆå¼ºçƒˆæŽ¨èAndrew Ngå…¬å¼€è¯¾; å¼„æ˜Žç™½å‡ ä¸ªç‚¹ï¼š 1. Residual Blockè¦è§£å†³ä»€ä¹ˆé—®é¢˜;  2. å®ƒçš„è®¾è®¡;  3. ä¸ºå•¥æœ‰æ•ˆã€‚ å†å›žæ¥çœ‹SPADE ResBlk)\n\n![fd021761.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/fd021761.png)\n```python\n    def __init__(self, fin, fout, opt):\n        super().__init__()\n        # Attributes\n        self.learned_shortcut = (fin != fout)\n        fmiddle = min(fin, fout)\n\n        # create conv layers\n        self.conv_0 = nn.Conv2d(fin, fmiddle, kernel_size=3, padding=1)\n        self.conv_1 = nn.Conv2d(fmiddle, fout, kernel_size=3, padding=1)\n        if self.learned_shortcut:\n            self.conv_s = nn.Conv2d(fin, fout, kernel_size=1, bias=False)\n\n        # apply spectral norm if specified\n        if 'spectral' in opt.norm_G:\n            self.conv_0 = spectral_norm(self.conv_0)\n            self.conv_1 = spectral_norm(self.conv_1)\n            if self.learned_shortcut:\n                self.conv_s = spectral_norm(self.conv_s)\n\n        # âœ¨âœ¨âœ¨ define normalization layers\n        spade_config_str = opt.norm_G.replace('spectral', '')\n        self.norm_0 = SPADE(spade_config_str, fin, opt.semantic_nc)\n        self.norm_1 = SPADE(spade_config_str, fmiddle, opt.semantic_nc)\n        if self.learned_shortcut:\n            self.norm_s = SPADE(spade_config_str, fin, opt.semantic_nc)\n```\n## Discriminator \n\ndiscriminatoræž¶æž„å›¾ã€‚ (segmentation image,  image)ä½œä¸ºè¾“å…¥ï¼Œ ä»»åŠ¡æ˜¯è¯†åˆ«imageæ˜¯ä¸æ˜¯å‡çš„ã€‚\n![c5347e81.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/c5347e81.png)\n\nimage encoderå°†å›¾ç‰‡encodeç”Ÿæˆå‡å€¼å‘é‡è·Ÿæ–¹å·®å‘é‡ï¼Œ è®¡ç®—å‡ºnoise inputè¾“å…¥ç»™generator, segmentation maskä¹Ÿä¼šé€šè¿‡SPADE ResBlksè¾“å…¥ç»™generatorã€‚ generatorç”Ÿæˆimageè·Ÿsegmentation image contactåŽï¼Œå†è¾“å…¥ç»™discriminator, discriminatoræ¥è¾¨åˆ«çœŸä¼ªã€‚ \n![f4341bd9.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/f4341bd9.png)\n\n### Training Data \n\næˆå¯¹çš„segmentation masksè·ŸçœŸå®žå›¾ç‰‡ã€‚ (segmentation mask, real image) \n\n### Test \n\n1.å®‰è£…:\n\n```sh\ngit clone https://github.com/NVlabs/SPADE.git\ncd SPADE/\n```\n2.è¿™ä¸ªé¡¹ç›®ä¾èµ–PyTorch 1.0è·Ÿpython3.0+. è¿˜ä¾èµ–Synchronized-BatchNorm-PyTorchä»“åº“ã€‚\n\n```\n// SPADEç›®å½•ä¸‹\ncd models/networks/\ngit clone https://github.com/vacancy/Synchronized-BatchNorm-PyTorch\ncp -rf Synchronized-BatchNorm-PyTorch/sync_batchnorm .\ncd ../../\n```\n3.ç”¨PyCharmæ‰“å¼€è¿™ä¸ªé¡¹ç›®, Preference -> Project Interpreter -> Project -> Project Interpreter; é€‰python3.+çš„è§£é‡Šå™¨, PyCharmä¼šæç¤ºå®‰è£…ä¾èµ–çš„packageã€‚ä¾èµ–åŒ…å®‰è£…å¥½åŽï¼Œå¦‚ä¸‹å›¾: \n\n![ed349b19.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/ed349b19.png)\n\n4.ä¸‹è½½æå‰è®­ç»ƒå¥½çš„æ¨¡åž‹\n[checkpoints.tar.gz - Google äº‘ç«¯ç¡¬ç›˜](https://drive.google.com/file/d/12gvlTbMvUcJewQlSEaZdeb2CdOB-b8kQ/view)\n\n```\ncd checkpoints\ntar xvf checkpoints.tar.gz\ncd ../\n\nls\n// checkpointsç›®å½•å¦‚ä¸‹:\nade20k_pretrained     checkpoints.tar.gz    cityscapes_pretrained coco_pretrained\n```\n5.ç¼–è¾‘Configuration, è¿è¡Œtest.pyè„šæœ¬ã€‚\n```sh\npython test.py --name [type]_pretrained --dataset_mode [dataset] --dataroot [path_to_dataset]\n```\n\nå‚æ•°ï¼š \n- `[type]_pretrained` å…ˆæ¸²æŸ“å¥½çš„æ¨¡åž‹ï¼Œcoco_pretrainedï¼Œ ade20k_pretrainedï¼Œ cityscapes_pretrainedä¸­ä»»é€‰ä¸€ä¸ªã€‚\n- `[dataset]` å¡«coco, ade20k, æˆ–è€…cityscapes \n- `[path_to_dataset]` æ•°æ®ï¼Œæ¯”å¦‚./datasets/coco_stuff\n\næ¯”å¦‚ï¼Œæˆ‘çš„å‚æ•°: \n```\n--name\ncoco_pretrained\n--dataset_mode\ncoco\n--dataroot\n./datasets/coco_stuff\n--gpu_ids\n-1\n```\nè¾“å‡ºçš„è·¯å¾„ï¼š `./results/[type]_pretrained/` æˆ‘çš„æ˜¯`./results/coco_pretrained/`\n\n![412b71cb.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/412b71cb.png)\n\nè¿™å‡ å¼ å›¾ç‰‡çœŸæ˜¯çœ‹çš„æˆ‘æœ‰ç‚¹å¤±æœ›ï¼Œå†çœ‹çœ‹ä¸‹å›¾è®ºæ–‡çš„å›¾ç‰‡ã€‚ æžœç„¶è®ºæ–‡çš„å›¾ç‰‡éƒ½æ˜¯ç²¾æŒ‘ç»†é€‰, å¥—è·¯æ»¡æ»¡ã€‚\n\n![b037261d.png](/img/7c2b5608-840f-411f-bcd4-024df194b0de/b037261d.png)\n\n- [An overview of semantic image segmentation.](https://www.jeremyjordan.me/semantic-segmentation/)","tags":["Image Segment"],"categories":["Neural Network"]},{"title":"The Weights of the YOLO Neural Network","url":"/2019/05/12/The-Weights-of-the-YOLO-Neural-Network/","content":"\n## Load Weights\n\nFirst, see this C library function:  \n```c\nsize_t fread ( void * ptr, size_t size, size_t count, FILE * stream );\n```\n**Parameters**\n- **ptr** âˆ’ Pointer to a block of memory with a size of at least (size*count) bytes, converted to a void*.\n\n- **size** âˆ’ This is the size in bytes of each element to be read.\n\n- **count** âˆ’ This is the number of elements, each one with a size of size bytes.\n\n- **stream** âˆ’ This is the pointer to a FILE object that specifies an input stream.\n\nThen, in the `load_weights_upto` function in `parser.c`, it begins to load weights for layers from xxx.weights. \n```c\nvoid load_weights_upto(network *net, char *filename, int start, int cutoff) {\n ...\n     // Begin to load weights for layers\n    for(i = start; i < net->n && i < cutoff; ++i){\n        layer l = net->layers[i];\n        if (l.dontload) continue;\n        if(l.type == CONVOLUTIONAL || l.type == DECONVOLUTIONAL){\n            load_convolutional_weights(l, fp);\n        }\n  ...\n}\n```\n\n### Convolutional Layer\nIn `load_convolutional_weights` function, it loads values of biases for filters. One bias for one filter. \n\n```c\n    fread(l.biases, sizeof(float), l.n, fp);\n```\n`l.n` is the number of filter in this layer. \n\nAssign the values to scales, rolling_mean and rooling_variance \n```\n if (l.batch_normalize && (!l.dontloadscales)){\n        fread(l.scales, sizeof(float), l.n, fp);\n        fread(l.rolling_mean, sizeof(float), l.n, fp);\n        fread(l.rolling_variance, sizeof(float), l.n, fp);\n```\n        \nAnd load weights for filters in this layer. The default value of `l.groups` is 1.\n```c\n    int num = l.c/l.groups*l.n*l.size*l.size;\n    fread(l.weights, sizeof(float), num, fp);\n```\n\n`l.c` is input channel. The number of input channel equal to the number of channel of a filter in this layer. Thus, `l.size` is the size of a filter.\n\nFor a 3x3x3 filter (size=3, channel=3), it has 3x3x3=27 parameters as follow  \n\n![-w208](/img/15576478323378/15576531132966.jpg)\n\nIf a convolutional layer has 3 such filters, it will have 3 values for bias, 3x3x3x3 .Its weight layout in memory is like this: \n\n![-w746](/img/15576478323378/15576535368751.jpg)\n\n## Write Weights \n\n`save_weights_upto` and `save_convolutional_weights`functions show how to save weights into a xxx.weights file. It's just a reverse process. \n\n```c\nvoid save_convolutional_weights(layer l, FILE *fp)\n{\n    if(l.binary){\n        //save_convolutional_weights_binary(l, fp);\n        //return;\n    }\n    int num = l.nweights;\n    fwrite(l.biases, sizeof(float), l.n, fp);\n    if (l.batch_normalize){\n        fwrite(l.scales, sizeof(float), l.n, fp);\n        fwrite(l.rolling_mean, sizeof(float), l.n, fp);\n        fwrite(l.rolling_variance, sizeof(float), l.n, fp);\n    }\n    fwrite(l.weights, sizeof(float), num, fp);\n}\n```\n\n```\nsize_t fwrite ( const void * ptr, size_t size, size_t count, FILE * stream );\n\n```\n\n**Parameters**\n- **ptr**\nPointer to the array of elements to be written, converted to a const void*.\n- **size**\nSize in bytes of each element to be written.\nsize_t is an unsigned integral type.\n- **count**\n Number of elements, each one with a size of size bytes.\nsize_t is an unsigned integral type.\n- **stream**\nPointer to a FILE object that specifies an output stream.\n","tags":["YOLO"],"categories":["Neural Network"]},{"title":"LeetCode:237. Delete Node in a Linked List","url":"/2019/05/12/LeetCode-237-Delete-Node-in-a-Linked-List/","content":"\nWrite a function to delete a node (except the tail) in a singly linked list, given only access to that node.\n\n<!--more-->\n\n## [é¢˜ç›®](https://leetcode.com/problems/delete-node-in-a-linked-list/)\n\nWrite a function to delete a node (except the tail) in a singly linked list, given only access to that node.\n\nGiven linked list -- head = [4,5,1,9], which looks like following:\n\n![237_example.png](https://assets.leetcode.com/uploads/2018/12/28/237_example.png)\n\n## åˆ†æžï¼š \n\nå¦‚æžœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¦‚ä¸‹çš„Linked Listï¼Œæƒ³åˆ é™¤å€¼æ˜¯5çš„èŠ‚ç‚¹. è¿™é“é¢˜è¦æ±‚ ï¼Œ`only access to that node`ã€‚\n\n```\n4 -> 5 -> 1\n```\n\n![48d29b19.png](/img/f394f304-a25b-4128-bcaa-779a974c8c4a/48d29b19.png)\nç•™æ„å›¾ä¸­ï¼Œè¦åˆ é™¤çš„å¯¹è±¡çš„åœ°å€æ˜¯0x7ff07ae00090\n\n```c++\n    void deleteNode(ListNode* node) {\n        *node = *(node->next);\n    }\n```\n\n`*node`å¯¹nodeæŒ‡é’ˆå–å†…å®¹ï¼Œè¿”å›žæ˜¯ä¸€ä¸ªå¯¹è±¡, å¯¹è±¡åœ°å€0x7ff07ae00090\n\n![f94bba4f.png](/img/f394f304-a25b-4128-bcaa-779a974c8c4a/f94bba4f.png)\n\n`*node->next`å¯¹nodeæŒ‡é’ˆå–å†…å®¹ï¼Œè¿”å›žæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ å¯¹è±¡åœ°å€0x7ff07ae000a0\n\n![69411ad8.png](/img/f394f304-a25b-4128-bcaa-779a974c8c4a/69411ad8.png)\n\næ‰§è¡Œ\n```\n*node = *(node->next);\n```\nç»“æžœå¦‚ä¸‹ï¼š \n\n![83d8670d.png](/img/f394f304-a25b-4128-bcaa-779a974c8c4a/83d8670d.png)\n\nnodeæŒ‡é’ˆæ‰€æ‰§è¡Œçš„å¯¹è±¡åœ°å€ä¸å˜ï¼Œä½†æ˜¯å¯¹è±¡å†…å®¹å‘ç”Ÿå˜åŒ–ã€‚å°±åƒä¸‰ä¸ªæˆ¿å­ï¼Œä½ç½®æ²¡å˜ï¼Œ ä½†æ˜¯ç¬¬ä¸‰ä¸ªæˆ¿å­é‡Œçš„ä½æˆ·æ¬åˆ°äº†ç¬¬äºŒä¸ªæˆ¿å­é‡Œä½äº†ã€‚ nodeæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„åœ°å€ä¾æ—§æ˜¯0x7ff07ae00090, valä¸å†æ˜¯5è€Œæ˜¯1ï¼Œ nextæŒ‡é’ˆä¹Ÿæ‰§å‘NULLã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸¢å¤±äº†å¯¹0x7ff07ae000a0å¯¹è±¡çš„æŒ‡é’ˆå¼•ç”¨ã€‚\n\n![e8798a20.png](/img/f394f304-a25b-4128-bcaa-779a974c8c4a/e8798a20.png)","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"LeetCode  Flatten a Multilevel Doubly Linked List","url":"/2019/05/12/LeetCode-Flatten-a-Multilevel-Doubly-Linked-List/","content":"Flatten the list so that all the nodes appear in a single-level, doubly linked list. You are given the head of the first level of the list.\n\n<!--more-->\n\né¢˜ç›®ï¼š [430. Flatten a Multilevel Doubly Linked List]([Loading...](https://leetcode.com/problems/flatten-a-multilevel-doubly-linked-list/)\n)\n\nåˆ†æžï¼š \n![da80f35a.png](/img/ed6ee62a-3dcb-4189-9404-14b91692d436/da80f35a.png)\n\n å½“é‡åˆ°æœ‰childçš„Nodeï¼Œå…ˆç”¨`*next`å­˜cur->next; æŠŠcur->nextæŒ‡é’ˆæŒ‡å‘child, child->preæŒ‡å‘curï¼› æŽ¥ç€ä»¥childä¸ºèµ·ç‚¹æ‰¾åˆ°è¯¥æ›¾æœ€åŽä¸€ä¸ªNodeï¼Œè®©å®ƒæŒ‡å‘`*next`çš„èŠ‚ç‚¹ã€‚ æŽ¥ç€ä»¥åŽŸæ¥çš„childä¸ºcur Nodeé‡æ–°å¼€å§‹ä¸€è½®ã€‚ \n\n```c++\n    class Node {\n    public:\n        int val;\n        Node *prev;\n        Node *next;\n        Node *child;\n\n        Node() {}\n\n        Node(int _val, Node *_prev, Node *_next, Node *_child) {\n            val = _val;\n            prev = _prev;\n            next = _next;\n            child = _child;\n        }\n    };\n\n    Node *flatten(Node *head) {\n        Node *cur = head;\n        while (cur) {\n            if (cur->child) {\n                Node *next = cur->next;\n                cur->next = cur->child;\n                cur->child = nullptr;\n                cur->next->prev = cur;\n\n                // iter the children \n                Node *p = cur->next;\n                while (p->next) p = p->next;\n                  \n                p->next = next;\n                if (next) next->prev = p;\n            }\n            cur = cur->next;\n        }\n\n        return head;\n    }\n```\n\næ—¶é—´å¤æ‚åº¦ï¼š $O(n)$","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"YOLO - From Configuration File to Convolutional Layers","url":"/2019/05/08/The-Implementation-of-Convolutional-and-MaxPool-layer/","content":"\n Let's firstly see how `Darknet` construct a neural network. See at `detector.c` `test_detector` function, it construct a network by parsing  the `xxx.cfg` file and `xxx.weights` file. In my case, they are yolo3-tiny.cfg and yolo3-tiny.weights \n <!-- more --> \n\n\nI am trying to understand [Darknet source code](https://pjreddie.com/darknet/yolov2/) that implements YOLO algorithm. First, I run the detector.\n\n```\n./darknet detect cfg/yolov3-tiny.cfg yolov3-tiny.weights data/dog.jpg\n```\n## Parse the argumenets \n\nIn `main` function, it goes to function `test_detector` according to the first argument`detect`. \n\n```c\nif (0 == strcmp(argv[1], \"detect\")){\n   float thresh = find_float_arg(argc, argv, \"-thresh\", .5);\n   char *filename = (argc > 4) ? argv[4]: 0;\n   char *outfile = find_char_arg(argc, argv, \"-out\", 0);\n   int fullscreen = find_arg(argc, argv, \"-fullscreen\");\n   test_detector(\"cfg/coco.data\", argv[2], argv[3], filename, thresh, .5, outfile, fullscreen);\n   }   \n```\n\nHere is the architecture of neural network defined by yolov3-tiny.cfg\n\n```\n\nlayer     filters    size              input                output\n    0 conv     16  3 x 3 / 1   416 x 416 x   3   ->   416 x 416 x  16  0.150 BFLOPs\n    1 max          2 x 2 / 2   416 x 416 x  16   ->   208 x 208 x  16\n    2 conv     32  3 x 3 / 1   208 x 208 x  16   ->   208 x 208 x  32  0.399 BFLOPs\n    3 max          2 x 2 / 2   208 x 208 x  32   ->   104 x 104 x  32\n    4 conv     64  3 x 3 / 1   104 x 104 x  32   ->   104 x 104 x  64  0.399 BFLOPs\n    5 max          2 x 2 / 2   104 x 104 x  64   ->    52 x  52 x  64\n    6 conv    128  3 x 3 / 1    52 x  52 x  64   ->    52 x  52 x 128  0.399 BFLOPs\n    7 max          2 x 2 / 2    52 x  52 x 128   ->    26 x  26 x 128\n    8 conv    256  3 x 3 / 1    26 x  26 x 128   ->    26 x  26 x 256  0.399 BFLOPs\n    9 max          2 x 2 / 2    26 x  26 x 256   ->    13 x  13 x 256\n   10 conv    512  3 x 3 / 1    13 x  13 x 256   ->    13 x  13 x 512  0.399 BFLOPs\n   11 max          2 x 2 / 1    13 x  13 x 512   ->    13 x  13 x 512\n   12 conv   1024  3 x 3 / 1    13 x  13 x 512   ->    13 x  13 x1024  1.595 BFLOPs\n   13 conv    256  1 x 1 / 1    13 x  13 x1024   ->    13 x  13 x 256  0.089 BFLOPs\n   14 conv    512  3 x 3 / 1    13 x  13 x 256   ->    13 x  13 x 512  0.399 BFLOPs\n   15 conv    255  1 x 1 / 1    13 x  13 x 512   ->    13 x  13 x 255  0.044 BFLOPs\n   16 yolo\n   17 route  13\n   18 conv    128  1 x 1 / 1    13 x  13 x 256   ->    13 x  13 x 128  0.011 BFLOPs\n   19 upsample            2x    13 x  13 x 128   ->    26 x  26 x 128\n   20 route  19 8\n   21 conv    256  3 x 3 / 1    26 x  26 x 384   ->    26 x  26 x 256  1.196 BFLOPs\n   22 conv    255  1 x 1 / 1    26 x  26 x 256   ->    26 x  26 x 255  0.088 BFLOPs\n   23 yolo\n```\nNow, let's see how Darknet construct a nerual network. See  `detector.c` `test_detector` function, it construct a network by parsing  the `xxx.cfg` file and `xxx.weights` file. In my case, they are yolo3-tiny.cfg and yolo3-tiny.weights \n\n\n## Parse the configuration file\n\n### Sections in the file \n\nThe code to parse the yolo.cfg file is here:\n\n```c\nlist *read_cfg(char *filename)\n{\n    FILE *file = fopen(filename, \"r\");\n    if(file == 0) file_error(filename);\n    char *line;\n    int nu = 0;\n    list *options = make_list();\n    section *current = 0;\n    while((line=fgetl(file)) != 0){\n        ++ nu;\n        strip(line);\n        switch(line[0]){\n            case '[':\n                current = malloc(sizeof(section));\n                list_insert(options, current);\n                current->options = make_list();\n                current->type = line;\n                break;\n            case '\\0':\n            case '#':\n            case ';':\n                free(line);\n                break;\n            default:\n                if(!read_option(line, current->options)){\n                    fprintf(stderr, \"Config file error line %d, could parse: %s\\n\", nu, line);\n                    free(line);\n                }\n                break;\n        }\n    }\n    fclose(file);\n    return options;\n}\n```\n\n\nfor exmaple: \n\n```js\n[net]              // '[' is a tag for a section, the type of current setion is '[net]'\n# Testing          // ignore\nbatch=1         \nsubdivisions=1\n# Training\n# batch=64\n# subdivisions=2\nwidth=416\nheight=416\nchannels=3\nmomentum=0.9\ndecay=0.0005\nangle=0\nsaturation = 1.5\nexposure = 1.5\nhue=.1\n                 // ignore\nlearning_rate=0.001\n...\n\n[convolutional]    // [convoltional] \n...\n\n[maxpool]      // [maxpool] \n\n...\n[yolo]\n...\n\n[route]\n...\n\n```\n\n#### `[net]`\n\nIn section '[net]', `batch=1` is a option stored in `kvp`(option_list.c line 70) structure. Its key is batch, value is 1. Then this kvp object will be inserted into a node list (see it at option_list.c line76 & list.c line 40).\nAfter parsing the yolo3-tiny.cfg file, We will get a section list; its size is 25. Because there are 25 \\'[\\' tags in yolo3-tiny.cfg\n\n\nIn `parse_network_cfg` function, it parses the `[net]` section to get the params for the whole network. \n\n```c\nnetwork *parse_network_cfg(char *filename)\n{\n    list *sections = read_cfg(filename);\n    node *n = sections->front;\n    if(!n) error(\"Config file has no sections\");\n    network *net = make_network(sections->size - 1);\n    // other codes ...\n    \n}\n```\n\n#### `[convolutional]`\n\nThen parse the different sections. \n\n```c\n        s = (section *)n->val;\n        options = s->options;\n        layer l = {0};\n        LAYER_TYPE lt = string_to_layer_type(s->type);\n        if(lt == CONVOLUTIONAL){\n            l = parse_convolutional(options, params);\n        }else if(lt == DECONVOLUTIONAL){\n            l = parse_deconvolutional(options, params);\n        }else if(lt == LOCAL){\n            l = parse_local(options, params);\n        }else if(lt == ACTIVE){\n            l = parse_activation(options, params);\n        // other code here ...\n       \n```\n\n\nFor the first `[convolutional]` section in the yolo3-tiny.cfg as follow, the darknet will construct a `convolutional_layer` using thess params (see function `parse_convolutional` in parse.c and  function `make_convolutional_layer` in convolutional_layer.c)\n\n```js\n[convolutional]\nbatch_normalize=1\nfilters=16\nsize=3\nstride=1\npad=1\nactivation=leaky\n```\n\nIn this layer, there are 16 filters; the size of each filter is 3X3Xnum_channel; what is num_channel? well, `the number of channels in a filter must match the number of channels in input volume`, so here num_channel is equal to 3. The stride value for filters is 1, padding value is 1. \n\n\nLet's see how darknet calculate the output size of convolutional_layer by the input size(`l.h`) and filter params (`l.size`, `l.pad`, `l.stride`). There is a formula that shows how size of input volume relates to the one of output volume\n \n\n```c\n\nint convolutional_out_height(convolutional_layer l)\n{\n    return (l.h + 2*l.pad - l.size) / l.stride + 1;\n}\n\nint convolutional_out_width(convolutional_layer l)\n{\n    return (l.w + 2*l.pad - l.size) / l.stride + 1;\n}\n\n```\n\n As for yolo3-tiny.cfg, for this first convolutional_layer, its input size is 416 x 416 and channel is 3. So its ouput height is (416+2x1 - 3)/1 + 1 = 416, its output width is 416 too. `What about its output channel? It equals to the number of filters (16)`. \n \n ```c\n \n  l.out_c = n    // in func make_convolutional_layer\n  \n ```\n So its output volume size is 416 X 416 X 16.\n \n \n ![02b028d9.png](/img/995676c2-24ed-4165-8224-0bc01148242a/9b76325f.png)\n \n For a beginner, I strongly recommend these courses: [Strided Convolutions - Foundations of Convolutional Neural Networks \\| Coursera](https://www.coursera.org/lecture/convolutional-neural-networks/strided-convolutions-wfUhx) and  [One Layer of a Convolutional Network - Foundations of Convolutional Neural Networks \\| Coursera](https://www.coursera.org/lecture/convolutional-neural-networks/one-layer-of-a-convolutional-network-nsiuW)\n  \nNow, we have 16 filters that are 3X3X3 in this layer, `how many parameters does this layer have`?  Each filter is a 3X3X3 volume, so it's 27 numbers tp be learned, and then plus the bias, so that was the b parameters. it's 28 parameters. There are 16 filters so that would be 448 parameters to be learned in this layer. \n \n```c\n\n    // c: the number of channels; n: the number of filters; \n    // size: the number of filter width or height; groups: default is 1 \n    l.weights = calloc(c/groups*n*size*size, sizeof(float));\n    l.weight_updates = calloc(c/groups*n*size*size, sizeof(float));\n\n    l.biases = calloc(n, sizeof(float));\n    l.bias_updates = calloc(n, sizeof(float));\n\n    l.nweights = c/groups*n*size*size;\n    l.nbiases = n;\n\n```\n \n \n#### Activation \n \n In this convolution layer, it choose leaky ReLU as activation function. The function is defined as follow  where Î± is a small constant.\n \n $$\nf(x)=\\begin{cases}\nÎ±x,\\quad x\\leq 0 \\\\\\\\ \nx,\\quad x>0\n\\end{cases}\n$$\n\n \n Still, I recommend this course for a beginner. [Activation functions - Shallow neural networks \\| Coursera](https://www.coursera.org/lecture/neural-networks-deep-learning/activation-functions-4dDC1)\n\n \nThere are `forward_activation_layer` and `backward_activation_layer` in Darknet. Both of them handle batch inputs. \n\nFor forward activation layer, leaky_activate is to computes f(x)\n\n ```c\n static inline float leaky_activate(float x){return (x>0) ? x : .1*x;}\n ```\n For backward activation layer, leaky_gradient returns the slop of the function \n\n```c\nstatic inline float leaky_gradient(float x){return (x>0) ? 1 : .1;}\n```\n\n\n \n \n#### [maxpool]\n \n Maxpool layer is used to reduce the size of representation to speed up computation as well as to make some of the features it detects a bit more robust. Look at the `tiny-yolo3.cfg`\n \n ```js\n [maxpool]\nsize=2\nstride=2\n\n ```\n ```c\n maxpool_layer make_maxpool_layer(int batch, int h, int w, int c, int size, int stride, int padding)\n{\n    maxpool_layer l = {0};\n    l.type = MAXPOOL;\n    l.batch = batch;\n    l.h = h;\n    l.w = w;\n    l.c = c;         // output channel equals to input one \n    l.pad = padding;  // default value is size - 1\n    l.out_w = (w + padding - size)/stride + 1;\n    l.out_h = (h + padding - size)/stride + 1;\n    l.out_c = c;\n    l.outputs = l.out_h * l.out_w * l.out_c;\n    // other codes ...\n    return l;\n}\n\n \n ```\n This `[maxpool]` sections comes after the `[convolutional]` section. Its input size(416 x 416 x 16) equal to the output size of the former layer (416 x 416 x  16). The filter size is 2 x 2, stride is 2. Each time, the filter would move 2 steps, for a 4x4x1 input volume, its output is 2x2x1 volume. \n![e65fb56d.png](/img/995676c2-24ed-4165-8224-0bc01148242a/e65fb56d.png)\n```\n9 == max(1, 3, 2, 9)\n2 == max(2, 1, 1, 1)\n6 == max(1, 3, 5, 6)\n3 == max(2, 3, 1, 2)\n```\nSo in this layer, its ouput width equals to (int)((416+ 1 - 2)/2 + 1), 208. And the number of its output channels equals to the number of input channels. Now, we know its output volume size is 208 X 208 X 16. There is no parameter to be learned. \n\n**input volume size**: \n\n$$ n_H . n_W . n_c$$\n\n  $n_c$ : the number of channels\n\n**output volume size**: \n\n$$(\\frac{n_H + padding-f}{stride} + 1) . (\\frac{n_W + padding-f}{stride} +1) . n_c$$\n \n$f$: the width or height of a filter\n \n [Pooling Layers - Foundations of Convolutional Neural Networks \\| Coursera](https://www.coursera.org/lecture/convolutional-neural-networks/pooling-layers-hELHk)\n \n #### Why does 1 x 1 convolution do? \n \n [Networks in Networks and 1x1 Convolutions - Deep convolutional models: case studies \\| Coursera](https://www.coursera.org/lecture/convolutional-neural-networks/networks-in-networks-and-1x1-convolutions-ZTb8x)\n \n \n For example, in this picture, the number of input volume channels ,192, has gotten too big, we can shrink it to a 28x28x32 dimension volume using 32 filters that are 1x1x192. So this is a way to shrink the number of channels .\n \n ![a085e0e4.png](/img/995676c2-24ed-4165-8224-0bc01148242a/a085e0e4.png)\n \n \n In YOLO, it implements fully connected layer by two convolutional layer. \n \n ```\n[convolutional]\nbatch_normalize=1\nfilters=256\nsize=3\nstride=1\npad=1\nactivation=leaky\n\n[convolutional]\nsize=1\nstride=1\npad=1\nfilters=255\nactivation=linear\n ```\n \n [Convolutional Implementation of Sliding Windows - Object detection \\| Coursera](https://www.coursera.org/lecture/convolutional-neural-networks/convolutional-implementation-of-sliding-windows-6UnU4)\n \n","tags":["YOLO"],"categories":["Neural Network"]},{"title":"LeetCode Unique Paths 1-2","url":"/2019/05/08/Leetcode-Unique-Paths-1-2/","content":"Leetcode Unique Paths 1-2 \n<!-- more --> \n\n# Unique Paths 1-2\n\n## é¢˜ç›®1ï¼š [Unique Paths 1](https://leetcode.com/problems/unique-paths/)\n\n![e2ca2848.png](/img//c5619f25-13a6-4e38-b7f8-d87ff624f5b5/e2ca2848.png)\n\n### åŠ¨æ€è§„åˆ’è§£é¢˜æ­¥éª¤è¦ç‚¹: \n\n1. æ‰¾åˆ°æœ€ä¼˜è§£çš„ç»“æž„\n2. é€’å½’æ–¹æ¡ˆ\n3. bottom-up æˆ–è€… top-downæ–¹å¼æ±‚æœ€ä¼˜è§£\n4. ä¼˜åŒ–ï¼Œç©ºé—´æ¢æ—¶é—´\n\n### åˆ†æž\n\nè¿™é“é¢˜å¾ˆç®€å•ã€‚\n1. å®šä¹‰ä¸€ä¸ª mxn çš„äºŒç»´æ•°ç»„grides[m][n]ï¼Œ å¯¹åº”æ ¼å­åœ°å›¾ã€‚å¯¹åº”é€”ä¸­grides[2][6]\n\n![e594b650.png](/img//c5619f25-13a6-4e38-b7f8-d87ff624f5b5/e594b650.png)\næ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ä»Ž(0,0)åˆ°(1, 2)æœ‰å‡ æ¡è·¯ã€‚æ ¹æ®é¢˜ç›®è¦æ±‚ï¼Œåªèƒ½å¾€å³èµ°æˆ–è€…ä¸‹èµ°ä¸€ä¸ªæ ¼å­ã€‚\næˆ‘ä»¬å…ˆçœ‹ä»Ž(1, 1)åˆ°ï¼ˆ1ï¼Œ2ï¼‰ï¼Œä¸¤ç§èµ°æ³•ï¼š \n- (2, 0) -> (1, 2)\n- (1, 1) -> (1, 2)\n\nå†çœ‹ä»Ž(0, 0)åˆ°(2ï¼Œ 0) åªæœ‰ä¸€æ¡è·¯: (0, 0) -> (1, 1) -> (2, 0)ï¼› grides[2][0] = 1ã€‚\n\nä»Ž(0, 0)æ ¼å­åˆ°(1,1)æ ¼å­ï¼Œæœ‰ä¸¤ç§è·¯: \n- (0,0) -> (0, 1)-> (1, 1)\n- (0,0) -> (1, 0)-> (1, 1)\né‚£ä¹ˆgrides(1, 1) = 2. \n \nå¾ˆå®¹æ˜“å‘çŽ°è§„å¾‹ï¼Œ grids[m][n] = grids[m - 1][n] + grides[m][n -1]; å¯ç”¨é€’å½’æ±‚è§£ã€‚ä½†æ˜¯çº¯ç¢Žçš„é€’å½’æœ‰å¾ˆå¤šé‡å¤è®¡ç®—ã€‚ å¦‚ä¸‹å›¾çš„é€’å½’æ ‘ï¼š \n![72a3d4ef.png](/img//c5619f25-13a6-4e38-b7f8-d87ff624f5b5/72a3d4ef.png)\næ‰€ä»¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªrecordæ•°ç»„ï¼Œè®°å½•å·²ç»è®¡ç®—çš„ç»“æžœï¼ŒçœåŽ»é‡å¤è®¡ç®—ã€‚\n\næ—¶é—´å¤æ‚åº¦: \no(m* n)\n\n```c++\nint inner_path(int i, int j, int m, int n, vector<vector<int>>& record) {\n    if (i < 0 || j < 0) {\n        return 0;\n    }\n\n    if (record[i][j]) {\n        return record[i][j];\n    }\n\n    if ((i == 0) && (j == 0)) {\n        return 1;\n    }\n\n    record[i][j] = inner_path(i-1, j, m, n, record) + inner_path(i, j-1, m, n, record);\n    return record[i][j];\n}\n\nint uniquePaths(int m, int n) {\n    vector<vector<int>> res(m, vector<int>(n, 0));\n    return inner_path(m-1, n-1, m, n, res);\n}\n```\n\n### [Unique Paths 2](https://leetcode.com/problems/unique-paths-ii/)\n\nåˆ†æžï¼š \nè·ŸUnique Paths 1æ¯”èµ·æ¥ï¼Œå¤šäº†éšœç¢ç‰©ã€‚å¦‚æžœ(i, j)æ˜¯éšœç¢ç‰©ï¼Œé‚£ä¹ˆgrid(i, j) = 0, è¡¨ç¤ºæˆ‘ä»¬æ— æ³•ç»ç”±(i, j) åˆ°è¾¾ç»ˆç‚¹ã€‚\n\n\n\n```c++\nint path_helper(int i, int j, int m, int n, vector<vector<int>>& record, vector<vector<int>> &obstacleGrid) {\n        if (i < 0 || j < 0 || obstacleGrid[i][j] == 1) {\n            return 0;\n        }\n\n        if (record[i][j]) {\n            return record[i][j];\n        }\n\n        if ((i == 0) && (j == 0)) {\n            return 1;\n        }\n\n        record[i][j] = path_helper(i - 1, j, m, n, record, obstacleGrid) + path_helper(i, j - 1, m, n, record, obstacleGrid);\n        return record[i][j];\n    }\n\n    int uniquePathsWithObstacles(vector<vector<int>>& obstacleGrid) {\n        if (obstacleGrid.empty()) return 0;\n        int m = (int)obstacleGrid.size();\n        int n = (int)obstacleGrid[0].size();\n\n        vector<vector<int>> res(m, vector<int>(n, 0));\n        return path_helper(m - 1, n - 1, m, n, res, obstacleGrid);\n    }\n```\n\nè‡ªåº•å‘ä¸Šçš„å†™æ³•ï¼š \n\n```c++\n   int uniquePathsWithObstacles(vector<vector<int>>& grid) {\n        int rows = grid.size();\n        if(rows == 0) return 0;\n        int cols = grid[0].size();\n        vector<vector<long>> res(rows+1, vector<long>(cols+1, 0));\n        for(int i=rows-1; i>=0;i--){\n            for(int j=cols-1; j>=0;j--){\n                if(grid[i][j] == 1) res[i][j] = 0;\n                else if(i == rows-1 && j == cols-1) res[i][j] = 1;\n                else res[i][j] = res[i][j+1] + res[i+1][j];\n            }\n        }\n        return res[0][0];\n    }\n```","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"LeetCode 959. Regions Cut By Slashes ç¬”è®°","url":"/2019/04/23/Leetcode-959-Regions-Cut-By-Slashes/","content":"\né¢˜ç›®ï¼šhttps://leetcode.com/problems/regions-cut-by-slashes/description/\n\n## Solution1: DFS \n\nTime Complexity::  $O(n^2)$\n\n### åˆ†æžï¼š \n[è¿™ä¸ªç¥žå¥‡çš„æ€è·¯](https://leetcode.com/problems/regions-cut-by-slashes/discuss/205674/C++-with-picture-DFS-on-upscaled-grid)åˆ†å‰²æ ¼å­ï¼Œè½¬åŒ–ä¸ºå›¾çš„DFSé—®é¢˜ã€‚\n```json\nInput:\n[\n  \"\\\\/\",\n  \"/\\\\\"\n]\n```\n\næŠŠ`\\\\`ï¼Œ`/`æˆ–è€…` `åˆ†åˆ«åˆ†å‰²æˆ3*3çš„æ ¼å­ã€‚å›¾è½¬åŒ–ä¸º: \n\n```json\n[\n 1,0,0,0,0,1,\n 0,1,0,0,1,0,\n 0,0,1,1,0,0\n 0,0,1,1,0,0\n 0,1,0,0,1,0\n 1,0,0,0,0,1\n]\n```\n\né—®é¢˜å°±å˜æˆï¼š è®¡ç®—è¢«1åˆ†å‰²å¼€çš„åŒºåŸŸçš„æ•°é‡ã€‚\n\nç±»ä¼¼çš„[å­¤å²›æ•°é‡é—®é¢˜](https://www.geeksforgeeks.org/find-number-of-islands/) éƒ½æ˜¯åŒä¸€ä¸ªé—®é¢˜çš„å˜ç§ï¼š[Counting the number of connected components in an undirected graph](https://www.geeksforgeeks.org/connected-components-in-an-undirected-graph/)\n\n```c++\nvoid dfs(vector<vector<int>>& board, int i, int j ) {\n    // index out of range\n    if (i < 0 || j < 0 || i >= board.size() || j >= board[0].size()) return;\n    // this grid has been visited or it was part of a slash character\n    if (board[i][j] == 1) return;\n\n    // mark this grid visited\n    board[i][j] = true;\n\n    dfs(board, i - 1, j);\n    dfs(board, i + 1, j);\n    dfs(board, i, j - 1);\n    dfs(board, i, j + 1);\n}\n\nint regionsBySlashes(vector<string>& grid) {\n    if (grid.empty())\n        return 0;\n    int row = (int)grid.size(), col = (int)grid[0].size();\n    vector<vector<int>> board (row * 3, vector<int>(col * 3, 0));\n\n    // n*n graph represented as 3n*3n graph\n    for (int i = 0; i < row; ++i) {\n        for (int j = 0; j < col; ++j) {\n            if (grid[i][j] == '/') board[i * 3][j * 3 + 2] = board[i * 3 + 1][j * 3 + 1] = board[i * 3 + 2][j * 3] = 1;\n            if (grid[i][j] == '\\\\') board[i * 3][j * 3] = board[i * 3 + 1][j * 3 + 1] = board[i * 3 + 2][j * 3 + 2] = 1;\n        }\n    }\n\n    int cnt = 0;\n    for (int i = 0; i < row * 3; ++i) {\n        for (int j = 0; j < col * 3; ++j) {\n            // only count components connected by space\n            if (!board[i][j]) {\n               dfs(board, i, j);\n               cnt++;\n            }\n        }\n    }\n\n    return cnt;\n}\n\n```\n\nå¦‚æžœåˆ†å‰²ä¸º2*2çš„æ ¼å­ï¼Œä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜:\n```\nInput:\n[\n  \"//\",\n  \"/ \"\n]\nOutput: 5\nExpected: 3\n\n0101\n1010\n0100\n1000\n```\n01**0**1\n1**0**10\n**0**100\n1000\n\nåŠ ç²—çš„è¿™ä¸‰ä¸ª0ï¼Œè¢«åˆ†å‰²å¼€äº†ã€‚é¢˜æ„è¦æ±‚æ˜¯è¿žåœ¨ä¸€èµ·çš„ã€‚\n\n\n## Solution2: DSU\n\nTime Complexity:  $O(n^2*\\alpha(n))$\nSpace Complexity: $O(n^2)$\n\n### åˆ†æžï¼š \n\n#### DSU: \nhttps://www.youtube.com/watch?v=YKE4Vd1ysPI\nhttps://www.youtube.com/watch?v=gpmOaSBcbYA\n\nDSUä¸­ç”¨æ•°ç»„æ¥è¡¨ç¤ºæ ‘ï¼Œ å¦‚ä¸‹ï¼š \n\n| idx | 0 |  1 | 2 |\n| --- | --- | --- | --- |\n| parent | 1 | -1 | 1 |\n\n \nparent[0] = 1, ä»£è¡¨node 0çš„parentæ˜¯1ï¼› parent[2] = 1ä»£è¡¨node 2çš„parentæ˜¯1; parent[1] = -1, ä»£è¡¨å®ƒæ˜¯rootã€‚ \n\n```\n   1\n /  \\\n0    2\n```\n\nä¸¤ä¸ªoperationï¼š \n**find(x)**: find root of cluster in which x is \n\n```\n   1                   5\n  / \\                 / \\\n 0   2               6   7\n    / \\                   \\\n   3   4                  8\n```\næ¯”å¦‚ï¼š æˆ‘ä»¬æƒ³æ‰¾3è·Ÿ8æ‰€åœ¨clusterçš„rootï¼Œ find(3) == 1,  find(8) == 5\n\n```c\n/*é€’å½’æŸ¥æ‰¾root*/\nint find(int x, int parent[]) {\n    int x_root = x; \n    while (parent[x_root]!= -1) {\n        x_root = parent[x_root];\n    }\n    return x_root;\n}\n```\n**union(x, y)**: union two cluster where x, y are in \n\næ¯”å¦‚ï¼š æˆ‘ä»¬æƒ³union(3, 8),  å°±è¦å…ˆæ‰¾åˆ°3çš„x_rootï¼Œ è·Ÿ8çš„y_rootï¼Œç„¶åŽåˆå¹¶ä¸¤ä¸ªroot.\n\n```c\nint union(int x, int y, int parent[]) {\n    int x_root = find(x, parent);\n    int y_root = find(y, parent); \n    if (x_root == y_root) {\n        return 0; \n    } else {\n        // y_root å˜æˆ x_rootçš„æ ¹\n        parent[x_root] = y_root;\n        return 1\n    }\n}\n```\n\n```\n              5\n         /   / \\\n        1   6   7\n       / \\       \\\n      0   2       8\n         / \\ \n        3   4 \n```\n\n                                \nDSUè…»å®³çš„ä¸€ç‚¹æ˜¯ä¼˜åŒ–åŽï¼Œç”¨$O(1)$çš„average time cost, æ£€æµ‹å›¾é‡Œæœ‰å’©æœ‰çŽ¯\n\nä¸¤ç§ä¼˜åŒ–ï¼š \n- Make tree flat \n- Union by rank\n\nhttps://www.youtube.com/watch?v=VJnUwsE4fWA\n\n\n### åˆ†å‰²æˆ4ä¸ªä¸‰è§’å½¢ï¼Œ ä¸Šä¸‹å·¦å³\næ¯ä¸ªæ ¼å­åˆ†å‰²æˆä¸Šä¸‹å·¦å³å››ä¸ªä¸‰è§’å½¢ã€‚\nhttps://assets.leetcode.com/uploads/2018/12/15/3.png\n\næ¯ä¸ªä¸‰è§’å½¢ç»™ä¸ªidx: 0, 1, 2, 3åˆ†åˆ«å¯¹åº” top, right, bottom, left\n```\n\\ 0 /\n3 \\ 1\n/ 2 \\\n```\nn*nçš„å›¾ï¼›å˜æˆ 4*n*nçš„æ•°ç»„ã€‚ åˆå§‹åŒ–æ—¶æ•°ç»„parentçš„æ¯ä¸ªå€¼éƒ½æ˜¯-1, ä»£è¡¨æ¯ä¸ªç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚æˆ‘ä»¬éåŽ†gridä¸­çš„æ¯ä¸ªç‚¹, grid[i][j]ï¼Œ åˆ†åˆ«è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š \n\n'/':  ä¸Šã€å·¦è¿žæŽ¥ï¼› ä¸‹ã€å³è¿žæŽ¥\n'\\\\': ä¸Šã€å³è¿žæŽ¥ï¼› å·¦ã€ä¸‹è¿žæŽ¥\n' ': å››ä¸ªéƒ¨åˆ†è¿žæŽ¥\n\nå¯¹æ¯ä¸ªgrid[i][j], åˆå¹¶grid[i-1][j]çš„bottomä¸‰è§’å½¢æ ¹grid[i][j]çš„top ä¸‰è§’å½¢ï¼›åˆå¹¶grid[i][j-1]çš„rightä¸‰è§’å½¢è·Ÿgrid[i][j]çš„leftä¸‰è§’å½¢ã€‚\n\næœ€ç»ˆä»£ç å¦‚ä¸‹:\n\n```c++\nclass DSU {\nprivate:\n    // use array represents a graph\n    vector<int> parent;\n    int row = 0;\npublic:\n    // num of root of independent cluster\n    int num_root = 0;\n\n    DSU(int n) {\n        parent = vector<int>(n * n * 4, -1);\n        num_root = n * n * 4;\n        row = n;\n    }\n\n    int find(int x) {\n        // find the root of the cluster where x is iteratively\n        while (parent[x] != -1) {\n            x = parent[x];\n        }\n        return x;\n    }\n\n    /**\n    * return: 1: successfully; 0: failed\n    */\n    int union_cluster(int x, int y) {\n        int x_root = find(x);\n        int y_root = find(y);\n        if (x_root == y_root) {\n            return 0;\n        } else {\n            int min_ = min(x_root, y_root);\n            int max_ = max(x_root, y_root);\n            parent[min_] = max_;\n            \n            num_root--;\n            return 1;\n        };\n    }\n\n    /**\n     * å°†å›¾ä¸­ï¼ˆi,j)ä½ç½®çš„ç‚¹ï¼Œæ˜ å°„åˆ°æ•°ç»„çš„idx\n     * @param i\n     * @param j\n     * @param part\n     * @param n\n     * @return\n     */\n    int idx(int i, int j, int part) {\n        return (i * row + j) * 4 + part;\n    }\n};\n\n\n// https://leetcode.com/problems/regions-cut-by-slashes/discuss/205680/JavaC%2B%2BPython-Split-4-parts-and-Union-Find\nint regionsBySlashes(vector<string> &grid) {\n    if (grid.empty()) return 0;\n    int n = (int) grid.size();\n\n    DSU dsu = DSU(n);\n\n    for (int i = 0; i < n; ++i) {\n        for (int j = 0; j < n; ++j) {\n            // merge the bottom part of the (i-1, j) grid and the top part of the grid (i, j)\n            if (i > 0) dsu.union_cluster(dsu.idx(i - 1, j, 2), dsu.idx(i, j, 0));\n            // merge the right part of the (i, j-1) grid and the left part of the grid(i,j)\n            if (j > 0) dsu.union_cluster(dsu.idx(i, j - 1, 1), dsu.idx(i, j, 3));\n\n            if (grid[i][j] == '/') {\n                // union the top and the left part of this cell\n                dsu.union_cluster(dsu.idx(i, j, 3), dsu.idx(i, j, 0));\n                // union the right and the bottom of this cell\n                dsu.union_cluster(dsu.idx(i, j, 2), dsu.idx(i, j, 1));\n            }\n\n            if (grid[i][j] == '\\\\') {\n                dsu.union_cluster(dsu.idx(i, j, 0), dsu.idx(i, j, 1));\n                dsu.union_cluster(dsu.idx(i, j, 2), dsu.idx(i, j, 3));\n            }\n\n            if (grid[i][j] == ' ') {\n                dsu.union_cluster(dsu.idx(i, j, 0), dsu.idx(i, j, 2));\n                dsu.union_cluster(dsu.idx(i, j, 1), dsu.idx(i, j, 3));\n                dsu.union_cluster(dsu.idx(i, j, 1), dsu.idx(i, j, 2));\n            }\n        }\n    }\n\n    return dsu.num_root;\n}\n\n```\n\nhttps://leetcode.com/problems/regions-cut-by-slashes/discuss/205680/JavaC%2B%2BPython-Split-4-parts-and-Union-Find\n","tags":["Algorithm"],"categories":["Algorithm"]},{"title":"XMPP(6):XMPP-æ¶ˆæ¯å­˜å‚¨ä¸Žæ‹‰å–åŽ†å²æ¶ˆæ¯","url":"/2019/04/10/XMPP-6-XMPP-æ¶ˆæ¯å­˜å‚¨ä¸Žæ‹‰å–åŽ†å²æ¶ˆæ¯/","content":"\n\nXEP-0313å®šä¹‰äº†XMPPæ¶ˆæ¯å­˜å‚¨çš„è§„åˆ™ã€‚\n\n### åœºæ™¯éœ€æ±‚\n0313åè®®ä¸»è¦æœ‰è¿™äº›åœºæ™¯ï¼š \n- åŒè´¦å·å¤šå®¢æˆ·ç«¯ä¹‹é—´çš„åŽ†å²æ¶ˆæ¯åŒæ­¥\n- å®¢æˆ·ç«¯æ‹‰å–åŽ†å²æ¶ˆæ¯ï¼ŒæŒ‰æ—¥æœŸæŽ’åºå±•ç¤ºï¼ˆæƒ³æƒ³æˆ‘ä»¬åœ¨å¾®ä¿¡çš„åŽ†å²æ¶ˆæ¯ï¼‰\n- åˆ†é¡µæ‹‰å–æ¶ˆæ¯\n\n### å­˜å‚¨\n\n1. å•æ¡æ¶ˆæ¯å­˜å‚¨åŒ…æ‹¬ï¼š \n- æ¶ˆæ¯å‘é€è·ŸæŽ¥æ”¶çš„æ—¶é—´æˆ³\n- from è·Ÿ to çš„JID\n- server-assigned UID\n- message stanza \n\n2. æ¶ˆæ¯çš„é¡ºåºè¦ä¿å­˜ï¼š ä¾èµ–timestampè¦å°å¿ƒï¼Œå› ä¸ºå¤šæ¡æ¶ˆæ¯å¯èƒ½å…±äº«æ—¶é—´æˆ³\n3. è¶…è¿‡ä¸€å®šæ•°é‡ï¼Œå¯åˆ é™¤æ—§ä¿¡æ¯\n4. ç¾¤èŠè®°å½•ç”¨MAMæœåŠ¡\n5. archive id ` <stanza-id/>`\nè¢«archivedè¿‡çš„æ¶ˆæ¯ï¼Œserverè¦ç»™å®ƒåŠ ä¸Šstanza-id\nExample 1. Client receives a message that has been archived\n\n```xml\n<message to='juliet@capulet.lit/balcony'\n         from='romeo@montague.lit/orchard'\n         type='chat'>\n  <body>Call me but love, and I'll be new baptized; Henceforth I never will be Romeo.</body>\n  <stanza-id xmlns='urn:xmpp:sid:0' by='juliet@capulet.lit' id='28482-98726-73623' />\n</message>\n\n```\nstanza-id: archive ID \n\n### æŸ¥è¯¢\n\n#### 1. A user queries their archive for messages\nç”¨æ¶ˆæ¯UIDæŸ¥è¯¢\n\n'urn:xmpp:mam:2' namespace, indicating the UID of the first and last message of the (possibly limited) result set. \n\n```xml\n<iq type='set' id='juliet1'>\n  <query xmlns='urn:xmpp:mam:2' queryid='f27' />\n</iq>\n```\n\n#### 2. Their server sends the matching messages\n\n\n\n```xml\n<message id='aeb213' to='juliet@capulet.lit/chamber'>\n  <result xmlns='urn:xmpp:mam:2' queryid='f27' id='28482-98726-73623'>\n    <forwarded xmlns='urn:xmpp:forward:0'>\n      <delay xmlns='urn:xmpp:delay' stamp='2010-07-10T23:08:25Z'/>\n      <message xmlns='jabber:client' from=\"witch@shakespeare.lit\" to=\"macbeth@shakespeare.lit\">\n        <body>Hail to thee</body>\n      </message>\n    </forwarded>\n  </result>\n</message>\n\n```\n\n#### 3. Server returns the result IQ to signal the end\n\n\n```xml\n<iq type='result' id='juliet1'>\n  <fin xmlns='urn:xmpp:mam:2'>\n    <set xmlns='http://jabber.org/protocol/rsm'>\n      <first index='0'>28482-98726-73623</first>\n      <last>09af3-cc343-b409f</last>\n    </set>\n  </fin>\n</iq>\n```\n\nserverçš„è¿™æ¡iq stanzaæ ‡è®°æŸ¥è¯¢ç»“æžœç»“æŸã€‚\n\n### è¿‡æ»¤å™¨\n\n#### 1. æ ¹æ®JIDè¿‡æ»¤\n\n`with` å­—æ®µ + JID(Bare JID)ï¼š ä¼šæ‹¿åˆ°toæˆ–fromåœ°å€åŒ¹é…JIDçš„ä¿¡æ¯; å¦‚æžœæ²¡æœ‰with, æœåŠ¡ç«¯è¿”å›žqueryæŒ‡å®šçš„æ—¶é—´æ®µå†…çš„æ¶ˆæ¯ã€‚ \n\n```xml \nExample 6. Querying for all messages to/from a particular JIDÂ¶\n<iq type='set' id='juliet1'>\n  <query xmlns='urn:xmpp:mam:2'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field var='FORM_TYPE' type='hidden'>\n        <value>urn:xmpp:mam:2</value>\n      </field>\n      <field var='with'>\n        <value>juliet@capulet.lit</value>\n      </field>\n    </x>\n  </query>\n</iq>\n```\n\n**ä½¿ç”¨åœºæ™¯ï¼š**\nAæƒ³æŸ¥è¯¢è·ŸBçš„èŠå¤©è®°å½•ï¼Œwithå­—æ®µçš„valueè®¾ä¸ºB, æœåŠ¡ç«¯è¿”å›žçš„messagesä¸­ï¼Œæ—¢æœ‰Bå‘é€ç»™Açš„msgï¼Œä¹Ÿæœ‰Aå‘é€ç»™Bçš„msgã€‚ \n\n![3c4760c7.png](/img/f3eaaed1-370f-4abc-93b2-a3312d3ebcd4/3c4760c7.png)\n#### 2. æ ¹æ®æŽ¥æ”¶æ—¶é—´è¿‡æ»¤\n\n`start` è·Ÿ `end` å­—æ®µæ ‡è®°æ—¶é—´æˆ³ã€‚ æ—¶é—´æˆ³æ ¼å¼è§https://xmpp.org/extensions/xep-0082.html\n\n```xml\nExample 7. Querying the archive for all messages in a certain timespanÂ¶\n<iq type='set' id='juliet1'>\n  <query xmlns='urn:xmpp:mam:2'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field var='FORM_TYPE' type='hidden'>\n        <value>urn:xmpp:mam:2</value>\n      </field>\n      <field var='start'>\n         // UTCæ ¼å¼\n        <value>2010-06-07T00:00:00Z</value>\n      </field>\n      <field var='end'>\n        <value>2010-07-07T13:23:54Z</value>\n      </field>\n    </x>\n  </query>\n</iq>\n```\nå¦‚æžœ`end` ç¼ºå¤±ï¼Œ serverä¼šè‡ªåŠ¨è®¤ä¸ºæ˜¯æœ€è¿‘çš„æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´\n\n``` xml\nExample 8. Querying the archive for all messages after a certain timeÂ¶\n<iq type='set' id='juliet1'>\n  <query xmlns='urn:xmpp:mam:2'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field var='FORM_TYPE' type='hidden'>\n        <value>urn:xmpp:mam:2</value>\n      </field>\n      <field var='start'>\n        <value>2010-08-07T00:00:00Z</value>\n      </field>\n    </x>\n  </query>\n</iq>   \n```\n\n#### 3. é™å®šresultsçš„æ•°é‡\n\n[Result Set Management (XEP-0059)](https://xmpp.org/extensions/xep-0059.html) \n\n```xml\nExample 9. A query using Result Set ManagementÂ¶\n<iq type='set' id='q29302'>\n  <query xmlns='urn:xmpp:mam:2'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field var='FORM_TYPE' type='hidden'>\n        <value>urn:xmpp:mam:2</value>\n      </field>\n      <field var='start'>\n        <value>2010-08-07T00:00:00Z</value>\n      </field>\n    </x>\n    <set xmlns='http://jabber.org/protocol/rsm'>\n      <max>10</max>\n    </set>\n  </query>\n</iq>\n```\n\nè¿™ä¸ªè¯·æ±‚ï¼ŒæŒ‡å®šå®¢æˆ·ç«¯æœ€å¤šåªèƒ½æ”¶åˆ°10æ¡stanzasã€‚ä½†æœåŠ¡ç«¯çš„è¿”å›žç»“æžœå¯èƒ½å›žæ”¹å˜`set`çš„å†…å®¹ï¼Œè¿”å›žè‡ªå·±é™å®šçš„æ•°é‡ï¼Œæ¯”å¦‚ï¼š è¿™æ˜¯è¿”å›ž`start`æ—¶é—´è·Ÿ`end`æ—¶é—´æ®µå†…çš„20æ¡æ¶ˆæ¯ã€‚\n\n```xml\nExample 10. Server responds to client with limited results using RSMÂ¶\n<!-- result messages -->\n<iq type='result' id='q29302'>\n  <fin xmlns='urn:xmpp:mam:2'>\n    <set xmlns='http://jabber.org/protocol/rsm'>\n      <first index='0'>28482-98726-73623</first>\n      <last>09af3-cc343-b409f</last>\n      <count>20</count>\n    </set>\n  </fin>\n</iq>\n```\n\n#### 4. åˆ†é¡µæ‹‰å–æ¶ˆæ¯\n\nå¦‚æžœä¹‹å‰å·²ç»èŽ·å–äº†mæ¡æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥å†å‘é€åŒæ ·çš„è¯·æ±‚ï¼Œæ‹‰å–ä¸‹ä¸€é¡µæ¶ˆæ¯ã€‚`set`ä¸­è¦å¸¦ä¸Š`after`(ä¸Šæ¬¡æ‹‰å–åˆ°çš„æœ€åŽä¸€æ¡æ¶ˆæ¯çš„UID)\n\n```xml\nExample 11. A page query using Result Set ManagementÂ¶\n<iq type='set' id='q29303'>\n  <query xmlns='urn:xmpp:mam:2'>\n      <x xmlns='jabber:x:data' type='submit'>\n        <field var='FORM_TYPE' type='hidden'><value>urn:xmpp:mam:2</value></field>\n        <field var='start'><value>2010-08-07T00:00:00Z</value></field>\n      </x>\n      <set xmlns='http://jabber.org/protocol/rsm'>\n         <max>10</max>\n         <after>09af3-cc343-b409f</after>\n      </set>\n  </query>\n</iq>\n```\n\nserverè¿”å›žæœ€åŽä¸€é¡µæ¶ˆæ¯ï¼Œä¼šåœ¨ finé‡Œå¤´å¸¦ä¸Š`complete`å±žæ€§ï¼Œå€¼ä¸º`ture`\n\n```xml\nExample 12. Server completes a result with the last page of messagesÂ¶\n<!-- result messages -->\n<iq type='result' id='u29303'>\n  <fin xmlns='urn:xmpp:mam:2' complete='true'>\n    <set xmlns='http://jabber.org/protocol/rsm'>\n      <first index='0'>23452-4534-1</first>\n      <last>390-2342-22</last>\n      <count>16</count>\n    </set>\n  </fin>\n</iq>\n    \n```\n\n**ä½¿ç”¨åœºæ™¯ï¼š**\n\nAå®¢æˆ·ç«¯æœ¬åœ°å­˜å‚¨è·ŸBçš„èŠå¤©ä¿¡æ¯ï¼Œ æœ€åŽä¸€æ¡messageçš„idæ˜¯`09af3-cc343-b409f`ã€‚ çŽ°åœ¨Aæƒ³çœ‹çœ‹æœ€è¿‘çš„æ¶ˆæ¯ï¼ˆ`09af3-cc343-b409f`åŽçš„messageï¼Œå¯ä»¥å‘é€iqè¯·æ±‚ä¸­å¸¦ä¸Š`<after>09af3-cc343-b409f</after>`ã€‚å·®é‡è¯·æ±‚æœ€æ–°æ¶ˆæ¯ï¼ŒåŸºäºŽæ¸¸æ ‡çš„åˆ†é¡µã€‚\n#### 5.å…¶ä»–å­—æ®µçš„ç­›é€‰\n\nå®¢æˆ·ç«¯æŸ¥è¯¢æœåŠ¡ç«¯æ”¯æŒçš„å…¶ä»–å­—æ®µ\n```xml\nExample 13. Client requests supported query fieldsÂ¶\n<iq type='get' id='form1'>\n  <query xmlns='urn:xmpp:mam:2'/>\n</iq>\n```\n\n```xml\nExample 14. Server returns supported fieldsÂ¶\n<iq type='result' id='form1'>\n  <query xmlns='urn:xmpp:mam:2'>\n    <x xmlns='jabber:x:data' type='form'>\n      <field type='hidden' var='FORM_TYPE'>\n        <value>urn:xmpp:mam:2</value>\n      </field>\n      <field type='jid-single' var='with'/>\n      // æŒ‰æ¶ˆæ¯receivedæ—¶é—´æŸ¥è¯¢\n      <field type='text-single' var='start'/>\n      <field type='text-single' var='end'/>\n      // æŒ‰æ–‡æœ¬æŸ¥è¯¢\n      <field type='text-single' var='urn:example:xmpp:free-text-search'/>\n      // stanzaå†…å®¹\n      <field type='text-single' var='urn:example:xmpp:stanza-content'/>\n    </x>\n  </query>\n</iq>\n```\n### è¿”å›žçš„message stanza ç»“æž„\n\n- `message`è¢«å°è£…åœ¨`forwarded`å…ƒç´ ä¸­ã€‚ [XEP-0297: Stanza Forwarding](https://xmpp.org/extensions/xep-0297.html)\n- å¸¦`result` å…ƒç´ ï¼Œ å…¶å±žæ€§idæ˜¯è¿™æ¡messageçš„UID\n- delayå…ƒç´  [XEP-0203: Delayed Delivery](https://xmpp.org/extensions/xep-0203.html) messageè¢«æ”¶åˆ°çš„æ—¶é—´, UTCæ—¶é—´æˆ³æ ¼å¼\n\n\n```xml\nExample 16. Server returns two matching messagesÂ¶\n<message id='aeb213' to='juliet@capulet.lit/chamber'>\n  <result xmlns='urn:xmpp:mam:2' queryid='f27' id='28482-98726-73623'>\n    <forwarded xmlns='urn:xmpp:forward:0'>\n      <delay xmlns='urn:xmpp:delay' stamp='2010-07-10T23:08:25Z'/>\n      <message xmlns='jabber:client'\n        to='juliet@capulet.lit/balcony'\n        from='romeo@montague.lit/orchard'\n        type='chat'>\n        <body>Call me but love, and I'll be new baptized; Henceforth I never will be Romeo.</body>\n      </message>\n    </forwarded>\n  </result>\n</message>\n\n<message id='aeb214' to='juliet@capulet.lit/chamber'>\n  <result xmlns='urn:xmpp:mam:2' queryid='f27' id='5d398-28273-f7382'>\n    <forwarded xmlns='urn:xmpp:forward:0'>\n      <delay xmlns='urn:xmpp:delay' stamp='2010-07-10T23:09:32Z'/>\n      <message xmlns='jabber:client'\n         to='romeo@montague.lit/orchard'\n         from='juliet@capulet.lit/balcony'\n         type='chat' id='8a54s'>\n        <body>What man art thou that thus bescreen'd in night so stumblest on my counsel?</body>\n      </message>\n    </forwarded>\n  </result>\n</message>\n    \n```\n\n## MUC Archive\n\n- å­˜å‚¨æ‰€æœ‰å‘é€ç»™roomJidçš„message\n- ä¸åŒ…å«`private message`\n- useréœ€è¦æƒé™æŸ¥è¯¢ç¾¤åŽ†å²èŠå¤©è®°å½•\n- `forward` stanzaä¸­å¸¦æœ‰`to`å±žæ€§,å€¼æ˜¯roomJidï¼Œ`from`å€¼æ˜¯userJid \n- `x`é‡Œæœ‰è¯¥æ¶ˆæ¯çš„å‘é€è€…Jid\n```xml\nExample 17. Server returns MUC messagesÂ¶\n<message id='iasd207' from='coven@chat.shakespeare.lit' to='hag66@shakespeare.lit/pda'>\n  <result xmlns='urn:xmpp:mam:2' queryid='g27' id='34482-21985-73620'>\n    <forwarded xmlns='urn:xmpp:forward:0'>\n      <delay xmlns='urn:xmpp:delay' stamp='2002-10-13T23:58:37Z'/>\n      <message xmlns=\"jabber:client\"\n        from='coven@chat.shakespeare.lit/firstwitch'\n        id='162BEBB1-F6DB-4D9A-9BD8-CFDCC801A0B2'\n        type='groupchat'>\n        <body>Thrice the brinded cat hath mew'd.</body>\n        <x xmlns='http://jabber.org/protocol/muc#user'>\n          <item affiliation='none'\n                jid='witch1@shakespeare.lit'\n                role='participant' />\n        </x>\n      </message>\n    </forwarded>\n  </result>\n</message>\n\n<message id='iasd207' from='coven@chat.shakespeare.lit' to='hag66@shakespeare.lit/pda'>\n  <result xmlns='urn:xmpp:mam:2' queryid='g27' id='34482-21985-73620'>\n    <forwarded xmlns='urn:xmpp:forward:0'>\n      <delay xmlns='urn:xmpp:delay' stamp='2002-10-13T23:58:43Z'/>\n      <message xmlns=\"jabber:client\"\n        from='coven@chat.shakespeare.lit/secondwitch'\n        id='90057840-30FD-4141-AA44-103EEDF218FC'\n        type='groupchat'>\n        <body>Thrice and once the hedge-pig whined.</body>\n        <x xmlns='http://jabber.org/protocol/muc#user'>\n          <item affiliation='none'\n                jid='witch2@shakespeare.lit'\n                role='participant' />\n        </x>\n      </message>\n    </forwarded>\n  </result>\n</message>\n```\n[XEP-0313: Message Archive Management](https://xmpp.org/extensions/xep-0313.html#intro)","categories":["XMPP"]},{"title":"XMPP(5): æ¶ˆæ¯","url":"/2019/04/09/XMPP-5-æ¶ˆæ¯/","content":"\n \n## Messageæ¶ˆæ¯ä½“æž„é€ \n\nå±žæ€§ï¼š \n1. to ï¼šæŽ¥æ”¶æ–¹åœ°å€ï¼Œ JID \n2. from ï¼š å‘é€æ–¹ï¼Œ JID\n3. type \n  - chat: ä¸€å¯¹ä¸€èŠå¤©\n  - error: å‡ºé”™\n  - groupchat: ç¾¤èŠ\n  - headline: é€šçŸ¥ã€ä¸´æ—¶æ¶ˆæ¯è¿™ç§ä¸éœ€è¦å›žå¤çš„ç³»ç»Ÿæ¶ˆæ¯\n  - normal: ä¹‹å‰æ²¡æœ‰èŠå¤©çš„è®°å½•ï¼Œ å®¢æˆ·ç«¯å¯ä»¥å›žå¤çš„æ¶ˆæ¯\n\nå­å…ƒç´ \n1. body: æ¶ˆæ¯å†…å®¹\n\n```xml\n<message\n    from='juliet@example.com/balcony'\n    id='b4vs9km4'\n    to='romeo@example.net'\n    type='chat'\n    xml:lang='en'>\n  <body>Wherefore art thou, Romeo?</body>\n</message>\n\n```\n2. Subject: èŠå¤©çš„è¯é¢˜\n\n```xml\n\n<message\n    from='juliet@example.com/balcony'\n    id='c8xg3nf8'\n    to='romeo@example.net'\n    type='chat'\n    xml:lang='en'>\n  <subject>I implore you!</subject>\n  <body>Wherefore art thou, Romeo?</body>\n</message>\n```\n\n3. Thread: èŠå¤©ä¼šè¯çš„å”¯ä¸€æ ‡è¯†\n\n## Example \n\nå¯¹è¯ï¼š \n\n```xml\nCC: <message\n        from='juliet@example.com/balcony'\n        to='romeo@example.net'\n        type='chat'\n        xml:lang='en'>\n      <body>My ears have not yet drunk a hundred words</body>\n      <thread>e0ffe42b28561960c6b12b944a092794b9683a38</thread>\n    </message>\n\nCC: <message\n        from='juliet@example.com/balcony'\n        to='romeo@example.net'\n        type='chat'\n        xml:lang='en'>\n      <body>Of that tongue's utterance, yet I know the sound:</body>\n      <thread>e0ffe42b28561960c6b12b944a092794b9683a38</thread>\n    </message>\n\nCC: <message\n        from='juliet@example.com/balcony'\n        to='romeo@example.net'\n        type='chat'\n        xml:lang='en'>\n      <body>Art thou not Romeo, and a Montague?</body>\n      <thread>e0ffe42b28561960c6b12b944a092794b9683a38</thread>\n    </message>\n\nUC: <message\n        from='romeo@example.net/orchard'\n        to='juliet@example.com/balcony'\n        type='chat'\n        xml:lang='en'>\n      <body>Neither, fair saint, if either thee dislike.</body>\n      <thread>e0ffe42b28561960c6b12b944a092794b9683a38</thread>\n    </message>\n\nCC: <message\n        from='juliet@example.com/balcony'\n        to='romeo@example.net/orchard'\n        type='chat'\n        xml:lang='en'>\n      <body>How cam'st thou hither, tell me, and wherefore?</body>\n      <thread>e0ffe42b28561960c6b12b944a092794b9683a38</thread>\n    </message>\n\n```\n\nåœ¨[xmpp.js](https://github.com/xmppjs/xmpp.js/)ä¸­ï¼Œå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯å»ºç«‹äº†WebSocketé•¿é“¾æŽ¥åŽï¼Œå‘æ¶ˆæ¯ï¼Œéœ€è¦è‡ªå·±æž„é€ æ¶ˆæ¯ä½“\n\n``` js \nconst {client, xml} = require('@xmpp/client')\n\nconst xmpp = client({\n  service: 'ws://localhost:5280/xmpp-websocket',\n  domain: 'localhost',\n  resource: 'example',\n  username: 'username',\n  password: 'password',\n})\n\n const message = xml(\n    'message',\n    {type: 'chat', to: address},\n    xml('body', 'hello world')\n  )\n  await xmpp.send(message)\n\n```\n\nå¦‚æžœæ”¶åˆ°æ¶ˆæ¯ä¼šèµ°åˆ°ä¸€ä¸ªå›žè°ƒé‡Œ, chat-sdkå°±å¯ä»¥æ ¹æ®typeå­—æ®µæ¥åˆ†å‘ã€‚\n\n\n```js \nself.xmppClient.on('stanza', function (stanza: any) {\n    Utils.DLog('[Chat] RECV:', stanza.toString());\n    /**\n     * Detect typeof incoming stanza\n     * and fire the Listener\n     */\n    if (stanza.is('presence')) {\n        self._onPresence(stanza);\n    } else if (stanza.is('iq')) {\n        self._onIQ(stanza);\n    } else if (stanza.is('message')) {\n        if (stanza.attrs.type === 'headline') {\n            self._onSystemMessageListener(stanza);\n        } else if (stanza.attrs.type === 'error') {\n            self._onMessageErrorListener(stanza);\n        } else {\n            self._onMessage(stanza);\n        }\n    }\n});\n```\n\n- ref: https://xmpp.org/rfcs/rfc6121.html#message","categories":["XMPP"]},{"title":"JWT å…¥é—¨","url":"/2019/04/03/JWT-å…¥é—¨/","content":"\n\n## ä»€ä¹ˆæ˜¯JSON Web Tokens (JWT)ï¼Ÿ \n\n\n```\n  JSON Web Token (JWT) is a compact, URL-safe means of representing\n   claims to be transferred between two parties.  The claims in a JWT\n   are encoded as a JSON object that is used as the payload of a JSON\n   Web Signature (JWS) structure or as the plaintext of a JSON Web\n   Encryption (JWE) structure, enabling the claims to be digitally\n   signed or integrity protected with a Message Authentication Code\n   (MAC) and/or encrypted.\n   \n\n```\n\n## æ€Žä¹ˆç”¨ï¼Ÿ \n\nauthenticationæ—¶ï¼Œå½“useræˆåŠŸç™»å½•ï¼Œserverç”Ÿæˆaccess token, å‘é€ç»™userï¼›userè¯·æ±‚serveræ—¶å¸¦ä¸ŠJWTï¼Œserveré€šè¿‡JWTéªŒè¯æ˜¯å¦æ˜¯å¯ä¿¡ä»»çš„å®¢æˆ·ç«¯è¯·æ±‚äº†ã€‚\n\n\n![1*SSXUQJ1dWjiUrDoKaaiGLA.png](https://cdn-images-1.medium.com/max/1600/1*SSXUQJ1dWjiUrDoKaaiGLA.png)\n\n## ç»“æž„\n\nåœ¨å®¢æˆ·ç«¯çœ‹æ¥JWTæ˜¯ä¸€ä¸²encodeåŠ å¯†è¿‡çš„å­—ç¬¦ä¸²,`header.payload.signature`ï¼Œå¦‚ä¸‹å›¾å·¦è¾¹ã€‚ä½†å®ƒdecodeåŽå…¶å®žæ˜¯ä¸‹å›¾å³è¾¹çš„JSONç»“æž„ä½“\n\n![legacy-app-auth-5.png](https://cdn.auth0.com/blog/legacy-app-auth/legacy-app-auth-5.png)\n\n#### 1. ç”Ÿæˆheader\n\ne.g.\n```json\n{\n  \"alg\": \"HS256\",\n  \"typ\": \"JWT\"\n}\n```\n\nè¿™é‡Œï¼Œalgçš„å€¼æŒ‡å®šç”¨HMAC-SHA256ç®—æ³•ç­¾å\n\n#### 2. ç”Ÿæˆpayload\n\nåŒ…å«ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯\n```\nThe second part of the token is the payload, which contains the claims. \nClaims are statements about an entity (typically, the user) and additional data. \n```\næœ‰ä¸‰ç§[claims](https://tools.ietf.org/html/rfc7519#section-4.1): registered, public, and private claims.\n\ne.g.\n```json\n\n{\n  \"sub\": \"1234567890\",\n  \"name\": \"John Doe\",\n  \"iat\": 1516239022\n}\n```\n\n#### 3.ç”Ÿæˆsignature\n\n```js\n\nHMACSHA256(\n  base64UrlEncode(header) + \".\" +\n  base64UrlEncode(payload),\n  your-256-bit-secret\n) \n```\næŠŠheaderè·Ÿpayload encodeç»“æž„åŽï¼Œç”¨'.'è¿žæŽ¥ï¼Œç”Ÿæˆ: <span style=\"color:#fb015b\"> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span>.</span>\n<span style=\"color:#d63aff\"> eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ</span>\n\nå†ç”¨æŒ‡å®šçš„hashç®—æ³•(ä¾‹å­æ˜¯HS256),ç”¨ç§é’¥ï¼ˆæœåŠ¡ç«¯çš„ï¼‰ç”Ÿæˆç­¾å:<span style=\"color:#00b9f1\">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c<span>\n\n\n## éªŒè¯\n\nå¦‚å›¾1ï¼Œ JWTç”±Authentication serverç”Ÿæˆï¼Œ åœ¨clientè®¤è¯åŽå‘ç»™clientï¼› clientè¯·æ±‚application serverçš„æ—¶å€™å¸¦ä¸ŠJWTï¼Œapplication serveråœ¨è®¤è¯é˜¶æ®µä»ŽAuthentiation serveré‚£å„¿æ‹¿åˆ°scret keyï¼›ç”¨åŒæ ·ç®—æ³•ç”Ÿæˆsignatureï¼Œ è·Ÿclientå‘æ¥çš„JWTçš„signatureåšæ¯”è¾ƒï¼Œçœ‹æ˜¯å¦matchã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n[5 Easy Steps to Understanding JSON Web Tokens (JWT)](https://medium.com/vandium-software/5-easy-steps-to-understanding-json-web-tokens-jwt-1164c0adfcec)\n[JSON Web Token Introduction - jwt.io](https://jwt.io/introduction/) \n[RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)","tags":["Auth"],"categories":["Network"]},{"title":"XMPP(4):Search å’Œ vCard","url":"/2019/03/31/XMPP-4-Search-vCard/","content":"`jabber:iq:search`åè®®ç”¨æ¥æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ã€‚\n\n1. æˆ‘ä»¬å…ˆæŸ¥è¯¢å¯ä»¥ç”¨å“ªäº›å­—æ®µæŸ¥æ‰¾ç”¨æˆ·\n<!-- more -->\n\n# XMPP Search \n\n`jabber:iq:search`åè®®ç”¨æ¥æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ã€‚\n\n1. æˆ‘ä»¬å…ˆæŸ¥è¯¢å¯ä»¥ç”¨å“ªäº›å­—æ®µæŸ¥æ‰¾ç”¨æˆ·\n\n```xml\n// Requesting Search Fields\n\n<iq type='get'\n    from='romeo@montague.net/home'\n    to='characters.shakespeare.lit'\n    id='search1'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'/>\n</iq>\n```\n\n2. service è¿”å›ž\n\n```xml\n// Receiving Search Fields\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search1'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <instructions>\n      Fill in one or more fields to search\n      for any matching Jabber users.\n    </instructions>\n    <first/>\n    <last/>\n    <nick/>\n    <email/>\n  </query>\n</iq>\n```\n3. æœåŠ¡ç«¯è¿”å›žï¼Œå¯ä»¥ç”¨`first` `last` `nick` `email` è¿™å‡ ä¸ªå­—æ®µæ‰¾äººã€‚æŽ¥ç€å°±ç”¨lastæŸ¥äºº.\n\n```xml\n// Submitting a Search Request\n\n<iq type='set'\n    from='romeo@montague.net/home'\n    to='characters.shakespeare.lit'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <last>Capulet</last>\n  </query>\n</iq>\n```\n\næœåŠ¡ç«¯å¯ä»¥èƒ½ä¼šè¿”å›žå¥½å¤šä¸ªlaståŒ¹é…çš„item\n```xml\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <item jid='juliet@capulet.com'>\n      <first>Juliet</first>\n      <last>Capulet</last>\n      <nick>JuliC</nick>\n      <email>juliet@shakespeare.lit</email>\n    </item>\n    <item jid='tybalt@shakespeare.lit'>\n      <first>Tybalt</first>\n      <last>Capulet</last>\n      <nick>ty</nick>\n      <email>tybalt@shakespeare.lit</email>\n    </item>\n  </query>\n</iq>\n```\næ²¡æœ‰ç»“æžœçš„è¯ï¼Œqueryå°±æ²¡æœ‰å­å…ƒç´ \n\n```xml\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'/>\n</iq>\n```\n\nXMPP Search \n\n`jabber:iq:search`åè®®ç”¨æ¥æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ã€‚\n\næˆ‘ä»¬å…ˆæŸ¥è¯¢å¯ä»¥ç”¨å“ªäº›å­—æ®µæŸ¥æ‰¾ç”¨æˆ·\n\n```xml\n// Requesting Search Fields\n\n<iq type='get'\n    from='romeo@montague.net/home'\n    to='characters.shakespeare.lit'\n    id='search1'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'/>\n</iq>\n```\n\nservice è¿”å›ž\n\n```xml\n// Receiving Search Fields\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search1'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <instructions>\n      Fill in one or more fields to search\n      for any matching Jabber users.\n    </instructions>\n    <first/>\n    <last/>\n    <nick/>\n    <email/>\n  </query>\n</iq>\n```\næœåŠ¡ç«¯è¿”å›žï¼Œå¯ä»¥ç”¨`first` `last` `nick` `email` è¿™å‡ ä¸ªå­—æ®µæ‰¾äººã€‚æŽ¥ç€å°±ç”¨lastæŸ¥äºº.\n\n```xml\n// Submitting a Search Request\n\n<iq type='set'\n    from='romeo@montague.net/home'\n    to='characters.shakespeare.lit'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <last>Capulet</last>\n  </query>\n</iq>\n```\n\næœåŠ¡ç«¯å¯ä»¥èƒ½ä¼šè¿”å›žå¥½å¤šä¸ªlaståŒ¹é…çš„item\n```xml\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'>\n    <item jid='juliet@capulet.com'>\n      <first>Juliet</first>\n      <last>Capulet</last>\n      <nick>JuliC</nick>\n      <email>juliet@shakespeare.lit</email>\n    </item>\n    <item jid='tybalt@shakespeare.lit'>\n      <first>Tybalt</first>\n      <last>Capulet</last>\n      <nick>ty</nick>\n      <email>tybalt@shakespeare.lit</email>\n    </item>\n  </query>\n</iq>\n```\næ²¡æœ‰ç»“æžœçš„è¯ï¼Œqueryå°±æ²¡æœ‰å­å…ƒç´ \n\n```xml\n<iq type='result'\n    from='characters.shakespeare.lit'\n    to='romeo@montague.net/home'\n    id='search2'\n    xml:lang='en'>\n  <query xmlns='jabber:iq:search'/>\n</iq>\n```\n\n# vCard \nvCardåè®®ä¸»è¦è´Ÿè´£ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ï¼Œå°±åƒä¸ªäººåç‰‡ã€‚\n\n1. æŸ¥çœ‹è‡ªå·±çš„vCard\nå¦‚æžœå®¢æˆ·ç«¯æƒ³æŸ¥è¯¢è‡ªå·±çš„vCard, éœ€è¦å‘é€IQ-set stanzaï¼Œæ³¨æ„æ²¡æœ‰toåœ°å€å“¦ã€‚\n\n```xml\n<iq from='stpeter@jabber.org/roundabout'\n    id='v1'\n    type='get'>\n  <vCard xmlns='vcard-temp'/>\n</iq>\n```\n\n2. è¿”å›žä¿¡æ¯\næŽ¥ç€æœåŠ¡ç«¯è¿”å›žä¸€å †çš„ç”¨æˆ·ä¿¡æ¯\n\n```xml\n\n<iq id='v1'\n    to='stpeter@jabber.org/roundabout'\n    type='result'>\n  <vCard xmlns='vcard-temp'>\n    <FN>Peter Saint-Andre</FN>\n    <N>\n      <FAMILY>Saint-Andre</FAMILY>\n      <GIVEN>Peter</GIVEN>\n      <MIDDLE/>\n    </N>\n    <NICKNAME>stpeter</NICKNAME>\n    <URL>http://www.xmpp.org/xsf/people/stpeter.shtml</URL>\n    <BDAY>1966-08-06</BDAY>\n    <ORG>\n      <ORGNAME>XMPP Standards Foundation</ORGNAME>\n      <ORGUNIT/>\n    </ORG>\n    <TITLE>Executive Director</TITLE>\n    <ROLE>Patron Saint</ROLE>\n    <TEL><WORK/><VOICE/><NUMBER>303-308-3282</NUMBER></TEL>\n    <TEL><WORK/><FAX/><NUMBER/></TEL>\n    <TEL><WORK/><MSG/><NUMBER/></TEL>\n    <ADR>\n      <WORK/>\n      <EXTADD>Suite 600</EXTADD>\n      <STREET>1899 Wynkoop Street</STREET>\n      <LOCALITY>Denver</LOCALITY>\n      <REGION>CO</REGION>\n      <PCODE>80202</PCODE>\n      <CTRY>USA</CTRY>\n    </ADR>\n    <TEL><HOME/><VOICE/><NUMBER>303-555-1212</NUMBER></TEL>\n    <TEL><HOME/><FAX/><NUMBER/></TEL>\n    <TEL><HOME/><MSG/><NUMBER/></TEL>\n    <ADR>\n      <HOME/>\n      <EXTADD/>\n      <STREET/>\n      <LOCALITY>Denver</LOCALITY>\n      <REGION>CO</REGION>\n      <PCODE>80209</PCODE>\n      <CTRY>USA</CTRY>\n    </ADR>\n    <EMAIL><INTERNET/><PREF/><USERID>stpeter@jabber.org</USERID></EMAIL>\n    <JABBERID>stpeter@jabber.org</JABBERID>\n    <DESC>\n      More information about me is located on my\n      personal website: http://www.saint-andre.com/\n    </DESC>\n  </vCard>\n</iq>\n```\nå¦‚æžœæ²¡æœ‰ç›¸å…³vCardï¼Œä¼šè¿”å›žerror\n```xml\n// item-not-found\n<iq id='v1'\n    to='stpeter@jabber.org/roundabout'\n    type='error'>\n  <vCard xmlns='vcard-temp'/>\n  <error type='cancel'>\n    <item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n```\n\n```xml\n// empty element\n<iq id='v1'\n    to='stpeter@jabber.org/roundabout'\n    type='result'>\n  <vCard xmlns='vcard-temp'/>\n</iq>\n\n```\n\n3. æŸ¥çœ‹åˆ«äººçš„vCard\n\nç”¨IQ-get stanza, å¸¦ä¸Štoåœ°å€\n\n```xml \n\n<iq from='stpeter@jabber.org/roundabout'\n    id='v3'\n    to='jer@jabber.org'\n    type='get'>\n  <vCard xmlns='vcard-temp'/>\n</iq>\n```\n\n```xml\n<iq from='jer@jabber.org'\n    to='stpeter@jabber.org/roundabout'\n    type='result'\n    id='v3'>\n  <vCard xmlns='vcard-temp'>\n    <FN>JeremieMiller</FN>\n    <N>\n      <GIVEN>Jeremie</GIVEN>\n      <FAMILY>Miller</FAMILY>\n      <MIDDLE/>\n    </N>\n    <NICKNAME>jer</NICKNAME>\n    <EMAIL><INTERNET/><PREF/><USERID>jeremie@jabber.org</USERID></EMAIL>\n    <JABBERID>jer@jabber.org</JABBERID>\n  </vCard>\n</iq>\n\n```\n\n4. æ›´æ–°vCard\n\nå®¢æˆ·ç«¯å¯ä»¥ç”¨IQ-set stanza æ›´æ–°è‡ªå·±çš„vCardä¿¡æ¯\n\n```xml\n<iq id='v2' type='set'>\n  <vCard xmlns='vcard-temp'>\n    <FN>Peter Saint-Andre</FN>\n    <N>\n      <FAMILY>Saint-Andre</FAMILY>\n      <GIVEN>Peter</GIVEN>\n      <MIDDLE/>\n    </N>\n    <NICKNAME>stpeter</NICKNAME>\n    <URL>http://www.xmpp.org/xsf/people/stpeter.shtml</URL>\n    <BDAY>1966-08-06</BDAY>\n    <ORG>\n      <ORGNAME>XMPP Standards Foundation</ORGNAME>\n      <ORGUNIT/>\n    </ORG>\n    <TITLE>Executive Director</TITLE>\n    <ROLE>Patron Saint</ROLE>\n    <TEL><WORK/><VOICE/><NUMBER>303-308-3282</NUMBER></TEL>\n    <TEL><WORK/><FAX/><NUMBER/></TEL>\n    <TEL><WORK/><MSG/><NUMBER/></TEL>\n    <ADR>\n      <WORK/>\n      <EXTADD>Suite 600</EXTADD>\n      <STREET>1899 Wynkoop Street</STREET>\n      <LOCALITY>Denver</LOCALITY>\n      <REGION>CO</REGION>\n      <PCODE>80202</PCODE>\n      <CTRY>USA</CTRY>\n    </ADR>\n    <TEL><HOME/><VOICE/><NUMBER>303-555-1212</NUMBER></TEL>\n    <TEL><HOME/><FAX/><NUMBER/></TEL>\n    <TEL><HOME/><MSG/><NUMBER/></TEL>\n    <ADR>\n      <HOME/>\n      <EXTADD/>\n      <STREET/>\n      <LOCALITY>Denver</LOCALITY>\n      <REGION>CO</REGION>\n      <PCODE>80209</PCODE>\n      <CTRY>USA</CTRY>\n    </ADR>\n    <EMAIL><INTERNET/><PREF/><USERID>stpeter@jabber.org</USERID></EMAIL>\n    <JABBERID>stpeter@jabber.org</JABBERID>\n    <DESC>\n      Check out my blog at https://stpeter.im/\n    </DESC>\n  </vCard>\n</iq>\n```\n\næœåŠ¡ç«¯è¿”å›žç»“æžœ\n\n```xml\n<iq id='v2'\n    to='stpeter@jabber.org/roundabout'\n    type='result'/>\n```\n\nref: https://xmpp.org/extensions/xep-0054.html#intro\nref: https://xmpp.org/extensions/xep-0055.html#intro","categories":["XMPP"]},{"title":"å½±å“æ›å…‰çš„3ä¸ªå› ç´ ","url":"/2019/03/31/å½±å“æ›å…‰çš„å‡ ä¸ªå› ç´ /","content":"\n\n\n## è¿›å…‰é‡\n\n`æ›å…‰`ä¹ŸæŒ‡å•ä½é¢ç§¯ä¸Šå…‰å­çš„æ•°é‡ã€‚\n\n- å¦‚æžœæˆ‘ä»¬æ²¡æœ‰æ•èŽ·è¶³å¤Ÿçš„å…‰ï¼Œé‚£ä¹ˆç›¸ç‰‡å°±ä¼š`æ¬ æ›`:\n\n<img src=\"/img/15000130641224/15000133443588.jpg\" width = \"368\" height = \"500\" alt=\"å›¾ç‰‡åç§°\" align=center />\n\n\n- å¦‚æžœæˆ‘ä»¬æ•èŽ·çš„å…‰å¤ªå¤šï¼Œå›¾åƒå°±ä¼š`è¿‡æ›`:\n\n<img src=\"/img/15000130641224/15000133832576.jpg\" width = \"368\" height = \"500\" alt=\"å›¾ç‰‡åç§°\" align=center />\n\n\n\n## ä¸‰ä¸ªè¦ç´ å¯ä»¥å½±å“æ›å…‰çš„è¿›å…‰é‡\n\n- å¿«é—¨é€Ÿåº¦\n- å…‰åœˆ\n- æ„Ÿå…‰åº¦ (ISO)\n\n![](/img/15000130641224/15006272782478.jpg)\n\næƒ³è±¡ç›¸æœºæ˜¯é»‘æš—æˆ¿é—´ï¼Œæœ‰ä¸ªçª—æˆ·ï¼ˆå…‰åœˆï¼‰ï¼Œ æœ‰å—çª—å¸˜ï¼ˆå¿«é—¨ï¼‰ï¼Œçª—æˆ·è¶Šå¤§è¿›å…‰é‡è¶Šå¤§ï¼Œçª—å¸˜æ‹‰å¼€çš„æ—¶é—´è¶Šä¹…ã€‚ çª—æˆ·å¯¹é¢æœ‰é¢é•œå­ï¼ˆæ„Ÿå®˜å…ƒä»¶ï¼‰ï¼Œæ•èŽ·å…‰å­æˆåƒã€‚\n\n## 1.å¿«é—¨é€Ÿåº¦\nå½“æˆ‘ä»¬æ•æ‰å›¾ç‰‡æ—¶ï¼Œå›¾åƒä¼ æ„Ÿå™¨éœ€è¦æ•æ‰ä¸€æ®µæ—¶é—´çš„å…‰ã€‚ è¿™ä¸ªæ—¶é—´æ®µæ›å…‰æ—¶é—´ï¼ˆä¹Ÿå«å¿«é—¨é€Ÿåº¦ã€‚ç›¸æœºä¸­ä¸€èˆ¬ç”¨`1/400ã€8`è¿™æ ·çš„å½¢å¼è¡¨ç¤ºï¼‰è¿™ä¸ªæ•°å€¼è¶Šå¤§ï¼Œå¿«é—¨å¼€å¯çš„æ—¶é—´è¶Šé•¿ï¼Œè¿›å…¥ç›¸æœºçš„å…‰çº¿å°±è¶Šå¤šï¼Œä½†è¿åŠ¨çš„ç‰©ä½“å¾ˆå¯èƒ½æ¨¡ç³Š.\n\nçœ‹ä¸‹å›¾ï¼š \n\n![](/img/15000130641224/15006271573170.jpg)\n\n\n## 2.æ„Ÿå…‰åº¦ (ISO)\n\nå®ƒè¢«ç”¨æ¥è¡¡é‡å›¾åƒä¼ æ„Ÿå™¨å¯¹å…‰çš„`çµæ•ç¨‹åº¦`ï¼Œä»¥åŠå› æ­¤å¸¦æ¥çš„æ›å…‰å™ªéŸ³ã€‚ISOè¶Šå¤§ï¼Œä¼ æ„Ÿå™¨è¶Šçµæ•ï¼Œæ•èŽ·å…‰èƒ½åŠ›è¶Šå¼ºï¼Œç…§ç‰‡è¶Šäº®ï¼Œä½†å™ªç‚¹ä¹Ÿè¶Šå¤šã€‚\n\n![](/img/15000130641224/15006272197963.jpg)\n\n####å·¦ï¼š ISO 32 å’Œ 1/3 ç§’æ›å…‰\n####å³ï¼š ISO 1600 å’Œ 1/180 ç§’\n![](/img/15000130641224/15000247388896.jpg)\n\n\n**å›¾åƒä¼ æ„Ÿå™¨**\nè¿™ä¸ªéƒ¨åˆ†å°±ç›¸å½“äºŽæˆ‘ä»¬çœ¼ç›é‡Œçš„è§†ç½‘è†œã€‚å›¾åƒä¼ æ„Ÿå™¨å¯ä»¥å°†å…‰æˆ–è€…å…‰å­è½¬æ¢ä¸ºç”µä¿¡å·ã€‚\n\n**å›¾åƒä¼ æ„Ÿå™¨æ˜¯ç”±æµ·é‡çš„ç‹¬ä¸ªçš„åƒç´ ä¼ æ„Ÿå™¨ä¸²èµ·æ¥çš„å·¨å¤§çŸ©å½¢åŒºåŸŸ** æˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªåƒç´ ä¼ æ„Ÿå™¨æƒ³è±¡æˆä¸€ä¸ªè£…ç”µè·çš„æ¡¶ã€‚å½“å…‰å­æ’žå‡»åˆ°åƒç´ ä¼ æ„Ÿå™¨çš„å…‰äºŒæžç®¡æ—¶ï¼Œå®ƒä»¬å°†åœ¨è¿™ä¸ªåƒç´ çš„æ¡¶ä¸­ç¼“æ…¢åœ°ç§¯æ”’ç”µè·ã€‚æœ€åŽï¼Œæ¯ä¸ªåƒç´ éƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ä¸€å°æ¡¶ç”µå­ã€‚è¿™äº›ç”µè·çš„æ•°é‡æ˜¯ä¾èµ–äºŽå…‰å­æ•°é‡çš„ -- æˆ–è€…è¯´æ˜¯å†³å®šäºŽæ‰“åˆ°è¿™ä¸ªç‰¹å®šçš„ç‚¹ä¸Šçš„å…‰çš„å¼ºåº¦ã€‚\n\nå› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªåƒç´ ä¼ æ„Ÿå™¨çš„äºŒç»´é˜µåˆ—ï¼Œæˆ‘ä»¬çŽ°åœ¨å°±æ‹¥æœ‰èƒ½å¤Ÿååº”å‡ºæ‰€æœ‰è¿™äº›ä½ç½®çš„å…‰çš„å¼ºåº¦çš„ä¸€ç»„äºŒç»´ç”µè·é˜µåˆ—äº†ã€‚**åœ¨ iPhone 6 ä¸Šï¼Œæˆ‘ä»¬æœ‰å…«ç™¾ä¸‡ä¸ªè¿™æ ·çš„å¾®å°çš„åƒç´ ä¼ æ„Ÿå™¨**ï¼Œä»¥åŠå®ƒä»¬æ‰€å¯¹åº”çš„ç”µè·æ¡¶ã€‚\n\n\n## 3.å…‰åœˆ\n\nç›¸æœºçš„é•œå¤´çš„å…‰åœˆ(Aperture)æ˜¯ç”¨æ¥è¡¡é‡åˆ°è¾¾å›¾åƒæ„Ÿåº”å™¨çš„å…‰æ‰€é€šè¿‡çš„`é€šå­”çš„å¤§å°`çš„\n\n\n#### æ›å…‰å€¼\n\næ›å…‰å€¼ï¼ˆExposure Valueï¼ŒEVï¼‰ä»£è¡¨èƒ½å¤Ÿç»™å‡ºåŒæ ·æ›å…‰çš„æ‰€æœ‰ç›¸æœºå…‰åœˆå¿«é—¨ç»„åˆ\n\n![](/img/15000130641224/15026013567638.jpg)\nå…¶ä¸­Næ˜¯å…‰åœˆï¼ˆfå€¼ï¼‰ï¼›tæ˜¯æ›å…‰æ—¶é—´ï¼ˆå¿«é—¨ï¼‰ï¼Œå•ä½ç§’ã€‚æ›å…‰å€¼0ï¼ˆEV0ï¼‰å¯¹åº”äºŽæ›å…‰æ—¶é—´ä¸º1ç§’è€Œå…‰åœˆä¸ºf/1.0çš„ç»„åˆæˆ–å…¶ç­‰æ•ˆç»„åˆã€‚\n\n`æ›å…‰å€¼ != æ›å…‰é‡`\n\n####æ›å…‰é‡ï¼ˆphotometric exposureï¼‰\n\n![](/img/15000130641224/15026015278605.jpg)\nå…¶ä¸­  Hæ˜¯æ›å…‰é‡ï¼Œ Eæ˜¯å½±åƒå¹³é¢çš„ç…§åº¦ï¼Œè€Œ  tæ˜¯æ›å…‰æ—¶é—´ã€‚ç…§åº¦ Eç”±få€¼æ‰€æŽ§åˆ¶ï¼Œä½†ä¹Ÿå–å†³äºŽçŽ¯å¢ƒäº®åº¦ã€‚\n\n## å…‰åœˆä¸Žæ™¯æ·±\n\n##### æ™¯æ·±\n\n![](/img/15000130641224/15026018990936.jpg)\n\n![](/img/15000130641224/15026016717518.jpg)\n\n![](/img/15000130641224/15026016975426.jpg)\n\nå…‰åœˆç³»æ•°= `é•œå¤´ç„¦è·/å…‰åœˆå­”å¾„`ï¼›å¸¸ç”¨çš„é•œå¤´çš„å…‰åœˆæ•°åºåˆ—ä¸º\n`1ï¼Œ 1.4ï¼Œ 2ï¼Œ 2.8ï¼Œ 4ï¼Œ 5.6ï¼Œ 8ï¼Œ 11ï¼Œ 16ï¼Œ 22ï¼Œ 32ï¼Œ 45ï¼Œ 64ï¼Œ90ï¼Œ128`\n\n\n\n\n","tags":["CV"]},{"title":"XMPP(3):Roster&è”ç³»äºº","url":"/2019/03/31/Roster-è”ç³»äºº/","content":"\n\n\n\nXMPPä¸­è”ç³»äººæ¨¡å—åè®®æ˜¯`jabber:iq:roster`. Rosterç›´æŽ¥ç¿»è¯‘å«èŠ±åå†Œï¼Œå…¶å®žå®ƒå°±æ˜¯è”ç³»äººåˆ—è¡¨å•¦ã€‚\n\n## å®¢æˆ·ç«¯èŽ·å–è”ç³»äººåˆ—è¡¨\n\næ¯”è¾ƒç®€å•ï¼Œå‘é€IQ stanzaç»™server. xmlns=`jabber:iq:roster`;type='get'\n\n```xml\n\n<iq from='user@server.com/balcony'\n       id='bv1bs71f'\n       type='get'>\n    <query xmlns='jabber:iq:roster'/>\n  </iq>\n\n```\nè¿”å›žç»“æžœçš„itemä¸­æœ‰è”ç³»äººJid\n\n```xml\n<iq id='bv1bs71f'\n       to='user@server.com/balcony'\n       type='result'>\n    <query xmlns='jabber:iq:roster' ver='ver7'>\n      <item jid='contact1@server.com'/>\n      <item jid='contact2@server.com'/>\n    </query>\n  </iq>\n\n```\n\n## æ·»åŠ è”ç³»äºº(åŠ å¥½å‹ï¼‰çš„æµç¨‹ \n\næ–¹æ³•æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§ç”¨IQ set, è§[rfc6121](https://xmpp.org/rfcs/rfc6121.html#roster-add).\n\n1. å®¢æˆ·ç«¯è¯·æ±‚æ·»åŠ è”ç³»äºº\n\nxmlnsç”¨`jabber:iq:roster`; å¸¦ä¸Šæƒ³æ·»åŠ çš„ç”¨æˆ·jid. nameå¯ä»¥ä¸å¸¦; `group`åˆ†ç»„ç”¨ã€‚\n\n\n```xml\n<iq from='user@server.com/balcony' type='set' id='roster_2'>\n  <query xmlns='jabber:iq:roster'>\n    <item jid='contact@server.com'\n          name='contact'>\n      <group>Servants</group>\n    </item>\n  </query>\n</iq>\n```\n\n2.1. serveré€šçŸ¥åŒä¸€ä¸ªè´¦æˆ·å…³è”çš„æ‰€æœ‰å®¢æˆ·ç«¯: è”ç³»äººåˆ—è¡¨æ›´æ–°äº†ã€‚\n\n```xml\n\n<iq to='user@server.com/balcony'\n    type='set'\n    id='a78b4q6ha463'>\n  <query xmlns='jabber:iq:roster'>\n    <item jid='contact@server.com'\n          name='contact'\n          subscription='none'>\n      <group>Servants</group>\n    </item>\n  </query>\n</iq>\n\n<iq to='user@server.com/chamber'\n    type='set'\n    id='a78b4q6ha464'>\n  <query xmlns='jabber:iq:roster'>\n    <item jid='contact@server.com'\n          name='contact'\n          subscription='none'>\n      <group>Servants</group>\n    </item>\n  </query>\n</iq>\n```\n\nserverå›žå¤IQ stanzaç»™è¯·æ±‚æ·»åŠ è”ç³»äººçš„å®¢æˆ·ç«¯balcony\n```xml\n<iq to='user@server.com/balcony' type='result' id='roster_2'/>\n```\n\n\n##  åˆ é™¤è”ç³»äºº\n\nç»™serverå‘é€ä¸ªIQ setï¼Œ subscriptionä¸€å®šæ˜¯'remove'.\n\n```xml\n\n<iq from='user@server.com/balcony' type='set' id='roster_4'>\n  <query xmlns='jabber:iq:roster'>\n    <item jid='contact@server.com' subscription='remove'/>\n  </query>\n</iq>\n\n```\n\n## Presence\n\nå¢žåˆ è”ç³»äººçš„å¦ä¸€ç§æ–¹æ³•æ˜¯Presenceè®¢é˜…æœºåˆ¶.Presence stanzaå…¶å®žæœ‰ä¸¤ç§åŠŸèƒ½ï¼š\n- å¹¿æ’­online/offlineçŠ¶æ€, [ä¹‹å‰æ–‡ç« ](https://suelan.github.io/2019/03/26/XMPP-Overview/#The-Presence-Stanza)æè¿‡\n- æŽ§åˆ¶è”ç³»äººè®¢é˜…. å°±æ˜¯å¢žåˆ å¥½å‹åŠŸèƒ½å’¯\n\næˆ‘ä»¬ç”¨typeæ¥åŒºåˆ†è¿™ä¸¤ç§åŠŸèƒ½ã€‚typeæ˜¯`available| unavailable`ï¼Œ presence stanzaè¡¨è¾¾online/offlineçŠ¶æ€ã€‚typeè‹¥æ˜¯`subscribe | subscribed | unsubscribe| unsubscribed`ï¼Œå°±è·Ÿè”ç³»äººæœ‰å…³å•¦ã€‚\n\n\nsubscribtionæœ‰å››ç§çŠ¶æ€ï¼š\n- NONE :  \n- TO  :  userè®¢é˜…contactçš„çŠ¶æ€\n- FROM : contactè¢«userè®¢é˜…\n- BOTH : userè·Ÿcontactç›¸äº’subcribe\n\n![flow](https://www.blikoontech.com/wp-content/uploads/2018/03/XMPP_Subscription_Flow.png)\n\nå¦‚ä¸Šå›¾ï¼šä¸€å¼€å§‹userè·Ÿcontactæ²¡å•¥å…³ç³»ï¼ŒsubscriptionçŠ¶æ€éƒ½æ˜¯noneã€‚ æŽ¥ç€userå‘é€äº†ä¸€æ¡Presence stanzaç»™contactï¼Œæƒ³subscribeä»–çš„çŠ¶æ€ã€‚å¦‚ä¸‹ï¼š\n```xml\n// from user\n<presence to='contact@server.com' type='subscribe'/>\n```\nçŽ°åœ¨userç”¨`jabber:iq:roster` æŸ¥è¯¢æ‰€æœ‰è”ç³»äººçš„æ—¶å€™ï¼Œä¼šå‘çŽ°itemå¤šäº†ä¸€æ¡, contactè¿˜æ²¡ç¡®è®¤, æ‰€ä»¥ ask='subscribe', subscribtion='none'\n\n```xml\n// user's roster\n<item ask='subscribe' subscription='none' jid='contact@server.com'/>\n```\nserverè¦å°†æ¶ˆæ¯è½¬å‘ç»™contactå®¢æˆ·ç«¯, contactç™»å½•æ—¶ï¼Œä¼šæ”¶åˆ°ä¸€æ¡æ¥è‡ªuserçš„presence stanza; typeæ˜¯'subscribe'ã€‚ æˆ‘ä»¬å¯ä»¥ç”¨è¿™æ¡æ¶ˆæ¯æ¥åšâ€œæ”¶åˆ°æ¥è‡ªuseræ·»åŠ å¥½å‹çš„è¯·æ±‚â€è¿™æ ·çš„åŠŸèƒ½\n```xml\n<presence from='user@server.com' to='contact@server.com' type='subscribe' xmlns='jabber:client'></presence>\n```\n\nåŒæ—¶contact/devè®¾å¤‡ä¼šæ”¶åˆ°Rosteræ›´æ–°çš„ä¿¡æ¯. \n```xml\n<iq  from='contact@server.com' to='contact@server.com/dev' id='13a99ca5' type='result' xmlns='jabber:client'>\n    <query  xmlns='jabber:iq:roster'>\n         <item  ask='subscribe' subscription='none' jid='user@server.com'/>\n       </query>\n</iq>\n```\n#### æŽ¥å—è¯·æ±‚\nå¦‚æžœcontactæŽ¥å—è¯·æ±‚ï¼Œä»–è¦å‘é€ä¸€æ¡presenceç»™user. typeå€¼æ˜¯'subscribed'\n\n```xml\n<presence to='user@server.com' type='subscribed'/>\n```\n\nuserè¿™è¾¹çš„rosterä¼šæ›´æ–°\n```xml\n// user's roster\n<item subscription='to' jid='contact@server.com'/>\n```\nè¿™æ—¶åœ¨contactçš„rosteråˆ—è¡¨é‡Œï¼Œuserçš„subscriptionæ˜¯fromã€‚ ```xml\n// contact's roster\n<item ask='subscribe' subscription='from' jid='user@server.com'/>\n```\n\næŽ¥ç€contactä¹Ÿè¯·æ±‚è®¢é˜…user \n\n```xml\n<iq from='user@server.com/balcony' type='set' id='roster_2'>\n  <query xmlns='jabber:iq:roster'>\n    <item jid='contact@server.com'\n          name='contact'>\n      <group>Servants</group>\n    </item>\n  </query>\n</iq>\n```\n\nContactåŒæ ·æµç¨‹åŽï¼Œä»–ä¸¤çš„subscriptionéƒ½å˜æˆäº†bothã€‚\n\n#### æ‹’ç»\nå¦‚æžœcontactæƒ³æ‹’ç»userçš„è¯·æ±‚ï¼Œä¹Ÿæ˜¯å‘é€presence \n```xml\n<presence to='user@server.com' type='unsubscribed'/>\n```\nå¦‚æžœuseræƒ³å–æ¶ˆå¯¹contactçš„è®¢é˜…, å‘é€presence stanzaï¼Œtype æ˜¯unsubscribed\n```xml\n<presence to='contact@server.com' type='unsubscribed'/>\n```\n\n\nref: https://xmpp.org/rfcs/rfc3921.html#roster","categories":["XMPP"]},{"title":"XMPP(2):æ³¨å†Œè´¦æˆ·","url":"/2019/03/29/XMPP-2-æ³¨å†Œè´¦æˆ·/","content":"\n\n\n## XMPPæ³¨å†Œæµç¨‹\n\n\n#### 1. clientå‘é€æ¶ˆæ¯ä½“, åŽ»æœåŠ¡ç«¯æŸ¥è¯¢æ³¨å†Œéœ€è¦çš„å­—æ®µ\n\n\n```xml\n<iq type='get' id='reg1' to='localhost'>\n  <query xmlns='jabber:iq:register'/>\n</iq>\n```\n\nxmlnsæ˜¯ `jabber:iq:register`, typeæ˜¯`get`\n\n#### 2.1. æœªæ³¨å†Œï¼šè¿”å›žæ³¨å†Œéœ€è¦çš„å­—æ®µ\n\n```xml\n<iq type='result' id='reg1'>\n  <query xmlns='jabber:iq:register'>\n    <instructions>\n      Choose a username and password for use with this service.\n      Please also provide your email address.\n    </instructions>\n    <username/>\n    <password/>\n    <email/>\n  </query>\n</iq>\n```\n\n`<instructions/>` elementï¼šSHOULD contain an <instructions/> element (whose XML character data MAY be modified to reflect the fact that the entity is currently registered)\n\n#### 2.2. å·²æ³¨å†Œï¼šæœåŠ¡ç«¯çš„è¿”å›žç»“æžœ\n\n```xml\n<iq  xmlns='jabber:client' xml:lang='en' to='olivia@localhost/180244803852118156522754' from='localhost' type='result' id='reg1'>\n    <query  xmlns='jabber:iq:register'>\n        <username>olivia</username>\n        <registered/>\n        <password/>\n        <instructions>Choose a username and password to register with this server</instructions>\n    </query>\n</iq>\n```\n\nhostä¼šæ ¹æ®\"from\"çš„åœ°å€åˆ¤æ–­entityæ˜¯å¦å·²ç»æ³¨å†Œäº†ï¼ŒIQ resultæ¶ˆæ¯æœ‰ä¸€ä¸ªç©ºçš„`<registered/>`ï¼Œ æ ‡ç¤ºè¯¥entiryå·²ç»æ³¨å†Œè¿‡äº†ã€‚\n\n#### 3.client æ³¨å†Œ \n\niq stanzaçš„typeæ˜¯`set`, xmlns`jabber:iq:register`\n\n```xml\n<iq type='set' id='reg2'>\n  <query xmlns='jabber:iq:register'>\n    <username>bill</username>\n    <password>Calliope</password>\n    <email>bard@shakespeare.lit</email>\n  </query>\n</iq>\n```\n\n#### 4.1 æ³¨å†ŒæˆåŠŸ \n\n```xml\n<iq type='result' id='reg2'/>\n\n```\n\n#### 4.2 æ³¨å†Œå¤±è´¥ï¼Œå‘½åå†²çª\n\n```xml\n<iq type='error' id='reg2'>\n  <query xmlns='jabber:iq:register'>\n    <username>bill</username>\n    <password>m1cro$oft</password>\n    <email>billg@bigcompany.com</email>\n  </query>\n  <error code='409' type='cancel'>\n    <conflict xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n```\n\n#### 4.3 æ¶ˆæ¯ä¸å…¨ ` <not-acceptable/> `\n\n```xml\n<iq type='error' id='reg2'>\n  <query xmlns='jabber:iq:register'>\n    <username>bill</username>\n    <password>Calliope</password>\n  </query>\n  <error code='406' type='modify'>\n    <not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n```\n\n#### 4.4 æœåŠ¡ç«¯è®¿é—®æƒé™é—®é¢˜\n\n```xml\n<iq  xmlns='jabber:client' xml:lang='en' to='olivia@localhost/180244803852118156522754' from='olivia@localhost' type='error' id='reg2'>\n    <query  xmlns='jabber:iq:register'>\n        <email>bard@shakespeare.lit</email>\n        <username>bill</username>\n        <password>Calliope</password>\n    </query>\n    <error  code='403' type='auth'>\n        <forbidden  xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n        <text  xmlns='urn:ietf:params:xml:ns:xmpp-stanzas' xml:lang='en'>Access denied by service policy</text>\n    </error>\n</iq>\n```\n\n#### 5.å¦‚æžœç”¨ç¬¬ä¸‰æ–¹æ³¨å†Œçš„æ–¹å¼ï¼Œå¯èƒ½éœ€è¦è¡¥å……ä¸€äº›é¢å¤–çš„ä¿¡æ¯\n\nå®¢æˆ·ç«¯æŸ¥è¯¢\n\n```xml\n<iq type='get'\n    from='juliet@capulet.com/balcony'\n    to='contests.shakespeare.lit'\n    id='reg3'>\n  <query xmlns='jabber:iq:register'/>\n</iq>\n```\n\n#### 6.æœåŠ¡ç«¯è¿”å›žæ¶ˆæ¯ï¼Œ æç¤ºéœ€è¦æä¾›çš„ä¿¡æ¯\n\n```xml\n<iq type='result'\n    from='contests.shakespeare.lit'\n    to='juliet@capulet.com/balcony'\n    id='reg3'>\n  <query xmlns='jabber:iq:register'>\n    <instructions>\n      Use the enclosed form to register. If your Jabber client does not\n      support Data Forms, visit http://www.shakespeare.lit/contests.php\n    </instructions>\n    <x xmlns='jabber:x:data' type='form'>\n      <title>Contest Registration</title>\n      <instructions>\n        Please provide the following information\n        to sign up for our special contests!\n      </instructions>\n      <field type='hidden' var='FORM_TYPE'>\n        <value>jabber:iq:register</value>\n      </field>\n      <field type='text-single' label='Given Name' var='first'>\n        <required/>\n      </field>\n      <field type='text-single' label='Family Name' var='last'>\n        <required/>\n      </field>\n      <field type='text-single' label='Email Address' var='email'>\n        <required/>\n      </field>\n      <field type='list-single' label='Gender' var='x-gender'>\n        <option label='Male'><value>M</value></option>\n        <option label='Female'><value>F</value></option>\n      </field>\n    </x>\n  </query>\n</iq>\n```\n\n#### 7.å®¢æˆ·ç«¯æä¾›ä¿¡æ¯\n\n```xml\n<iq type='set'\n    from='juliet@capulet.com/balcony'\n    to='contests.shakespeare.lit'\n    id='reg4'>\n  <query xmlns='jabber:iq:register'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field type='hidden' var='FORM_TYPE'>\n        <value>jabber:iq:register</value>\n      </field>\n      <field type='text-single' label='Given Name' var='first'>\n        <value>Juliet</value>\n      </field>\n      <field type='text-single' label='Family Name' var='last'>\n        <value>Capulet</value>\n      </field>\n      <field type='text-single' label='Email Address' var='email'>\n        <value>juliet@capulet.com</value>\n      </field>\n      <field type='list-single' label='Gender' var='x-gender'>\n        <value>F</value>\n      </field>\n    </x>\n  </query>\n</iq>\n```\n\n## Cancellation of Existing Registration\n\n#### 1. cilent req: \n```xml\n<iq type='set' from='bill@shakespeare.lit/globe' id='unreg1'>\n  <query xmlns='jabber:iq:register'>\n    <remove/>\n  </query>\n</iq>\n```\nè·Ÿæ³¨å†Œä¸åŒçš„æ˜¯ `query` çš„childå¤šäº†ä¸ª`<remove/>`\n\n#### 2.1. æˆåŠŸæ³¨é”€,server response: \n  \n```xml\n\n<iq type='result' to='bill@shakespeare.lit/globe' id='unreg1'/>\n\n```\n\n#### 2.2.Error Case  \n\n|Condition | Description  |\n| --- | --- |\n| ``<bad-request/>``|\tThe <remove/> element was not the only child element of the <query/> element.|\n|``<forbidden/>``\t| æƒé™ä¸å¤Ÿ|\n|``<not-allowed/>``\t|ä¸å…è®¸ç”¨æˆ·æ³¨é”€è´¦æˆ·|\n|``<registration-required/>``|è¦æ³¨é”€çš„è´¦æˆ·æœ¬æ¥å°±ä¸å­˜åœ¨|\n|``<unexpected-request/>``\t| The host is an instant messaging server and the IQ get does not contain a 'from' address because the entity is not registered with the server.|\n\n## ç”¨æˆ·ä¿®æ”¹å¯†ç \n\n#### 1. Client:\n```xml\n<iq type='set' to='shakespeare.lit' id='change1'>\n  <query xmlns='jabber:iq:register'>\n    <username>bill</username>\n    <password>newpass</password>\n  </query>\n</iq>\n\n```\n\nè¿™é‡Œçš„å¯†ç æ˜¯æ˜Žæ–‡ï¼Œ è¦ç•™æ„å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šä¿¡æ˜¯å¦ç”¨SSLæˆ–è€…TLSåŠ å¯†ï¼Œè€Œä¸”æœåŠ¡ç«¯è¯ä¹¦å¯ä¿¡ã€‚\n\n#### 2.1. æˆåŠŸ, Server: \n\n```xml\n<iq type='result' id='change1'/>\n\n```\n\n\n#### 2.2. å¤±è´¥ Case \n\n\n|Condition | Description  |\n| --- | --- |\n| ``<bad-request/>``| requestè¯·æ±‚ä½“æ‹¼å†™æœ‰é—®é¢˜ï¼Œæ¯”å¦‚æ²¡å¸¦username |\n|``<not-authorized/>`` | æ²¡é€šè¿‡serverçš„å®‰å…¨éªŒè¯ |\n|``<not-allowed/>`` |\tserver ä¸å…è®¸|\n|``<unexpected-request/>`` | The host is an instant messaging server and the IQ set does not contain a 'from' address because the entity is not registered with the server. |\n\næ¯”å¦‚ï¼š\n```xml\n// Bad  request\n<iq type='error' from='shakespeare.lit' to='bill@shakespeare.lit/globe' id='change1'>\n  <error code='400' type='modify'>\n    <bad-request xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n\n// Not Authorized\n<iq type='error' from='shakespeare.lit' to='bill@shakespeare.lit/globe' id='change1'>\n  <error code='401' type='modify'>\n    <not-authorized xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n\n// Not Allowed\n<iq type='error' from='shakespeare.lit' to='bill@shakespeare.lit/globe' id='change1'>\n  <error code='405' type='cancel'>\n    <not-allowed xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n```\n\næœ‰æ—¶å€™ï¼ŒæœåŠ¡ç«¯éœ€è¦æ›´å¤šçš„ä¿¡æ¯æ¥æ”¹å¯†ç ï¼Œè¿™æ—¶å€™å®ƒä¼šè¿”å›žä¿¡æ¯æç¤ºå®¢æˆ·ç«¯\n\n```xml\n<iq type='error' from='shakespeare.lit' to='bill@shakespeare.lit/globe' id='change1'>\n  <query xmlns='jabber:iq:register'>\n    <x xmlns='jabber:x:data' type='form'>\n      <title>Password Change</title>\n      <instructions>Use this form to change your password.</instructions>\n      <field type='hidden' var='FORM_TYPE'>\n        <value>jabber:iq:register:changepassword</value>\n      </field>\n      <field type='text-single' label='Username' var='username'>\n        <required/>\n      </field>\n      <field type='text-private' label='Old Password' var='old_password'>\n        <required/>\n      </field>\n      <field type='text-private' label='New Password' var='password'>\n        <required/>\n      </field>\n      <field type='text-single' label='Mother&apos;s Maiden Name' var='x-mmn'>\n        <required/>\n      </field>\n    </x>\n  </query>\n  <error code='401' type='modify'>\n    <not-authorized xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>\n  </error>\n</iq>\n\n```\n\nç„¶åŽå®¢æˆ·ç«¯è¿”å›žç›¸å…³ä¿¡æ¯\n\n```xml\n<iq type='set' from='bill@shakespeare.lit/globe' to='shakespeare.lit' id='change2'>\n  <query xmlns='jabber:iq:register'>\n    <x xmlns='jabber:x:data' type='submit'>\n      <field type='hidden' var='FORM_TYPE'>\n        <value>jabber:iq:register:changepassword</value>\n      </field>\n      <field type='text-single' var='username'>\n        <value>bill@shakespeare.lit</value>\n      </field>\n      <field type='text-private' var='old_password'>\n        <value>theglobe</value>\n      </field>\n      <field type='text-private' var='password'>\n        <value>groundlings</value>\n      </field>\n      <field type='text-single' var='x-mmn'>\n        <value>Throckmorton</value>\n      </field>\n    </x>\n  </query>\n</iq>\n```\n\nref: [XEP-0077: In-Band Registration](https://xmpp.org/extensions/xep-0077.html#usecases)\n","categories":["XMPP"]},{"title":"XMPP Overview","url":"/2019/03/26/XMPP-Overview/","content":"\n\n\nè·Ÿæœ‹å‹åšä¸€ä¸ªé¡¹ç›®ï¼Œæƒ³å¿«é€Ÿå¼€å‘ï¼Œé€‰äº†XMPPåè®®ã€‚å®ƒæ˜¯ä¸€å¥—é€šä¿¡åè®®ã€‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ[XMPP Core Services](https://xmpp.org/rfcs/rfc6121.html#A%20Sample%20Session) å’Œ XMPP Extension Protocols. æ ¸å¿ƒç”±åŸºç¡€featureç»„æˆï¼Œæ‰©å±•åè®®å°±éžå¸¸ä¸°å¯Œï¼Œè€Œä¸”ä¸€ç›´åœ¨å‘å±•ã€‚Wikiä¸Šæœ‰å¼ å„ç§IMåè®®çš„æ±‡æ€»è¡¨ï¼ŒæŽ¨èï¼\n\n- [Comparison of instant messaging protocols - Wikipedia](https://en.wikipedia.org/wiki/Comparison_of_instant_messaging_protocols)\n\n\n## XMPP Addressing \n\nè¿™æ˜¯ä¸€å¼ Client-Serverçš„å›¾ï¼Œå›¾é‡Œçš„serverã€clientéƒ½éµå¾ªXMPPåè®®ã€‚å« XMPP entity. å®ƒä»¬æœ‰å„è‡ªå”¯ä¸€çš„Address, æ ¼å¼å¦‚'username@server.com', å« JID (Jaber ID)\n [RFC 7622 - Extensible Messaging and Presence Protocol (XMPP): Address Format](https://datatracker.ietf.org/doc/rfc7622/)\n \n ![28a215f7.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/28a215f7.png)\n \nå…¶ä¸­resourceæ˜¯æ‹¿æ¥åšåŒä¸€è´¦å·å¤šå®¢æˆ·ç«¯æ ‡è®°çš„ï¼Œ æ¯”å¦‚å›¾ä¸­`User1` ä»Ž pc ,phone1 å’Œ phone2ç™»å½•åŒä¸€è´¦å·ï¼Œresourceåˆ†åˆ«æ˜¯ `pc`, `iphone1`,`iphone2`\n \n \n ## XMPP Client- Server Streams\n \n å®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯é€šè¿‡é•¿é“¾æŽ¥æ–¹å¼é€šä¿¡ï¼ŒçŽ°åœ¨å¤šç”¨WebSocketã€‚å½“å®¢æˆ·ç«¯è·ŸæœåŠ¡ç«¯æ¡æ‰‹æˆåŠŸï¼Œå®ƒä»¬å¼€å§‹ç”¨ XML streamé€šä¿¡ã€‚\n \n ![f1565a2e.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/f1565a2e.png)\\\n\n \nXML stream æ€»æ˜¯ä»¥  ``<stream>`` å¼€å¤´ï¼Œ ``</stream>`` tagç»“å°¾ã€‚æ˜¯xmlæ¶ˆæ¯çš„å®¹å™¨ã€‚\n\n```\nAn XML stream is a container for the exchange of XML elements between any two entities over a network. \nDuring the life of the stream, the entity that initiated it can send an unbounded number of XML elements over the stream, either elements used to negotiate the stream (e.g., to complete TLS negotiation or SASL negotiation) or XML stanzas. \n```\n\nä¸‹é¢æ˜¯clientè·Ÿserverçš„ä¸€æ¬¡æ¶ˆæ¯äº¤äº’ï¼Œ ç»¿è‰²æ¥è‡ªclientçš„ï¼Œé»‘è‰²æ¶ˆæ¯æ¥è‡ªserver\n\n \n  ![f97e583b.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/65d38868.png)\n\n ### XML stanza\n An XML stanza is the basic unit of meaning in XMPP. A stanza is a first-level element (at depth=1 of the stream) whose element name is \"message\", \"presence\", or \"iq\" and whose qualifying namespace is 'jabber:client' or 'jabber:server'. \n \n \n ### XMPP Communication Primitives\n\nA `stanza` is the smallest piece of XML data a client can send to a server ( server send to client) in one package.\n\nxmppä¸­ï¼ŒæœåŠ¡ç«¯ã€å®¢æˆ·æ•°æ®äº¤æ¢æ—¶ï¼Œæœ€å°XMLæ•°æ®å•ä½ å« stanzaã€‚å¦‚ä¸Šå›¾ï¼Œç»¿è‰²çš„å°±æ˜¯ä¸€ä¸ªstanzaï¼Œé»‘è‰²çš„ä¹Ÿæ˜¯ä¸€ä¸ªstanzaã€‚Stanzaæœ‰å‡ ç§ç±»åž‹: `message`, `iq`, `presence`ã€‚ \n\n#### The Message Stanza\n\nThe <message/> stanza is meant to be used to send data between XMPP entities.\n\n![6fe8a15e.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/6fe8a15e.png)\n\n - fromï¼šå‘é€æ–¹\n - toï¼š æŽ¥æ”¶æ–¹\n - body: æ¶ˆæ¯å†…å®¹\n - type æœ‰å‡ ç§ç±»åž‹:\n     -`<message type=â€chatâ€/>` ( chat message stanza) \n     - `< message type=â€groupchatâ€/>` ( groupchat message stanza)\n     - `< message type=â€errorâ€/>` (error message stanza)\n\n#### The Presence Stanza\n\nç”¨æ¥è¡¨ç¤ºåœ¨çº¿çŠ¶æ€çš„\n \n\n![0fbe995b.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/0fbe995b.png)\n\n`show` æ ‡ç­¾é‡Œå¯èƒ½ä¼šæœ‰çš„å‡ ç§çŠ¶æ€: \n`chat` : online and available for chat ; \n`away` : æš‚æ—¶ç¦»å¼€\n`xa` : é•¿æ—¶é—´ç¦»å¼€\n`dnd`: è¯·å‹¿æ‰“æ‰°\n\nå¦‚æžœä½ æƒ³çŸ¥é“åˆ«çš„çŠ¶æ€ï¼Œéœ€è¦å…ˆå‘æ¶ˆæ¯ç»™Serverï¼Œsubscribeåˆ«äººã€‚ \n\n\n#### The IQ stanza\n \n The IQ( Info/Query) stanza is used to get some information from the server ( info about the server or its registered clients) or to apply some settings to the server.\n \n ç”¨æ¥èŽ·å–æ¶ˆæ¯ï¼Œæˆ–è€…è¯·æ±‚è®¾ç½®\n  \nTypeå±žæ€§ä¸­çš„ç±»åž‹ :get ,set ,result or error. \n- `< iq type=â€getâ€/>` stanzas are used to get(ask) some information ( from the server). \n- `<iq type=â€setâ€/>` stanzas are used to apply some settings to the server.When you send get/set IQ stanzas to the server ,\n- it can reply either with an `< iq type=â€resultâ€/>` stanza when your request has been successfully processed by the server or \n- `<iq type=â€errorâ€/>` stanza when something has gone wrong with your request.The figure below shows an IQ stanza that we send to the server and the reply we get from the server.\n\n\n![30c96f66.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/30c96f66.png)\n\n\nThe client sends an IQ get stanza to the server to request its contact list.We know it is asking for the contact list because of the `jabber:iq:roster` XML namespace.\n\nThe XMPP engine in the server is programmed to know that when a client sends `jabber:iq:roster` namespaced IQ ,it wants to retrieve its contact list.There are other `namespaces` in XMPP for other uses and you will surely come accross them in your XMPPing journey.\n\nThe server responds with a list of the JIDâ€™s contacts wraped within a `jabber:iq:roster` namespaced `<query/>`tag.\n\n\n## æœ¬åœ°æ­å»º Server \n\næˆ‘æ­çš„æ˜¯ejabberd. å®˜æ–¹å®‰è£…æ•™ç¨‹: [Installing ejabberd \\| ejabberd Docs](https://docs.ejabberd.im/admin/installation/#install-on-macos)\n\n#### å¯åŠ¨æœåŠ¡\n\n```\ncd /Applications/ejabberd-19.02\n//å¼€å¯æœåŠ¡\n./bin/ejabberdctl start  \n//çŠ¶æ€\n./bin/ejabberdctl status  \n\n// help æŸ¥çœ‹æ›´å¤šåŠŸèƒ½å“¦\n./bin/ejabberdctl help \n```\n\n#### æ³¨å†Œè´¦æˆ·\n\næ‰“å¼€ [admin é¡µé¢](http://localhost:5280/admin/), è™šæ‹Ÿä¸»æœº -> localhost(å¯èƒ½ä½ çš„åå­—ä¸ä¸€æ ·) -> ç”¨æˆ·ã€‚ çŽ°åœ¨ä½ å¯ä»¥è‡ªå·±åˆ›å»ºè´¦æˆ·äº†ã€‚\n\n![578b88b6.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/578b88b6.png)\n\n\nå¦‚æžœæœ‰è‡ªå®šä¹‰éœ€æ±‚,é…ç½®æ•™ç¨‹ [Configuring ejabberd \\| ejabberd Docs](https://docs.ejabberd.im/admin/configuration/#mod-http-ws) \n \n#### å®¢æˆ·ç«¯çŽ©èµ·æ¥\n\nå®¢æˆ·ç«¯æœ‰å¾ˆå¤š[é€‰æ‹©](https://xmpp.org/software/clients.html)ï¼Œä¸è¿‡å¤§å¤šæ•°éƒ½æ˜¯æ¸£ã€‚å¦‚æžœæ˜¯WebSocketï¼Œç”¨è¿™ä¸ª [GitHub - processone/xmpp-websocket-client: Test XMPP Websocket client](https://github.com/processone/xmpp-websocket-client) è°ƒè¯•å¯ä»¥çœ‹åˆ°stanzaï¼ŒæŒºæ–¹ä¾¿çš„ã€‚\n\nå¦‚æžœMacç”¨æˆ·æŠ¥authé—®é¢˜ï¼Œå¯ä»¥æ‰“å¼€`vim conf/ejabberd.yml`, `tls`é…ç½®æˆ`false`\n![5202ee46.png](/img/32c16f22-9862-45e8-b15f-1b1eceb7b30f/5202ee46.png)\n\n#### å…³äºŽjs lib\næ‰“ç®—ç”¨React Nativeå†™ï¼Œlibé€‰äº† [GitHub - xmppjs/xmpp.js: XMPP for JavaScript](https://github.com/xmppjs/xmpp.js) ã€‚å½“ç„¶ Webå¤šç”¨æ¡†æž¶ Strophe.jsã€‚è¿™å„¿æœ‰ä¸ªç®€å•æ¯”è¾ƒ[How do you compare to strophe.js Â· Issue #217 Â· xmppjs/xmpp.js Â· GitHub](https://github.com/xmppjs/xmpp.js/issues/217)\n\n### å…¶ä»–èµ„æ–™\n\n- ç®€å•ä»‹ç» [A friendly introduction to XMPP â€“ blikoon](https://www.blikoontech.com/xmpp/xmpp-a-soft-friendly-introduction)\n\n- å®˜æ–¹åè®®å¾ˆè¯¦ç»†ï¼Œä¾‹å­ä¹Ÿå¾ˆå½¢è±¡ã€‚ [Extensible Messaging and Presence Protocol (XMPP): Core](https://xmpp.org/rfcs/rfc6120.html#tls)\n\n- å¦‚ä½•é€‰æ‹©å³æ—¶é€šè®¯åº”ç”¨çš„æ•°æ®ä¼ è¾“æ ¼å¼ [å¦‚ä½•é€‰æ‹©å³æ—¶é€šè®¯åº”ç”¨çš„æ•°æ®ä¼ è¾“æ ¼å¼-å…¶å®ƒåˆ†äº«/ä¸“é¡¹æŠ€æœ¯åŒº - å³æ—¶é€šè®¯å¼€å‘è€…ç¤¾åŒº!](http://www.52im.net/thread-276-1-1.html)\n- å¼ºåˆ—å»ºè®®å°†Protobufä½œä¸ºä½ çš„å³æ—¶é€šè®¯åº”ç”¨æ•°æ®ä¼ è¾“æ ¼å¼ [å¼ºåˆ—å»ºè®®å°†Protobufä½œä¸ºä½ çš„å³æ—¶é€šè®¯åº”ç”¨æ•°æ®ä¼ è¾“æ ¼å¼-å…¶å®ƒåˆ†äº«/ä¸“é¡¹æŠ€æœ¯åŒº - å³æ—¶é€šè®¯å¼€å‘è€…ç¤¾åŒº!](http://www.52im.net/thread-277-1-1.html) \n\n\n\n\n","categories":["Network"]}]